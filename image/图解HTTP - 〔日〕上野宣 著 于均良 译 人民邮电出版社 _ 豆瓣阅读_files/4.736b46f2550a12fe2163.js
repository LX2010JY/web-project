webpackJsonp([4],Array(74).concat([function(t,e,i){var n,o;n=[i(6),i(2),i(3),i(21),i(22),i(88),i(30),i(89),i(35),i(32),i(75),i(91),i(93),i(116),i(216),i(220),i(237),i(239),i(241)],o=function($,t,_,e,i,n,o,r,s,a,l,h,c,d,u,p,f,g,m){var v=t.View.extend({el:"#ark-reader",initialize:function(){_.bindAll(this,"freezeCanvas","unfreezeCanvas","freezeControl","unfreezeControl","scrollPage","changeLayout","renderGuide","renderPanel"),this.app=i,this.vent=this.app.vent,this.config=i.getModel("config");var t=new r;i.setModel("turning",t),t.disableSet(),t.on("change:isFirstPage",function(t,e){this.$el.toggleClass("first-page",e)},this).on("change:isLastPage",function(t,e){this.$el.toggleClass("last-page",e)},this),this.panel=new c({el:".aside",config:this.config}),this.article=new d(this.config),this.pagination=new u(this.config),this.controlsPanel=new p(this.config),this.article.on("article:init",function(){t.enableSet(),t.clear({silent:!0}),t.disableSet()}).on("article:init",_.bind(function(){this.article.once("pages:rendered:fully",function(){i.vent.trigger("pages:layout:finish"),i.vent.trigger("reader:layout:finish")})},this)),i.vent.once("reader:layout:finish",function(){_.defer(function(){i.vent.trigger("reader:ready")})}),l({ebook:{canvas:this,panel:this.panel,article:this.article,pagination:this.pagination,controlsPanel:this.controlsPanel,config:this.config}}),this.win=$(window),this.body=$("body"),this.bindKeyEvents(),this.bindWheelEvents(),this.docElement=$(document.documentElement),this.savingTimer=0,this.scrollContainer=this.body,this.vent.on({"freeze:canvas":this.freezeCanvas,"unfreeze:canvas":this.unfreezeCanvas,"freeze:control":this.freezeControl,"unfreeze:control":this.unfreezeControl,"scroll:page":this.scrollPage,"change:layout":this.changeLayout,"render:panel":this.renderPanel,"reader:ready":this.renderGuide}),this.listenTo(t,"change:currPage",function(){i.vent.trigger("close:popups"),this.pagination.updateProgressBar()}),f.bindAll(this)},renderThenOpenChapterList:function(t){var e=this;this.article.attachHooks({afterJumpingProgress:function(){e.controlsPanel.openChapterList()}}),this._render(t)},renderThenOpenRecommendation:function(t,e){i.getModel("config").set("ignoreGuide",!0);var n=new m.Recommendation(t,e);this.article.attachHooks(n),this._render(t)},renderThenShowUnderline:function(t,e){i.getModel("config").set("ignoreGuide",!0);var n=new m.Underline(e);this.article.attachHooks(n),this._render(t)},renderThenOpenAnnotation:function(t,e){i.getModel("config").set("ignoreGuide",!0);var n=new m.Annotation(t,e);this.article.attachHooks(n),this._render(t)},renderThenOpenParaAnnotations:function(t,e){i.getModel("config").set("ignoreGuide",!0);var n=new m.ParaAnnotations(e);this.article.attachHooks(n),this._render(t)},renderThenGotoChapter:function(t,e){i.router.cleanUrl();var n=new m.TocChapter(e);this.article.attachHooks(n),this._render(t)},render:function(t){this._render(t)},_render:function(t){return this.app.unsetModel("article"),this.app.unsetModel("content"),this.articleId=t,this.article.render(t),this.pagination.render(),this.controlsPanel.render(),a.fitForMobile||((new g).appendTo(this.$el),this.changeLayout()),this.trigger("view:rendered"),this},renderGuide:function(){this.config.get("ignoreGuide")||(this.config.get("isNewUser")?this.openHelperGuide():this.config.get("hasShownAnnotationGuide")||"c"===e.works.type||this.openAnnotationGuide())},openHelperGuide:function(){this.panel.toggleHelper(),this.config.set("isNewUser",!1)},openAnnotationGuide:function(){a.fitForMobile||(this.panel.openAnnotationGuideBubble(),this.config.set("hasShownAnnotationGuide",!0))},renderPanel:function(t){this.panel.render(t)},changeLayout:function(){var t=this.config.get("layout");this.body.scrollTop(0),this.$el.toggleClass("layout-vertical","vertical"===t),this.pagination.togglePagingBtns(t),this.pagination.updateProgressBar()},show:function(){return this.panel.show(),this.key.enable(),this.wheel.enable(),this.isShown?this:(this.docElement.addClass("reading-view"),/msie (8|9)/i.test(navigator.userAgent)&&(this.docElement.on("selectstart.unselectable",function(t){t.preventDefault()}),this.docElement.on("selectstart.unselectable",".content",function(t){t.stopPropagation()})),this.isShown=!0,this.$el.show(),this.vent.trigger("canvas:shown"),this)},hide:function(){if(this.panel.hide(),!this.isShown)return this;this.key.disable(),this.win.off("scroll"),this.win.off("resize"),this.docElement.removeClass("reading-view"),/msie (8|9)/i.test(navigator.userAgent)&&this.docElement.off(".unselectable"),this.controlsPanel.closeTips(),this.pagination.removeProgressBar(),this.$el.hide(),this.isShown=!1,$(".tips-outer").remove();try{s.set("previousAid",this.articleId)}catch(t){}return this.vent.trigger("canvas:hidden"),this},scrollPage:_.throttle(function(t,e){e=e||300,this.scrollContainer.animate({scrollTop:t},e)},100),freezeControl:function(){this.key.disable(),this.wheel.disable()},unfreezeControl:function(){this.key.enable(),this.wheel.enable()},freezeCanvas:function(){this.freezeControl(),this.$el.after('<div id="freeze-canvas-mask">')},unfreezeCanvas:function(){this.unfreezeControl(),$("#freeze-canvas-mask").remove()},changeFullscreenStyle:function(){this.panel.toggle(),this.panel.hideBubble(),this.controlsPanel.closeTips()},bindWheelEvents:function(){var t=this;this.wheel=new h({disableElements:[".bubble",".tooltip",".tips-outer","#ark-overlay"]}),this.wheel.onWheelBottom(function(){var e=i.getModel("config").get("layout");"horizontal"===e&&t.pagination.pageNext.trigger("humanClick")}),this.wheel.onWheelTop(function(){var e=i.getModel("config").get("layout");"horizontal"===e&&t.pagination.pagePrev.trigger("humanClick")})},bindKeyEvents:function(){var t=this,e=this.config,o=16*e.get("lineHeight");this.key=n(),this.key.down(["j","right","space"],function(){var i=e.get("layout");if("horizontal"===i)t.pagination.pageNext.trigger("humanClick");else{var n=e.get("pageHeight"),r=n-2*o;t.scrollPage("+="+r+"px",100)}}).down(["k","left","shift+space"],function(){var i=e.get("layout");if("horizontal"===i)t.pagination.pagePrev.trigger("humanClick");else{var n=e.get("pageHeight"),r=n-3*o;t.scrollPage("-="+r+"px",100)}}).down(["down"],function(){}).down(["up"],function(){}).down("shift+g",function(){i.getModel("turning").turnLastPage()}).down("g->g",function(){i.getModel("turning").turnFirstPage()}).down("esc",function(){t.controlsPanel.closeTips(),t.controlsPanel.closePopups()}).down("shift+/",function(){t.panel.toggleHelper()}).down("/",function(e){e.preventDefault(),t.pagination.pagePortal.trigger("view:openPageForm")}).down(["meta+shift+f","f11"],function(){t.changeFullscreenStyle()}).down(["ctrl+a","meta+a"],function(t){return t.preventDefault(),!1})}});return v}.apply(e,n),!(void 0!==o&&(t.exports=o))},function(t,e,i){var n,o;n=[i(6),i(3),i(2),i(21),i(22),i(76),i(29),i(77),i(78),i(79),i(81),i(85)],o=function($,_,t,e,n,o,r,s,a,l,h,c){function d(){var t=document.createElement("div");t.style.width="1em",t.style.height="1em",t.style.position="absolute",t.style.left="-9999px",document.body.appendChild(t);var e=16!==t.clientWidth;return document.body.removeChild(t),e}function u(t){return Math.ceil(parseInt(t,10)/k)*k}function p(e){function u(){z.$el.on("drag",".inner",function(t){var e=t.originalEvent.gesture.interimDirection;E(e)}).on("drag",".inner",f),$(m).on("touchstart","#freeze-canvas-mask",function(t){t.preventDefault()}),z.$el.on("touchmove",function(t){"range"!==t.target.type&&"vertical"!==J.get("layout")&&t.preventDefault()})}function p(){r.isWeixin()&&i.e(5,function(t){var e=[t(86)];(function(){}).apply(null,e)}),z.$el.on("drag",".inner",g),j.remove(),O(),V.on("view:render",S),V.progressManager.on("progress:confirmed",function(){var t=X.get("currPage");L(t)}),n.vent.on("render:panel",function(){H=new h,z.$el.prepend(H.render().el)}).on("paging:start",A).on("paging:finish",function(){m.scrollTop=0}).on("canvas:shown",function(){g()}),z.on("view:rendered",N),X.on("change:currPage",function(t,e){L(e)}),U.on("list:render",B),U.$(".goto-app").on("click",function(){var t=n.getModel("config").get("isChapter"),e=t?n.getModel("column").get("id"):"";s({worksId:V.articleId,columnId:e})})}function f(){V.tinyTips&&V.tinyTips.destroy()}function g(){H&&H.hide(),G.hide()}function T(){H&&H.toggle(),G.toggle()}function S(){w||(I(),J.set({pageWidth:v,pageHeight:J.get("pageHeight"),lineHeight:k}),r.hasOrientationEvent()&&$(window).on("orientationchange",function(){location.replace(location.href)}),w=1,F())}function A(t){var e=16*(v-3);t.posts.forEach(function(t){t.contents.forEach(function(t){"illus"===t.type&&a.resizeIllus(t,{maxWidth:e})})})}function I(){V.$el.css({height:y+"em"}).find(".inner").css({width:3*v+"em"}),V.lineHeight=16*k,V.pageHeight=16*C,new l({el:V.$el,asideControls:G})}function N(){if(!x){var t,e,i;i=J.get("isChapter")?U.chaptersTocView:U.tocView,e=i.$el,e.css({height:y+"em"}).appendTo(".article"),e.on("action:expand",function(){P&&P.refresh()}).on("tap",".close",function(){g(),U.switcher.hideAll()}).on("tap",".toc-item",function(){_.defer(g)}),q.$el.on(r.isApplePhone?"change":"release",".page-input",function(e){clearTimeout(t),t=setTimeout(function(){var t=0|$(e.currentTarget).val();X.setCurrPage(t)},200)}),q.formInput.replaceWith($("<input>",{"class":"page-input",type:"range",step:1,min:1})),x=1}}function E(t){if("vertical"!==J.get("layout")){var e={left:"pageNext",right:"pagePrev"};switch(t){case"left":case"right":W[e[t]].trigger("tap")}}}function D(t){"vertical"!==J.get("layout")&&W.pageTurning(t,{fromMobileTap:!0})}function F(){var t=U.$(".controls-ark-salon"),e=n.router.getReviewsUrl();e||t.hide(),t.find("a").attr("href",e)}function B(){var t=J.get("isChapter"),e=t?U.chaptersToc:U.toc,i=e.find(".hd"),n=e.find(".bd"),o=e.find(".ft"),r=i.innerHeight()+parseInt(i.css("padding-top"),10)+o.innerHeight();n.height(this.body.height()-r+"px"),n.length&&(P=new c(n[0],{click:!0,tap:!1}),e.on("collapse:expanded",function(){P.scrollToElement(".is-current")}))}function L(t){var e=X.get("totalPage");W.pageForm.show(),W.$el.find(".page-input").prop({max:e,value:t}),Y.html('.page-jump .page-input::-webkit-slider-thumb:after{content:"'+W.$el.find(".progress-num").text()+'"}')}function O(){if(!$("#page-style").length){var t="\t            .page { width: pageWidth; height: pageHeight }\t            .page .bd { height: contentHeight }\t            .page .hd, .page .ft { width: contentWidth }\t          ".replace("pageWidth",M.width).replace("pageHeight",M.height).replace("contentHeight",M.contentHeight).replace("contentWidth",M.width);$("<style>",{id:"page-style",text:t}).appendTo("head")}}if(r.hasTouch()){$('<style id="slider-thumb">').appendTo("head");var H,R=e.ebook,z=R.canvas,j=R.panel,V=R.article,W=R.pagination,U=R.controlsPanel,G=z.$(".aside-controls"),q=W.pagePortal,J=R.config,X=n.getModel("turning"),Y=$("#slider-thumb");n.mobileVent=_.extend({},t.Events),_.defer(function(){d()&&(o.isWechat?new o({text:"当前字体大小不是默认设置，可能使阅读器无法正常显示。点击右上角按钮，选择“调整字体”，可将字体调整为默认大小"}).openGuide():alert("当前字体大小不是默认设置，可能使阅读器无法正常显示。请尝试修改字体大小"))}),n.mobileVent.on("turnPage",D).on("hideToolbar",g).on("toggleToolbar",T),u(),b&&p()}}var f=document,g="dialog",m=f.body,v=m.clientWidth/16,y=(window.innerHeight||m.clientWidth)/16,b=r.fitForMobile(),w=0,x=0,P="",k=1.5,T=y-5,C=u(y-("bottom"===g?7:5)),M={width:v-3+"rem",contentHeight:C+"em",height:T+"em"};return p}.apply(e,n),!(void 0!==o&&(t.exports=o))},function(t,e,i){var n;(function($){"use strict";n=function(){function t(t){if(e){var n=$("#tmpl-wechat-guide").html();this.guide=$(n.replace("{{text}}",t.text)),t.selector&&i.on("click",t.selector,this.open.bind(this)),i.on("touchend click",".wechat-guide",this.close.bind(this))}}var e=/MicroMessenger/.test(navigator.userAgent),i=$(document),n=$(document.body);return $.extend(t.prototype,{open:function(t){t.preventDefault(),this.openGuide()},close:function(t){t.preventDefault(),this.closeGuide()},openGuide:function(){n.append(this.guide)},closeGuide:function(){this.guide.remove()}}),t.isWechat=e,t}.call(e,i,e,t),!(void 0!==n&&(t.exports=n))}).call(e,i(6))},function(t,e,i){var n,o;n=[i(3),i(6),i(28),i(30)],o=function(_,$,t,e){return function(i){i=i||{};var n,o,r={chapter:i.worksId,column:i.columnId};if(e.isApplePhone){var s=_.now();o="douban-read-iphone://",o+=i.columnId&&!i.worksId?"open-column":"read",n=t.addParam(o,i.columnId?r:{"package":i.worksId}),location.href=n,setTimeout(function(){_.now()-s<2e3&&(location.href="/intro/iphone")},1500)}else if(e.isAndroid){var a=$("#link-to-android-app");o="/intro/android",a.length||(a=$("<a>").hide(),$("body").append(a)),n=t.addParam(o,i.columnId?r:{ebook:i.worksId}),a.attr("href",n).click()}else alert("抱歉，未能识别当前系统，请自行打开豆瓣阅读应用")}}.apply(e,n),!(void 0!==o&&(t.exports=o))},function(t,e,i){var n,o;n=[i(6),i(3)],o=function($,_){function t(t,n,o,r){return o/r>t/n?e.apply(this,arguments):i.apply(this,arguments)}function e(t,e,i,n){return{height:n*t/i,width:t}}function i(t,e,i,n){return{height:e,width:i*e/n}}function n(e,i){i=i||{};var n=e.data,o=r(n.dimension,n.size),s=o.width,a=o.height,l=i.maxWidth||s,h=i.maxHeight||a;a<=h&&s<=l||_.extend(o,t(l,h,s,a))}function o(e,i){i=i||{};var n,o,r,s=e.find(".illus-outer img"),a=s.width()||+s.attr("width"),l=s.height()||+s.attr("height"),h=s.data("orig-width"),c=s.data("orig-height"),d=e.outerWidth(!0),u=e.outerHeight(!0),p=i.maxWidth||d,f=i.maxHeight||u,g=d-a,m=u-l;n=p-g,o=f-m,r=t(n,o,h,c),s.height(r.height).width(r.width)}function r(t,e){e.toJSON&&(e=e.get("data.size"));var i=a[t];return i=s(i,e),e[i]}function s(t,e){for(;!(t in e);){var i=_.indexOf(l,t);if(t=l[i+1],!t)return}return t}var a={H:"large",M:"small",S:"tiny"},l=["large","small","tiny","orig"];return{fitBox:t,resizeIllus:n,resizeIllusElem:o,getSize:r}}.apply(e,n),!(void 0!==o&&(t.exports=o))},function(t,e,i){var n,o;n=[i(6),i(3),i(2),i(22),i(80)],o=function($,_,t,e,i){function n(t,e){for(var i=t[0],n=t[1],o=!1,r=0,s=e.length-1;r<e.length;s=r++){var a=e[r][0],l=e[r][1],h=e[s][0],c=e[s][1],d=l>n!=c>n&&i<(h-a)*(n-l)/(c-l)+a;d&&(o=!o)}return o}var o=$(window).height(),r=$(window).width(),s=r/3,a=[[0,0],[0,o],[s,o],[s,0]],l=[[2*s,0],[2*s,o],[r,o],[r,0]],h=/^(sup|a|input|textarea|button)$/i;$("body");return t.View.extend({events:{"tap .page":"fasttap"},initialize:function(t){this.asideControls=t.asideControls,this.$el.on("tap",".page img",i.openImageView)},fasttap:function(t){var i=t.originalEvent.gesture.srcEvent;if(!(i.distance&&i.distance>15||i.ignoreTap||h.test(t.target.tagName)||$(t.target).is("img")||$(".tips-outer").is(":visible"))){if(this.asideControls.is(":visible"))return e.mobileVent.trigger("hideToolbar");var o=t.originalEvent.gesture.srcEvent,r=_.isUndefined(o.changedTouches)?[o]:o.changedTouches,s=r.length&&r[0],c=s.clientX,d=s.clientY,u=[c,d],p=!0;n(u,a)?e.mobileVent.trigger("turnPage",p):n(u,l)?e.mobileVent.trigger("turnPage",!p):e.mobileVent.trigger("toggleToolbar")}}})}.apply(e,n),!(void 0!==o&&(t.exports=o))},function(t,e,i){var n,o;n=[i(6),i(3),i(2),i(29),i(53)],o=function($,_,t,e,i){function n(t){this.imageSource=t.origImage;var e=r,i=t.origWidth/t.origHeight;this.imageWidth=Math.min(t.origWidth,e),this.imageHeight=this.imageWidth/i,this.doubleZoomOrg=1,this.el=document.createElement(this.tagName),this.$el=$(this.el),_.each(this.events,function(t,e){this.$el.on(e,this[t].bind(this))},this)}var o=window.innerHeight,r=Math.max(window.innerWidth,document.body.clientWidth),s=$("body"),a=$(document),l=_.memoize(function(){var t=document.createElement("div");return void 0!==t.style.webkitAnimation}),h=$.zepto?_.identity:function(t){return t.originalEvent};return _.extend(n.prototype,t.Events,{tagName:"img",events:{doubletap:"doubleTap",tap:"tap",touch:"touch",drag:"drag",release:"release"},getAspect:function(){return{width:this.imageWidth,height:this.imageHeight}},onLoaded:function(t){this.el.onload=t},render:function(){return this.$el.css(this.getAspect()).attr("src",this.imageSource),e.hasPinchZoom()&&this.$el.on("transform",_.bind(this.pinch,this)),this.zoom=1,this},transform:function c(t,e,i,n){var c="scale("+e+")";_.isUndefined(i)||(c+=" translate3d("+i+"px,"+n+"px, 0)");var o={transform:c,transition:t};$.zepto&&$.fx.cssPrefix&&(o[$.fx.cssPrefix+"transform"]=c),this.$el.css(o)},touch:function(t){var e=h(t).gesture,i=e.srcEvent,n=i&&i.touches;i.preventDefault(),this.isDoubleZoom=!1,n&&n.length>=2&&(this.isDoubleZoom=!0,this.doubleZoomOrg=this.zoom),this.xy=this.xy||[0,0]},getScale:function(){var t=this.el.naturalWidth,e=this.el.clientWidth;return t/e},doubleTap:function(t){this.el;return this.xy=[0,0],this.isDoubleTaped=!0,this.zoom>1.2?(this.zoom=1,void this.transform("200ms",1,0,0)):(this.zoom=2,void this.transform("200ms",this.zoom,0,0))},tap:function(t){_.delay(_.bind(function(){this.isDoubleTaped||(this.isDoubleTaped=!1,this.trigger("close:imageView"))},this),300),this.isDoubleTaped=!1},drag:function(t){var e=h(t).gesture,i=e.srcEvent,n=i&&i.touches;if(i.preventDefault(),!(1===this.zoom||n.length>1||this.isDoubleZoom)){var s=this.el,a=s.clientWidth*this.zoom,l=s.clientHeight*this.zoom,c=(a-r)/2/this.zoom,d=(l-o)/2/this.zoom,u=e.deltaX/this.zoom,p=e.deltaY/this.zoom,f=0,g=0;c>0&&(f=this.xy[0]+u>c?c+(this.xy[0]+u-c)/3:this.xy[0]+u<-c?-c+(this.xy[0]+u+c)/3:this.xy[0]+u),d>0&&(g=this.xy[1]+p>d?d+(this.xy[1]+p-d)/3:this.xy[1]+p<-d?-d+(this.xy[1]+p+d)/3:this.xy[1]+p),this.transform("0ms",this.zoom,f,g)}},pinch:function(t){var e=h(t).gesture,i=e.srcEvent;i&&i.touches;i.preventDefault(),this.isDoubleZoom=!0,this.zoom=Math.max(1,Math.min(this.doubleZoomOrg*e.scale,2)),this.transform("0ms",this.zoom,this.xy[0],this.xy[1])},release:function(t){var e=h(t).gesture;e.srcEvent&&e.srcEvent.touches;if(e.deltaX){var i=this.el,n=i.clientWidth*this.zoom,s=i.clientHeight*this.zoom,a=(n-r)/2/this.zoom,l=(s-o)/2/this.zoom,c=this.isDoubleZoom?0:e.deltaX/this.zoom,d=this.isDoubleZoom?0:e.deltaY/this.zoom,u=this.xy,p=0,f=0;a>0&&(p=c+u[0]>a?a:c+u[0]<-a?-a:u[0]+c),l>0&&(f=d+u[1]>l?l:d+u[1]<-l?-l:u[1]+d),a<0&&this.isDoubleZoom&&(p=0),l<0&&this.isDoubleZoom&&(f=0),this.transform("200ms",this.zoom,p,f),this.xy=[p,f]}}}),n.openImageView=function(t){var e=$(t.currentTarget),o=e.data("orig-height"),r=e.data("orig-width"),h=new n({origImage:e.data("orig-src"),origHeight:o,origWidth:r}),c=$("<div>",{"class":"loading"}).css(h.getAspect()),d=i({content:c,closable:!0}).addClass("dialog-image-view").on("open",function(){s.addClass("dialog-image-view-opened")}).on("close",function(){s.removeClass("dialog-image-view-opened")});d.el.css(h.getAspect()),d.open(),a.on("backbutton.imageview",function(){return h.trigger("close:imageView"),!1}),h.render().onLoaded(function(){c.replaceWith(h.$el)}),h.on("close:imageView",_.bind(function(){var t=d.overlay.el;return a.off("backbutton.imageview"),l()?(t.css({"-webkit-animation-name":"fadeout","-webkit-animation-duration":"0.5s"}),void $(t).one("webkitAnimationEnd",function(){d.close()})):d.close()}))},n}.apply(e,n),!(void 0!==o&&(t.exports=o))},function(t,e,i){var n,o;n=[i(6),i(3),i(2),i(21),i(22),i(82),i(83),i(84)],o=function($,_,t,e,i,n,o,r){return t.View.extend({className:"top-panel",tmpl:$("#tmpl-mobile-top-panel").html(),render:function(){var t=i.getModel("config").get("isChapter"),e=t?i.getModel("column"):i.getModel("article");if(this.$el.html(_.template(this.tmpl,{url:e.urlInMobileStore(),truncate:n,label:[t?"豆瓣"+e.get("kind"):"豆瓣阅读",e.get("title")].join(" - ")})),t||e.get("isSample")){var s=t?o:r;this.btnView=new s({model:e}),this.$el.find(".btn-placeholder").replaceWith(this.btnView.render().el)}return this},hide:function(){this.$el.is(":visible")&&this.$el.hide()},toggle:function(){var t=!this.$el.is(":visible");this.$el[t?"show":"hide"](),t&&this.btnView&&this.$(".label").css({marginRight:this.btnView.$el.width()+10})}})}.apply(e,n),!(void 0!==o&&(t.exports=o))},function(t,e,i){var n;"function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol?"symbol":typeof t};!function(o,r){n=function(){return r()}.call(e,i,e,t),!(void 0!==n&&(t.exports=n))}(void 0,function(){return function(t,e,i){return i||(i="…"),t?t.length<=e?t:t.substr(0,e)+i:""}})},function(t,e,i){var n,o;n=[i(2),i(6),i(3),i(22),i(21),i(53)],o=function(t,$,_,e,i,n){return t.View.extend({className:"subscribe btn-wrapper",tmpl:_.template($("#tmpl-simple-subscribe").html()),events:{"click .btn-subscribe":"subscribe"},initialize:function(){this.listenTo(this.model,"change:is_subscribed",function(){this.render()},this)},render:function(){return this.$el.html(this.tmpl(_.extend(this.model.toJSON(),{isAnonymous:i.me.isAnonymous}))),this},subscribe:function(){var t=this.model.get("kind"),e=this.model,i=n({content:"订阅成功后, "+t+"有更新时你将会收到提醒",title:"订阅"+t,closable:!0,type:"confirm"}).open();i.on("confirm",_.bind(function(){i.close();var o=n({content:t+"订阅中",title:"订阅"+t,closable:!1}).open();e.subscribe().always(function(){o.close()}).done(_.bind(function(t){return t.r?this.subscribeError(t.msg||t.error):void this.subscribeSuccess()},this)).fail(this.subscribeError)},this))},subscribeSuccess:function(){var t=n({title:"订阅成功",content:"订阅成功",closable:!0,type:"tips"}).open();t.on("confirm",function(){t.close()}),this.model.set("is_subscribed",!0)},subscribeError:function(t){var e=n({title:"订阅失败",content:t||"发生了奇怪的错误",closable:!0,type:"tips"}).open();e.on("confirm",function(){e.close()})}})}.apply(e,n),!(void 0!==o&&(t.exports=o))},function(t,e,i){var n,o;n=[i(2),i(6),i(3),i(22),i(21)],o=function(t,$,_,e,i){return t.View.extend({className:"btn-wrapper",tmpl:_.template($("#tmpl-ebook-purchase").html()),render:function(){return this.model.isFree()?this:(this.$el.html(this.tmpl(_.extend(this.model.toJSON(),{isAnonymous:i.me.isAnonymous,isFree:this.model.isFree()}))),this)}})}.apply(e,n),!(void 0!==o&&(t.exports=o))},function(t,e,i){var n;/*! iScroll v5.2.0 ~ (c) 2008-2016 Matteo Spinelli ~ http://cubiq.org/license */
!function(o,r,s){function a(t,e){this.wrapper="string"==typeof t?r.querySelector(t):t,this.scroller=this.wrapper.children[0],this.scrollerStyle=this.scroller.style,this.options={disablePointer:!h.hasPointer,disableTouch:h.hasPointer||!h.hasTouch,disableMouse:h.hasPointer||h.hasTouch,startX:0,startY:0,scrollY:!0,directionLockThreshold:5,momentum:!0,bounce:!0,bounceTime:600,bounceEasing:"",preventDefault:!0,preventDefaultException:{tagName:/^(INPUT|TEXTAREA|BUTTON|SELECT)$/},HWCompositing:!0,useTransition:!0,useTransform:!0,bindToWrapper:"undefined"==typeof o.onmousedown};for(var i in e)this.options[i]=e[i];this.translateZ=this.options.HWCompositing&&h.hasPerspective?" translateZ(0)":"",this.options.useTransition=h.hasTransition&&this.options.useTransition,this.options.useTransform=h.hasTransform&&this.options.useTransform,this.options.eventPassthrough=this.options.eventPassthrough===!0?"vertical":this.options.eventPassthrough,this.options.preventDefault=!this.options.eventPassthrough&&this.options.preventDefault,this.options.scrollY="vertical"!=this.options.eventPassthrough&&this.options.scrollY,this.options.scrollX="horizontal"!=this.options.eventPassthrough&&this.options.scrollX,this.options.freeScroll=this.options.freeScroll&&!this.options.eventPassthrough,this.options.directionLockThreshold=this.options.eventPassthrough?0:this.options.directionLockThreshold,this.options.bounceEasing="string"==typeof this.options.bounceEasing?h.ease[this.options.bounceEasing]||h.ease.circular:this.options.bounceEasing,this.options.resizePolling=void 0===this.options.resizePolling?60:this.options.resizePolling,this.options.tap===!0&&(this.options.tap="tap"),this.x=0,this.y=0,this.directionX=0,this.directionY=0,this._events={},this._init(),this.refresh(),this.scrollTo(this.options.startX,this.options.startY),this.enable()}var l=o.requestAnimationFrame||o.webkitRequestAnimationFrame||o.mozRequestAnimationFrame||o.oRequestAnimationFrame||o.msRequestAnimationFrame||function(t){o.setTimeout(t,1e3/60)},h=function(){function t(t){return n!==!1&&(""===n?t:n+t.charAt(0).toUpperCase()+t.substr(1))}var e={},i=r.createElement("div").style,n=function(){for(var t,e=["t","webkitT","MozT","msT","OT"],n=0,o=e.length;n<o;n++)if(t=e[n]+"ransform",t in i)return e[n].substr(0,e[n].length-1);return!1}();e.getTime=Date.now||function(){return(new Date).getTime()},e.extend=function(t,e){for(var i in e)t[i]=e[i]},e.addEvent=function(t,e,i,n){t.addEventListener(e,i,!!n)},e.removeEvent=function(t,e,i,n){t.removeEventListener(e,i,!!n)},e.prefixPointerEvent=function(t){return o.MSPointerEvent?"MSPointer"+t.charAt(7).toUpperCase()+t.substr(8):t},e.momentum=function(t,e,i,n,o,r){var a,l,h=t-e,c=s.abs(h)/i;return r=void 0===r?6e-4:r,a=t+c*c/(2*r)*(h<0?-1:1),l=c/r,a<n?(a=o?n-o/2.5*(c/8):n,h=s.abs(a-t),l=h/c):a>0&&(a=o?o/2.5*(c/8):0,h=s.abs(t)+a,l=h/c),{destination:s.round(a),duration:l}};var a=t("transform");return e.extend(e,{hasTransform:a!==!1,hasPerspective:t("perspective")in i,hasTouch:"ontouchstart"in o,hasPointer:!(!o.PointerEvent&&!o.MSPointerEvent),hasTransition:t("transition")in i}),e.isBadAndroid=function(){var t=o.navigator.appVersion;if(/Android/.test(t)&&!/Chrome\/\d/.test(t)){var e=t.match(/Safari\/(\d+.\d)/);return!(e&&"object"==typeof e&&e.length>=2)||parseFloat(e[1])<535.19}return!1}(),e.extend(e.style={},{transform:a,transitionTimingFunction:t("transitionTimingFunction"),transitionDuration:t("transitionDuration"),transitionDelay:t("transitionDelay"),transformOrigin:t("transformOrigin")}),e.hasClass=function(t,e){var i=new RegExp("(^|\\s)"+e+"(\\s|$)");return i.test(t.className)},e.addClass=function(t,i){if(!e.hasClass(t,i)){var n=t.className.split(" ");n.push(i),t.className=n.join(" ")}},e.removeClass=function(t,i){if(e.hasClass(t,i)){var n=new RegExp("(^|\\s)"+i+"(\\s|$)","g");t.className=t.className.replace(n," ")}},e.offset=function(t){for(var e=-t.offsetLeft,i=-t.offsetTop;t=t.offsetParent;)e-=t.offsetLeft,i-=t.offsetTop;return{left:e,top:i}},e.preventDefaultException=function(t,e){for(var i in e)if(e[i].test(t[i]))return!0;return!1},e.extend(e.eventType={},{touchstart:1,touchmove:1,touchend:1,mousedown:2,mousemove:2,mouseup:2,pointerdown:3,pointermove:3,pointerup:3,MSPointerDown:3,MSPointerMove:3,MSPointerUp:3}),e.extend(e.ease={},{quadratic:{style:"cubic-bezier(0.25, 0.46, 0.45, 0.94)",fn:function(t){return t*(2-t)}},circular:{style:"cubic-bezier(0.1, 0.57, 0.1, 1)",fn:function(t){return s.sqrt(1- --t*t)}},back:{style:"cubic-bezier(0.175, 0.885, 0.32, 1.275)",fn:function(t){var e=4;return(t-=1)*t*((e+1)*t+e)+1}},bounce:{style:"",fn:function(t){return(t/=1)<1/2.75?7.5625*t*t:t<2/2.75?7.5625*(t-=1.5/2.75)*t+.75:t<2.5/2.75?7.5625*(t-=2.25/2.75)*t+.9375:7.5625*(t-=2.625/2.75)*t+.984375}},elastic:{style:"",fn:function(t){var e=.22,i=.4;return 0===t?0:1==t?1:i*s.pow(2,-10*t)*s.sin((t-e/4)*(2*s.PI)/e)+1}}}),e.tap=function(t,e){var i=r.createEvent("Event");i.initEvent(e,!0,!0),i.pageX=t.pageX,i.pageY=t.pageY,t.target.dispatchEvent(i)},e.click=function(t){var e,i=t.target;/(SELECT|INPUT|TEXTAREA)/i.test(i.tagName)||(e=r.createEvent("MouseEvents"),e.initMouseEvent("click",!0,!0,t.view,1,i.screenX,i.screenY,i.clientX,i.clientY,t.ctrlKey,t.altKey,t.shiftKey,t.metaKey,0,null),e._constructed=!0,i.dispatchEvent(e))},e}();a.prototype={version:"5.2.0",_init:function(){this._initEvents()},destroy:function(){this._initEvents(!0),clearTimeout(this.resizeTimeout),this.resizeTimeout=null,this._execEvent("destroy")},_transitionEnd:function(t){t.target==this.scroller&&this.isInTransition&&(this._transitionTime(),this.resetPosition(this.options.bounceTime)||(this.isInTransition=!1,this._execEvent("scrollEnd")))},_start:function(t){if(1!=h.eventType[t.type]){var e;if(e=t.which?t.button:t.button<2?0:4==t.button?1:2,0!==e)return}if(this.enabled&&(!this.initiated||h.eventType[t.type]===this.initiated)){!this.options.preventDefault||h.isBadAndroid||h.preventDefaultException(t.target,this.options.preventDefaultException)||t.preventDefault();var i,n=t.touches?t.touches[0]:t;this.initiated=h.eventType[t.type],this.moved=!1,this.distX=0,this.distY=0,this.directionX=0,this.directionY=0,this.directionLocked=0,this.startTime=h.getTime(),this.options.useTransition&&this.isInTransition?(this._transitionTime(),this.isInTransition=!1,i=this.getComputedPosition(),this._translate(s.round(i.x),s.round(i.y)),this._execEvent("scrollEnd")):!this.options.useTransition&&this.isAnimating&&(this.isAnimating=!1,this._execEvent("scrollEnd")),this.startX=this.x,this.startY=this.y,this.absStartX=this.x,this.absStartY=this.y,this.pointX=n.pageX,this.pointY=n.pageY,this._execEvent("beforeScrollStart")}},_move:function(t){if(this.enabled&&h.eventType[t.type]===this.initiated){this.options.preventDefault&&t.preventDefault();var e,i,n,o,r=t.touches?t.touches[0]:t,a=r.pageX-this.pointX,l=r.pageY-this.pointY,c=h.getTime();if(this.pointX=r.pageX,this.pointY=r.pageY,this.distX+=a,this.distY+=l,n=s.abs(this.distX),o=s.abs(this.distY),!(c-this.endTime>300&&n<10&&o<10)){if(this.directionLocked||this.options.freeScroll||(n>o+this.options.directionLockThreshold?this.directionLocked="h":o>=n+this.options.directionLockThreshold?this.directionLocked="v":this.directionLocked="n"),"h"==this.directionLocked){if("vertical"==this.options.eventPassthrough)t.preventDefault();else if("horizontal"==this.options.eventPassthrough)return void(this.initiated=!1);l=0}else if("v"==this.directionLocked){if("horizontal"==this.options.eventPassthrough)t.preventDefault();else if("vertical"==this.options.eventPassthrough)return void(this.initiated=!1);a=0}a=this.hasHorizontalScroll?a:0,l=this.hasVerticalScroll?l:0,e=this.x+a,i=this.y+l,(e>0||e<this.maxScrollX)&&(e=this.options.bounce?this.x+a/3:e>0?0:this.maxScrollX),(i>0||i<this.maxScrollY)&&(i=this.options.bounce?this.y+l/3:i>0?0:this.maxScrollY),this.directionX=a>0?-1:a<0?1:0,this.directionY=l>0?-1:l<0?1:0,this.moved||this._execEvent("scrollStart"),this.moved=!0,this._translate(e,i),c-this.startTime>300&&(this.startTime=c,this.startX=this.x,this.startY=this.y)}}},_end:function(t){if(this.enabled&&h.eventType[t.type]===this.initiated){this.options.preventDefault&&!h.preventDefaultException(t.target,this.options.preventDefaultException)&&t.preventDefault();var e,i,n=(t.changedTouches?t.changedTouches[0]:t,h.getTime()-this.startTime),o=s.round(this.x),r=s.round(this.y),a=s.abs(o-this.startX),l=s.abs(r-this.startY),c=0,d="";if(this.isInTransition=0,this.initiated=0,this.endTime=h.getTime(),!this.resetPosition(this.options.bounceTime))return this.scrollTo(o,r),this.moved?this._events.flick&&n<200&&a<100&&l<100?void this._execEvent("flick"):(this.options.momentum&&n<300&&(e=this.hasHorizontalScroll?h.momentum(this.x,this.startX,n,this.maxScrollX,this.options.bounce?this.wrapperWidth:0,this.options.deceleration):{destination:o,duration:0},i=this.hasVerticalScroll?h.momentum(this.y,this.startY,n,this.maxScrollY,this.options.bounce?this.wrapperHeight:0,this.options.deceleration):{destination:r,duration:0},o=e.destination,r=i.destination,c=s.max(e.duration,i.duration),this.isInTransition=1),o!=this.x||r!=this.y?((o>0||o<this.maxScrollX||r>0||r<this.maxScrollY)&&(d=h.ease.quadratic),void this.scrollTo(o,r,c,d)):void this._execEvent("scrollEnd")):(this.options.tap&&h.tap(t,this.options.tap),this.options.click&&h.click(t),void this._execEvent("scrollCancel"))}},_resize:function(){var t=this;clearTimeout(this.resizeTimeout),this.resizeTimeout=setTimeout(function(){t.refresh()},this.options.resizePolling)},resetPosition:function(t){var e=this.x,i=this.y;return t=t||0,!this.hasHorizontalScroll||this.x>0?e=0:this.x<this.maxScrollX&&(e=this.maxScrollX),!this.hasVerticalScroll||this.y>0?i=0:this.y<this.maxScrollY&&(i=this.maxScrollY),(e!=this.x||i!=this.y)&&(this.scrollTo(e,i,t,this.options.bounceEasing),!0)},disable:function(){this.enabled=!1},enable:function(){this.enabled=!0},refresh:function(){this.wrapper.offsetHeight;this.wrapperWidth=this.wrapper.clientWidth,this.wrapperHeight=this.wrapper.clientHeight,this.scrollerWidth=this.scroller.offsetWidth,this.scrollerHeight=this.scroller.offsetHeight,this.maxScrollX=this.wrapperWidth-this.scrollerWidth,this.maxScrollY=this.wrapperHeight-this.scrollerHeight,this.hasHorizontalScroll=this.options.scrollX&&this.maxScrollX<0,this.hasVerticalScroll=this.options.scrollY&&this.maxScrollY<0,this.hasHorizontalScroll||(this.maxScrollX=0,this.scrollerWidth=this.wrapperWidth),this.hasVerticalScroll||(this.maxScrollY=0,this.scrollerHeight=this.wrapperHeight),this.endTime=0,this.directionX=0,this.directionY=0,this.wrapperOffset=h.offset(this.wrapper),this._execEvent("refresh"),this.resetPosition()},on:function(t,e){this._events[t]||(this._events[t]=[]),this._events[t].push(e)},off:function(t,e){if(this._events[t]){var i=this._events[t].indexOf(e);i>-1&&this._events[t].splice(i,1)}},_execEvent:function(t){if(this._events[t]){var e=0,i=this._events[t].length;if(i)for(;e<i;e++)this._events[t][e].apply(this,[].slice.call(arguments,1))}},scrollBy:function(t,e,i,n){t=this.x+t,e=this.y+e,i=i||0,this.scrollTo(t,e,i,n)},scrollTo:function(t,e,i,n){n=n||h.ease.circular,this.isInTransition=this.options.useTransition&&i>0;var o=this.options.useTransition&&n.style;!i||o?(o&&(this._transitionTimingFunction(n.style),this._transitionTime(i)),this._translate(t,e)):this._animate(t,e,i,n.fn)},scrollToElement:function(t,e,i,n,o){if(t=t.nodeType?t:this.scroller.querySelector(t)){var r=h.offset(t);r.left-=this.wrapperOffset.left,r.top-=this.wrapperOffset.top,i===!0&&(i=s.round(t.offsetWidth/2-this.wrapper.offsetWidth/2)),n===!0&&(n=s.round(t.offsetHeight/2-this.wrapper.offsetHeight/2)),r.left-=i||0,r.top-=n||0,r.left=r.left>0?0:r.left<this.maxScrollX?this.maxScrollX:r.left,r.top=r.top>0?0:r.top<this.maxScrollY?this.maxScrollY:r.top,e=void 0===e||null===e||"auto"===e?s.max(s.abs(this.x-r.left),s.abs(this.y-r.top)):e,this.scrollTo(r.left,r.top,e,o)}},_transitionTime:function(t){t=t||0;var e=h.style.transitionDuration;if(this.scrollerStyle[e]=t+"ms",!t&&h.isBadAndroid){this.scrollerStyle[e]="0.0001ms";var i=this;l(function(){"0.0001ms"===i.scrollerStyle[e]&&(i.scrollerStyle[e]="0s")})}},_transitionTimingFunction:function(t){this.scrollerStyle[h.style.transitionTimingFunction]=t},_translate:function(t,e){this.options.useTransform?this.scrollerStyle[h.style.transform]="translate("+t+"px,"+e+"px)"+this.translateZ:(t=s.round(t),e=s.round(e),this.scrollerStyle.left=t+"px",this.scrollerStyle.top=e+"px"),this.x=t,this.y=e},_initEvents:function(t){var e=t?h.removeEvent:h.addEvent,i=this.options.bindToWrapper?this.wrapper:o;e(o,"orientationchange",this),e(o,"resize",this),this.options.click&&e(this.wrapper,"click",this,!0),this.options.disableMouse||(e(this.wrapper,"mousedown",this),e(i,"mousemove",this),e(i,"mousecancel",this),e(i,"mouseup",this)),h.hasPointer&&!this.options.disablePointer&&(e(this.wrapper,h.prefixPointerEvent("pointerdown"),this),e(i,h.prefixPointerEvent("pointermove"),this),e(i,h.prefixPointerEvent("pointercancel"),this),e(i,h.prefixPointerEvent("pointerup"),this)),h.hasTouch&&!this.options.disableTouch&&(e(this.wrapper,"touchstart",this),e(i,"touchmove",this),e(i,"touchcancel",this),e(i,"touchend",this)),e(this.scroller,"transitionend",this),e(this.scroller,"webkitTransitionEnd",this),e(this.scroller,"oTransitionEnd",this),e(this.scroller,"MSTransitionEnd",this)},getComputedPosition:function(){var t,e,i=o.getComputedStyle(this.scroller,null);return this.options.useTransform?(i=i[h.style.transform].split(")")[0].split(", "),t=+(i[12]||i[4]),e=+(i[13]||i[5])):(t=+i.left.replace(/[^-\d.]/g,""),e=+i.top.replace(/[^-\d.]/g,"")),{x:t,y:e}},_animate:function(t,e,i,n){function o(){var u,p,f,g=h.getTime();return g>=d?(r.isAnimating=!1,r._translate(t,e),void(r.resetPosition(r.options.bounceTime)||r._execEvent("scrollEnd"))):(g=(g-c)/i,f=n(g),u=(t-s)*f+s,p=(e-a)*f+a,r._translate(u,p),void(r.isAnimating&&l(o)))}var r=this,s=this.x,a=this.y,c=h.getTime(),d=c+i;this.isAnimating=!0,o()},handleEvent:function(t){switch(t.type){case"touchstart":case"pointerdown":case"MSPointerDown":case"mousedown":this._start(t);break;case"touchmove":case"pointermove":case"MSPointerMove":case"mousemove":this._move(t);break;case"touchend":case"pointerup":case"MSPointerUp":case"mouseup":case"touchcancel":case"pointercancel":case"MSPointerCancel":case"mousecancel":this._end(t);break;case"orientationchange":case"resize":this._resize();break;case"transitionend":case"webkitTransitionEnd":case"oTransitionEnd":case"MSTransitionEnd":this._transitionEnd(t);break;case"wheel":case"DOMMouseScroll":case"mousewheel":this._wheel(t);break;case"keydown":this._key(t);break;case"click":this.enabled&&!t._constructed&&(t.preventDefault(),t.stopPropagation())}}},a.utils=h,"undefined"!=typeof t&&t.exports?t.exports=a:(n=function(){return a}.call(e,i,e,t),!(void 0!==n&&(t.exports=n)))}(window,document,Math)},,,function(t,e,i){var n,o;n=[i(6)],o=function($){function t(t){var e="keypress"!==t.type&&i[t.which],o=String.fromCharCode(t.which).toLowerCase(),r="",s={};if(t.altKey&&"alt"!==e&&(r+="alt+"),t.ctrlKey&&"ctrl"!==e&&(r+="ctrl+"),t.metaKey&&!t.ctrlKey&&"meta"!==e&&(r+="meta+"),t.shiftKey&&"shift"!==e&&(r+="shift+"),e)s[r+e]=!0;else{var a=r+o;a&&(s[a]=!0),a=n[o],a&&(s[r+a]=!0,"shift+"===r&&(a=n[o],a&&(s[a]=!0)))}return s}function e(e){e=e||{};var i=this;this.target=e.target||document,this.event=e.event||"keydown",this.keyHandlers={},this.rules=[],this.sequence={},this.sequenceNums=[],this.history=[],this._handler=function(e){if(this!==e.target&&(/textarea|select/i.test(e.target.nodeName)||"text"===e.target.type))return!0;var n=i.keyHandlers[i.event];if(!n)return!0;var o,r,s,a=t(e),l=i.lock||!i.check(this,e);if(!l){for(s in a)if(o=n[s])break;if(i.sequenceNums.length){var h=i.history;if(h.push(s),h.length>10&&h.shift(),h.length>1)for(var c=i.sequenceNums.length-1;c>=0;c--)if(r=n[h.slice(0-i.sequenceNums[c]).join("->")])return r.apply(this,arguments),h.length=0,!1}o&&o.apply(this,arguments)}},$(this.target).on(this.event,this._handler)}var i={8:"backspace",9:"tab",13:"enter",16:"shift",17:"ctrl",18:"alt",19:"pause",20:"capslock",27:"esc",32:"space",33:"pageup",34:"pagedown",35:"end",36:"home",37:"left",38:"up",39:"right",40:"down",45:"insert",46:"del",96:"0",97:"1",98:"2",99:"3",100:"4",101:"5",102:"6",103:"7",104:"8",105:"9",106:"*",107:"+",109:"-",110:".",111:"/",112:"f1",113:"f2",114:"f3",115:"f4",116:"f5",117:"f6",118:"f7",119:"f8",120:"f9",121:"f10",122:"f11",123:"f12",144:"numlock",145:"scroll",191:"/",224:"meta"},n={"`":"~",1:"!",2:"@",3:"#",4:"$",5:"%",6:"^",7:"&",8:"*",9:"(",0:")","-":"_","=":"+",";":":","'":'"',",":"<",".":">","/":"?","\\":"|"};return e.prototype={addHandler:function(t,e,i){function n(t){var e=t.split("->");if(e.length>1){o.sequence[e.length]=1;var n=[];for(var s in o.sequence)n.push(parseInt(s,10));o.sequenceNums=n.sort(function(t,e){return t-e})}r[t.toLowerCase()]=i}var o=this,r=this.keyHandlers[t];return r||(r=this.keyHandlers[t]={}),$.isArray(e)?$.each(e,function(t,e){n(e)}):n(e),this},reset:function(){$(this.target).off(this.event,this._handler),this.keyHandlers={},this.rules=[],this.history=[],delete this._handler,this.lock=!1},addRule:function(t){return this.rules.push(t),this},enable:function(){this.lock=!1},disable:function(){this.lock=!0},check:function(t,e){for(var i=!0,n=this.rules,o=0,r=n.length;o<r;o++)if(!n[o].call(t,e)){i=!1;break}return i}},$.each(["down","up","press"],function(t,i){e.prototype[i]=function(t,e){return this.addHandler("key"+i,t,e),this}}),function(t){return new e(t)}}.apply(e,n),!(void 0!==o&&(t.exports=o))},function(t,e,i){var n,o;n=[i(3),i(2),i(90)],o=function(_,t,e){var i=t.Model.extend({initialize:function(){this.on("change:currPage",this.setProgressAsCurrPage).on("change:currPage",this.setCurrPagePosition)},setProgressAsCurrPage:function(t,e){var i=t.get("totalPage");t.set("progress",e/i*100)},setCurrPagePosition:function(t,e){t.set("isFirstPage",e<=1),t.set("isLastPage",e===t.get("totalPage"))},setCurrPage:function(t,e){this.set({currPage:this.pageScope(t)},e)},setReadCurrPage:function(t,e){this.setCurrPage(this.read2real(t),e)},getReadCurrPage:function(){var t=this.get("currPage");return this.real2read(t)},setTotalPage:function(t){this.set({totalPage:t})},getReadTotalPage:function(){var t=this.get("totalPage");return this.real2read(t)},pageScope:function(t){var e=this.get("totalPage"),i=parseInt(t,10)||1;return i=i<=0?1:i,i=i>e?e:i},turnLastPage:function(){this.setCurrPage(this.get("totalPage"))},turnFirstPage:function(){this.setCurrPage(1)},currIsGiftPage:function(){return this.get("isGift")&&1===this.get("currPage")},isPageTurned:function(){return!!this.get("currPage")},set:function(){return this.isDisabled()?(e("turningModel.set() has been disabled, set failed"),this):t.Model.prototype.set.apply(this,arguments)},disableSet:function(){this.setDisable=!0},enableSet:function(){this.setDisable=!1},isDisabled:function(){return!!this.setDisable}}),n={read2real:function(t){return t+(this.get("isGift")?1:0)},real2read:function(t){var e=t-(this.get("isGift")?1:0);return!e||e<1?1:e}};return _.extend(i.prototype,n),i}.apply(e,n),!(void 0!==o&&(t.exports=o))},function(t,e,i){var n;n=function(){function t(){if(e&&e.error)try{e.error.apply(e,arguments)}catch(t){if(!Function.prototype.bind)return;var i=Function.prototype.bind.call(e.error,e);i.apply(e,arguments)}}var e=window.console;return t}.call(e,i,e,t),!(void 0!==n&&(t.exports=n))},function(t,e,i){var n,o;n=[i(6),i(3),i(92)],o=function($,_){function t(t){t=t||{},this.el=$(t.el||document.body),this.disableElements=t.disableElements,this.eventNS=".mw",this.eventName="mousewheel"+this.eventNS;var e=this;this.onMousewheel(_.debounce(function(t,i,n,o){var r={event:t,delta:i,deltaX:n,deltaY:o};i<0&&e.isAtBottom()?e.el.trigger("mousewheel:atBottom"+e.eventNS,r):i>0&&e.isAtTop()&&e.el.trigger("mousewheel:atTop"+e.eventNS,r)},40,!0))}return t.prototype={constructor:t,onMousewheel:function(t){var e=this;if(this.el.on(this.eventName,function(){e.disabled||t.apply(this,arguments)}),this.disableElements){var i=this.disableElements.join(",");this.el.on(this.eventName,i,function(t){t.stopPropagation()})}},onWheelBottom:function(t){this.el.on("mousewheel:atBottom"+this.eventNS,t)},onWheelTop:function(t){this.el.on("mousewheel:atTop"+this.eventNS,t)},isAtTop:function(){return 0===this.el[0].scrollTop},isAtBottom:function(){var t=this.el[0];return t.offsetHeight+t.scrollTop>=t.scrollHeight},reset:function(){this.el.off(this.eventNS)},enable:function(){this.disabled=!1},disable:function(){this.disabled=!0}},t}.apply(e,n),!(void 0!==o&&(t.exports=o))},function(t,e,i){var n,o,r;/*!
	 * jQuery Mousewheel 3.1.13
	 *
	 * Copyright jQuery Foundation and other contributors
	 * Released under the MIT license
	 * http://jquery.org/license
	 */
!function(s){o=[i(6)],n=s,r="function"==typeof n?n.apply(e,o):n,!(void 0!==r&&(t.exports=r))}(function($){function t(t){var r=t||window.event,s=a.call(arguments,1),l=0,c=0,d=0,u=0,p=0,f=0;if(t=$.event.fix(r),t.type="mousewheel","detail"in r&&(d=r.detail*-1),"wheelDelta"in r&&(d=r.wheelDelta),"wheelDeltaY"in r&&(d=r.wheelDeltaY),"wheelDeltaX"in r&&(c=r.wheelDeltaX*-1),"axis"in r&&r.axis===r.HORIZONTAL_AXIS&&(c=d*-1,d=0),l=0===d?c:d,"deltaY"in r&&(d=r.deltaY*-1,l=d),"deltaX"in r&&(c=r.deltaX,0===d&&(l=c*-1)),0!==d||0!==c){if(1===r.deltaMode){var g=$.data(this,"mousewheel-line-height");l*=g,d*=g,c*=g}else if(2===r.deltaMode){var m=$.data(this,"mousewheel-page-height");l*=m,d*=m,c*=m}if(u=Math.max(Math.abs(d),Math.abs(c)),(!o||u<o)&&(o=u,i(r,u)&&(o/=40)),i(r,u)&&(l/=40,c/=40,d/=40),l=Math[l>=1?"floor":"ceil"](l/o),c=Math[c>=1?"floor":"ceil"](c/o),d=Math[d>=1?"floor":"ceil"](d/o),h.settings.normalizeOffset&&this.getBoundingClientRect){var v=this.getBoundingClientRect();p=t.clientX-v.left,f=t.clientY-v.top}return t.deltaX=c,t.deltaY=d,t.deltaFactor=o,t.offsetX=p,t.offsetY=f,t.deltaMode=0,s.unshift(t,l,c,d),n&&clearTimeout(n),n=setTimeout(e,200),($.event.dispatch||$.event.handle).apply(this,s)}}function e(){o=null}function i(t,e){return h.settings.adjustOldDeltas&&"mousewheel"===t.type&&e%120===0}var n,o,r=["wheel","mousewheel","DOMMouseScroll","MozMousePixelScroll"],s="onwheel"in document||document.documentMode>=9?["wheel"]:["mousewheel","DomMouseScroll","MozMousePixelScroll"],a=Array.prototype.slice;if($.event.fixHooks)for(var l=r.length;l;)$.event.fixHooks[r[--l]]=$.event.mouseHooks;var h=$.event.special.mousewheel={version:"3.1.12",setup:function(){if(this.addEventListener)for(var e=s.length;e;)this.addEventListener(s[--e],t,!1);else this.onmousewheel=t;$.data(this,"mousewheel-line-height",h.getLineHeight(this)),$.data(this,"mousewheel-page-height",h.getPageHeight(this))},teardown:function(){if(this.removeEventListener)for(var e=s.length;e;)this.removeEventListener(s[--e],t,!1);else this.onmousewheel=null;$.removeData(this,"mousewheel-line-height"),$.removeData(this,"mousewheel-page-height")},getLineHeight:function(t){var e=$(t),i=e["offsetParent"in $.fn?"offsetParent":"parent"]();return i.length||(i=$("body")),parseInt(i.css("fontSize"),10)||parseInt(e.css("fontSize"),10)||16},getPageHeight:function(t){return $(t).height()},settings:{adjustOldDeltas:!0,normalizeOffset:!0}};$.fn.extend({mousewheel:function(t){return t?this.bind("mousewheel",t):this.trigger("mousewheel")},unmousewheel:function(t){return this.unbind("mousewheel",t)}})})},function(t,e,i){var n,o;n=[i(6),i(3),i(2),i(21),i(22),i(30),i(54),i(32),i(33),i(94),i(60),i(35),i(96),i(97),i(101),i(102),i(107),i(109),i(110),i(112)],o=function($,_,t,e,i,n,o,r,s,a,l,h,c,d,u,p,f,g,m,v){var y=t.View.extend({tmpl:$("#tmpl-panel").html(),initialize:function(t){_.bindAll(this,"hide","toggle","hideBubble","updateBubble","hideHelper","showHelper","toggleFilterTip"),this.app=i,this.vent=this.app.vent,this.config=t.config,this.vent.on({"close:helperGuide":this.hideHelper,"open:helperGuide":this.showHelper}),i.on("pageView:switched",this.hideAllBubbles,this),this.enableAnnotationsFilter(),this.isShown=!!this.$el.is(":visible")},render:function(t){var n=e.me.isAnonymous;return this.articleId=t.get("id"),this.ratingForm=new p({model:t.getRating()}),this.$el.html(_.template(this.tmpl,{isSample:!!t&&t.get("isSample"),isAnonymous:n,isGallery:this.config.get("isGallery"),canRate:!!t&&!!this.app.me&&this.app.me.canRate(t),reviewsUrl:i.router.getReviewsUrl(),questionsUrl:i.router.getQuestionsUrl(),layout:this.config.get("layout")})),this.layoutBtn=this.$el.find(".arkicon-layout"),this.helperBtn=this.$el.find("#fn-helper"),this.reviewsBtn=this.$el.find("#fn-salon"),this.backBtn=this.$el.find(".arkicon-back"),this.filterBtn=this.$el.find(".icon-annotations-filter"),this.toggleFilterIcon(this.othersAnnotationShown),this.config.get("isGallery")||(this.searchDialog&&this.searchDialog.remove(),this.searchDialog=new v({app:this.app,target:this.$(".icon-search")})),this.config.get("isChapter")&&this.checkQuestionFeature(),n||(this.config.get("isChapter")&&this.enableFavorIcon({articleId:this.articleId}),r.fitForMobile||(this.bubble=new a({renderTo:this.$el.find(".panel")})),this.ratingForm.on("cancel",this.hideBubble).on("updated",this.updateBubble)),this},events:{"click .arkicon-back":"backList","click .arkicon-layout":"_changeLayout","click .arkicon-star":"toggleRatingForm","click .arkicon-share":"toggleSharingForm","click #fn-helper":"toggleHelper","click .icon-annotations-filter":"toggleFilterTip","click .arkicon-favor":"toggleFavor","click .icon-search":"toggleSearch"},hideBubble:function(){this.bubble.hide()},hideAllBubbles:function(){i.vent.trigger("close:helperGuide"),_.each(["bubble","guideBubble","tinyBubble","searchDialog"],function(t){var e=this[t];e&&e.hide()},this)},openAnnotationGuideBubble:function(){var t=new c({html:'<div class="annotation-guide-bubble"><div class="bubble-content"></div></div>',onClickOutside:!1}),e=new m;this.guideBubble=t,t.set({arrowOffset:70,target:this.filterBtn[0],content:e.render().el}),e.on("close:wrapper open:annotationGuideDialog",function(){t.hide()}).on("open:annotationGuideDialog",function(){this.openAnnotationGuideDialog()},this),t.show()},openAnnotationGuideDialog:function(){var t=new g,e=o({body:t.render().$el,klass:"annotation-guide-overlay",closable:!1}).open();t.on("close:wrapper",function(){e.close()}).on("open:annotationGuideDialog",function(){this.openAnnotationGuideDialog()},this)},updateBubble:function(){this.bubble.update()},_changeLayout:function(){var t="vertical"===this.config.get("layout")?"horizontal":"vertical";this.config.set("layout",t),this.changeLayout(t)},changeLayout:function(t){return this.hideAllBubbles(),i.vent.trigger("close:popups"),this.changeLayoutBtn(t),this.vent.trigger("change:layout",t),this.vent.trigger("rerender:article"),l.alert("vertical"===t?"垂直阅读模式":"分页阅读模式"),this},changeLayoutBtn:function(t){this.vent.trigger("close:shortcutTips"),this.layoutBtn.toggleClass("vertical","vertical"===t)},enableAnnotationsFilter:function(){this.annotationConfig=this.config.get("annotationsConfig"),this.annotationsFilterView=new f({model:this.annotationConfig}),this.listenTo(this.annotationConfig,"change:showOthers",this.onFilterChange),this.onFilterChange(this.annotationConfig,this.annotationConfig.get("showOthers"))},toggleHelper:function(){var t=this.helperIsShown();this.hideAllBubbles(),t||this.isColumnLayout()||i.vent.trigger("open:helperGuide")},isColumnLayout:function(){return"c"===e.works.type},helperIsShown:function(){return $("i.tips").length},hideHelper:function(){var t=$("i.tips");t.length&&(t.remove(),!this.config||this.config.get("hasShownAnnotationGuide")||this.isColumnLayout()||this.config.get("isGallery")||(this.openAnnotationGuideBubble(),this.config.set("hasShownAnnotationGuide",!0)))},showHelper:function(){var t=$("body"),e=$(window),i=$("[data-helper]").toArray(),n='<i class="tips"><b></b>{TITLE}</i>',o=e.scrollTop(),r=e.scrollLeft();_.each(i,function(e){if(e=$(e),e.is(":visible")){var i=e.offset();t.append($(n.replace("{TITLE}",e.data("helper"))).css({top:i.top-o+(e.height()-20)/2,left:i.left-r+e.width()+12}))}})},toggleRatingForm:function(t){if(this.ratingForm){var e=this.bubble.isVisible();this.hideAllBubbles(),e||this.bubble.set({width:"380px",target:t.target,content:this.ratingForm.render().$el}).show()}},toggleSharingForm:function(t){var e=this.bubble.isVisible();this.hideAllBubbles(),e||(this.sharingForm=new d({isNote:!1,url:"/j/share/rec_article",extraParam:{aid:this.articleId}}),this.sharingForm.once("cancel submitted",this.hideBubble),this.bubble.set({width:"350px",target:t.target,content:this.sharingForm.render().$el}).show())},enableFavorIcon:function(t){this.favorModel=new u({articleId:t.articleId}),this.favorBtn=this.$el.find(".arkicon-favor"),this.favorModel.on("change:liked",this.renderFavorBtn,this),this.favorModel.fetch()},renderFavorBtn:function(t,e){e=!!e,this.favorBtn.toggleClass("is-favored",e)},toggleFavor:function(){return this.hideAllBubbles(),i.me.isAnonymous()?void l.toast("请先登录"):i.me.canRate(i.getModel("article"))?(this.favorModel.toggleFavor(),void l.toast(this.favorModel.get("liked")?"已喜欢":"已取消")):void l.toast("购买后可以喜欢此文章")},toggleSearch:function(){var t=this.searchDialog.bubble.isVisible();this.hideAllBubbles(),this.searchDialog[t?"hide":"show"]()},checkQuestionFeature:function(){this.$el.find("#fn-question").toggle(i.getModel("column").get("show_questions"))},toggleFilterTip:function(t){if(this.annotationConfig){this.tinyBubble||(this.tinyBubble=new c({html:'<div class="tiny-bubble"><div class="bubble-content filter-group"></div></div>'}),this.tinyBubble.set({arrowOffset:16,content:this.annotationsFilterView.el}));var e=this.tinyBubble.isVisible();this.hideAllBubbles(),e||(this.tinyBubble.set({target:t.target}),this.annotationsFilterView.render(i.me.isAnonymous()),this.tinyBubble.show())}},onFilterChange:function(t,e){this.othersAnnotationShown=e,this.toggleFilterIcon(e)},toggleFilterIcon:function(t){this.filterBtn&&this.filterBtn.toggleClass("opened",t)},backList:function(t){t.preventDefault();var e,i,o,r=location.pathname;n.hasPushState()?(e=document.referrer,o=/douban\.com:?\d*\/reader\/(ebooks|columns)/gi.test(e),e=o?e:"/reader/"+/(column|ebook)/gi.exec(r)[1]+"s"):(i=!!this.config.get("isChapter"),e="/reader/"+(i?"columns":"ebooks")),location.href=e},updateStyle:function(t){return this.$el.css(t),this},disableBtn:function(t){return this.$el.find(t).addClass("disabled"),this},enableBtn:function(t){return this.$el.find(t).removeClass("disabled"),this},hide:function(){return this.isShown?(this.bubble&&this.bubble.hide(),this.isShown=!1,void this.$el.hide()):this},show:function(){return this.isShown?this:(this.isShown=!0,void this.$el.show())},toggle:function(){return this.$el[this.isShown?"hide":"show"](),this.isShown=!this.isShown,this}});return y}.apply(e,n),!(void 0!==o&&(t.exports=o))},function(t,e,i){var n,o;n=[i(6),i(3),i(2),i(95)],o=function($,_,t,e){function i(t){t=$.extend({},r,t),this.opt=t,this.body=$(this.opt.renderTo),this.body[0]===document.body&&(this.renderToIsBody=!0);var e=this;this._config={},this._opened=!1,this._node=$(t.html),this._content=this._node.find(t.contentClass),this._close=this._node.find(t.closeClass),this.set(t),this._node.hide(),this._node.appendTo(this.body),this._node.on("click",t.closeClass,function(){e.hide()}),_.isUndefined(t.onClickOutside)||(this.onClickOutside=t.onClickOutside)}var n=document,o='<div class="reader-bubble"><b class="bubble-close">&times;</b><div class="bubble-content"></div></div>',r={html:o,contentClass:".bubble-content",closeClass:".bubble-close",arrowOffset:.5,renderTo:n.body};return i.extend=t.inhert,i.prototype={constructor:i,find:function(t){return this._node.find(t)},set:function(t){return this.opt=_.extend(this.opt,t),t.target&&(this._config.target=t.target),t.width&&this.setWidth(t.width),t.content&&this.setContent(t.content),this},setWidth:function(t){return this._node.css("width",t),this},setContent:function(t){return _.isString(t)||$(t).parent()[0]!==this._content[0]?(this._content.empty(),this._content.append(t),this):this},setPosition:function(t){var e=$(t),i=this._node.outerHeight(),n=this.getOffsetWithin(e).top+e.height()/2,o=n-i*this.opt.arrowOffset;return this._node.css({top:o,left:this.getOffsetWithin(e).left+35}),this},update:function(){return this.setPosition(this._config.target),this},isVisible:function(){return this._opened},show:function(){var t=this._config.target;return this._opened?void this.setPosition(t):(this._opened=!0,this._node.show(),this.onClickOutside&&e(this._node.add(t),$.proxy(this.onClickOutside,this)),this.setPosition(t),this.trigger("shown",this),this)},hide:function(t){if(this._opened)return this._opened=!1,this._node.hide(),t&&this._content.empty(),this.trigger("hidden",this),this},toggle:function(t){var e=this._config.target,i=this._config.prevTarget;return e!==i?(this._config.prevTarget=e,this.show(),this):(this._opened?this.hide(t):this.show(),this)},getOffsetWithin:function(t){if(this.renderToIsBody)return t.offset();var e={top:0,left:0},i=this.body[0],n=t[0];return _.isUndefined(n.getBoundingClientRect)||(e=n.getBoundingClientRect()),{top:e.top+i.scrollTop-(i.clientTop||0),left:e.left+i.scrollLeft-(i.clientLeft||0)}},destroy:function(){return this._opened=!1,this._node.remove(),this.trigger("destroyed",this),this}},_.extend(i.prototype,t.Events),i}.apply(e,n),!(void 0!==o&&(t.exports=o))},function(t,e,i){var n,o;n=[i(6)],o=function($){function t(t,n,o){function r(s){var a=$(s.target),l=a.parents().andSelf();e(l.get(),t.get())||(n.call(this,s),o||i.off("click",r))}t=$(t),i.on("click",r)}function e(t,e){for(var i=0,n=e.length;i<n;i++)if($.inArray(e[i],t)!==-1)return!0;return!1}var i=$(document);return t}.apply(e,n),!(void 0!==o&&(t.exports=o))},function(t,e,i){var n,o;n=[i(6),i(3),i(2),i(94)],o=function($,_,t,e){return e.extend({onClickOutside:function(){this.hide()},setPosition:function(t){var e=$(t),i=(this._node.outerHeight(),this.getOffsetWithin(e).top-$(document).scrollTop()+e.height()/2),n=i-this.opt.arrowOffset;return this._node.css({top:n,left:this.getOffsetWithin(e).left+35}),this}})}.apply(e,n),!(void 0!==o&&(t.exports=o))},function(t,e,i){var n,o;n=[i(6),i(2),i(3),i(9),i(33),i(98),i(60),i(99),i(100)],o=function($,t,_,e,i,n,o,r,s){var a=t.View.extend({tagName:"form",className:"share-form",tmpl:$("#tmpl-sharing-form").html(),initialize:function(t){this.dfd=$.Deferred(),this.promise=this.dfd.promise(),this.options=t,this.isNote=t.isNote,this.shareTypeLabel=t.shareTypeLabel||this.isNote?"推荐":"分享"},render:function(){var t=new r(this.options.extraParam,{url:this.options.url});return this.initializeSharing(t),this.$el.html(_.template(this.tmpl,{isNote:this.isNote,sharingActionsHtml:this.renderSharingHtml({sharingLabel:this.shareTypeLabel})})),this.bindSharingActions(),this.updateSharingText(),n.ctrlEnterForm(this.$el),this},events:{submit:"submitForm","click .ln-cancel":"cancelForm"},cancelForm:function(t){t.preventDefault(),this.dfd.reject(),this.trigger("cancel")},submitForm:function(t){t.preventDefault();var e=this.formModel,r=this.getText(),s=this.isNote,a=this.getCommentAttr();e.hasSharing()&&(n.readonlyForm(this.$el),e.set("text",r),s&&e.set("add_comment",a),e.save({}).done(_.bind(function(){this.shareText.val(""),n.resumeForm(this.$el),e.saveConfigToStroage(),a&&this.onAddCommentAttr(),o.toast(this.shareTypeLabel+"成功"),i._trackEvent("readShare")},this)).fail(_.bind(function(t,e,i){o.toast(this.shareTypeLabel+"失败: "+i)},this)),this.dfd.resolve(e),this.trigger("submitted",e))},getCommentAttr:function(){return this.$("#add-comment").is(":checked")?"on":""},onAddCommentAttr:$.noop});return _.extend(a.prototype,s),a}.apply(e,n),!(void 0!==o&&(t.exports=o))},function(t,e,i){var n,o;n=[i(6),i(88)],o=function($,t){function e(t){return t.height(0).scrollTop(0).scrollTop(1e4).scrollTop()}var i={},n="input, button, textarea",o="textarea";return i.toDict=function(t){for(var e,i={},n=t.serializeArray(),o=0;o<n.length;o++)e=n[o],i[e.name]=e.value;return i},i.send=function(t,e){var n=i.toDict(t),o=t.attr("method"),r=t.attr("action");return $.ajax($.extend({type:o,url:r,data:n},e))},i.readonlyForm=function(t){t.find(n).prop("disabled",!0)},i.resumeForm=function(t){t.find(n).prop("disabled",!1)},i.ctrlEnterForm=function(e){if(e=e.eq(0),!e.data("ctrl-enter-binded")){e.data("ctrl-enter-binded",!0);var i=e.find(o),n=i.data("key-router")||t({target:i});n.down(["ctrl+enter","meta+enter"],function(){$(this.form).submit()}),i.data("key-router",n)}},i.autoResize=function(t){var i=t.data("fake-textarea");if(i&&!t.data("has-expanded-max-height")){var n=t.val();i.val(n);var o=e(i),r=t.data("max-height")||100,s=t.data("min-height")||t.height();o>r&&(o=r,t.css({overflow:"auto"}).data("has-expanded-max-height",!0)),t.height(o<s?s:o)}},i.enableAutoResize=function(t,e){var n=t.clone();n.removeProp("name"),e=e||t.parent(),t.data("fake-textarea",n),t.on("input propertychange",$.proxy(function(e){if(e&&e.originalEvent){var n=e.originalEvent.propertyName;if(n&&"value"!==n)return}i.autoResize(t)},this)),n.css({position:"absolute",top:"-999px",left:0}),e.append(n)},i}.apply(e,n),!(void 0!==o&&(t.exports=o))},function(t,e,i){var n,o;n=[i(2),i(3),i(6),i(21),i(9),i(35)],o=function(t,_,$,e,i,n){var o=["broadcast_to_site","share_dou","share_weibo"];return t.Model.extend({defaults:function(){return _.extend({share_dou:"on",share_weibo:"on",broadcast_to_site:"",text:""},this.getConfigFromStorage()||{})},initialize:function(t,e){e&&e.url&&(this.url=e.url)},attrsGroup:{config:o,checkbox:o,sharing:o},getGroupKeys:function(t){var e=this.attrsGroup[t];if(!e)throw"`attrsGroup[groupName:"+t+"]` is not found";return e},pickAttrs:function(t){var e=this.getGroupKeys(t);return this.pick(e)},listenAttrsChange:function(t,e,i){var n=this.getGroupKeys(t),o=_.map(n,function(t){return"change:"+t}).join(" ");this.on(o,e,i)},configStroageKey:"sharingFormDefaults",getConfigFromStorage:function(){var t=n.get(this.configStroageKey);if(t)return JSON.parse(t)},saveConfigToStroage:function(t){t=t||"config";var e,i=this.pickAttrs(t);e=this.getConfigFromStorage(),i=_.defaults(i,e),n.set(this.configStroageKey,JSON.stringify(i))},fetchIsWeiboBinded:function(t){t=t||{};var e=this,n=this.get("share_weibo");this.set("share_weibo",""),i.get("/j/share/check_sina",function(i){var o=i.bind;e.set("share_weibo",n),o||e.unset("share_weibo"),t.success&&t.success(o)})},hasSharing:function(){var t=this.pickAttrs("sharing");return _.chain(t).values().some().value()}})}.apply(e,n),!(void 0!==o&&(t.exports=o))},function(t,e,i){var n,o;n=[i(6),i(3),i(2),i(22),i(9),i(30),i(33)],o=function($,_,t,e,i,n,o){return{tmplSharingActions:$("#tmpl-sharing-actions").html(),tmplShareWeibo:$("#tmpl-share-weibo").html(),disabledLabel:"请选择分享到哪里",initializeSharing:function(t,e){e=_.extend({disableWithoutSharing:!0},e),_.bindAll(this,"disableFormWithoutChecked","renderWeiboAction","updateVisible","updateModel"),this.formModel=t,t.fetchIsWeiboBinded({success:this.renderWeiboAction}),e.disableWithoutSharing&&(t.listenAttrsChange("sharing",this.disableFormWithoutChecked),this.disableFormWithoutChecked(t))},bindSharingActions:function(){this.settingBtn=this.$(".share-setting"),this.visibleChecker=this.$(".note-visible-wrapper input"),this.shareText=this.$(".textarea-text"),this.$("input[type=checkbox]").on("change",this.updateModel),this.visibleChecker.on("change",this.updateVisible),this.updateVisible()},defaultRenderOptions:{hasLabel:!0,hasVisibleSetting:!1,allowShare:!0},renderSharingHtml:function(t){return _.template(this.tmplSharingActions,_.extend(_.defaults(t,this.defaultRenderOptions),this.formModel.pickAttrs("sharing")))},renderWeiboAction:function(t){var e=this.$el.find(".item-weibo-wrapper"),i=this.$el.find(".weibo-setting");e.html(_.template(this.tmplShareWeibo,{weiboBinded:t,share_weibo:this.formModel.get("share_weibo")})),t?(this.formModel.weiboBinded=!0,this.$("#share-weibo").on("change",this.updateModel)):this.formModel.set("share_weibo",""),e.toggle(t),i.toggle(!t),this.settingBtn.toggle(t),this.updateVisible(),this.trigger("updated")},updateSharingText:function(){var t=this,n=e.getModel("article"),o=(this.$el.find(".item-weibo"),n?n.get("id"):location.pathname.split("/")[3]),r="";n&&(r=n.get("defaultSharingText"),this.shareText.val(r?r+" ":"")),o&&!e.getModel("config").get("isChapter")&&i.get("/ebook/"+o+"/events",function(e){if(e.hashtag){var i=$.trim(t.shareText.text()),n=(i.length?" ":"")+"#"+e.hashtag+"# ";t.shareText.val(i+n)}})},isPrivate:function(){return this.visibleChecker.is(":checked")},updateVisible:function(){var t=this.$(".share-options"),e=t.find("label, .label"),i=t.find("input[type=checkbox]"),n=this.isPrivate();e.toggleClass("disabled",n),i.prop("disabled",n),this.updateShareOptions(n)},updateShareOptions:function(t){var e,i=this.formModel.pickAttrs("sharing"),n=this.$(".share-options input[type=checkbox]");_.each(i,function(i,o){i=!t&&i,e=n.filter("[name="+o+"]")[0],e&&(e.checked=i)},this)},disableFormWithoutChecked:function(t){var e=!t.hasSharing(),i=this.$(".btn-post");e!==i.prop("disabled")&&i.prop("disabled",e).toggleClass("btn-disabled",e).text(e?this.disabledLabel:"确定")},updateModel:function(t){var e=$(t.currentTarget),i=e.attr("name"),n=e.prop("checked");this.formModel.set(i,n?"on":"")},getText:function(){return this.parseText(this.$("textarea[name=text]").val())},parseText:function(t){return $.trim(t).replace(/\n/g," ")}}}.apply(e,n),!(void 0!==o&&(t.exports=o))},function(t,e,i){var n,o;n=[i(2),i(3),i(9)],o=function(t,_,e){var i=t.Model.extend({defaults:{articleId:0,liked:!1,n_like:null},url:function(){var t=this.get("articleId");return"/j/article/"+t+"/like"},toggleFavor:function(){var t=this;if(!this.waiting){var i=!this.get("liked"),n=i?"post":"delete";return this.set("liked",i),this.set({liked:i,n_like:this.get("n_like")+(i?1:-1)}),this.waiting=!0,e({url:_.result(this,"url"),type:n}).then(null,function(){t.set({liked:!i,n_like:t.get("n_like")+(i?-1:1)})}).always(function(){t.waiting=!1}),this}}});return i}.apply(e,n),!(void 0!==o&&(t.exports=o))},function(t,e,i){var n,o;n=[i(2),i(3),i(6),i(22),i(98),i(103),i(104),i(100),i(99)],o=function(t,_,$,e,i,n,o,r,s){var a=$("#tmpl-rating-comment").html(),l=$("#tmpl-form-buttons").html(),h=t.View.extend({initialize:function(t){_.bindAll(this,"cancelEditing","renderError"),this.app=e},template:$("#tmpl-rating-form").html(),render:function(){this.stopListening(this.model);var t=this;return this.model.get("synced")&&(this.model.get("failed")?this.renderError():this.renderForm()),this.listenTo(this.model,"sync",function(){t.renderForm(),t.trigger("updated")}),this},renderForm:function(){var t=this.model;this.$el.html(this.template),this.renderRating(t),this.renderComment(t),this.renderFormButtons(t),this.renderSharingOptions(t),this.bindFormActions(t),i.ctrlEnterForm(this.$el)},renderError:function(){this.$el.html(this.template),this.$(".rating-form").html($("<div>",{"class":"field-group"}).text("您目前无法评价本文"))},renderRating:function(t){var e=new o({model:t});t.get("rated")&&!t.get("editingMode")?e.undelegateEvents():e.on("change:stars",function(e){t.set("unfinishedRating",e)}),this.$el.find(".rating").html(e.render().el)},renderComment:function(t){this.$el.find("#field-edit").html(_.template(a,t.toJSON())),this.$el.find("textarea").on("keyup",function(e){t.set("unfinishedComment",e.currentTarget.value)})},renderFormButtons:function(t){var e=this.$(".form-btns");e.html(_.template(l,t.toJSON()))},renderSharingOptions:function(t){var e=this.$(".sharing-options-wrapper");if(t.get("rated"))return void e.html("");var i=new s;this.initializeSharing(i),e.html(this.renderSharingHtml({sharingLabel:"同步"})),this.bindSharingActions(),t.once("sync",function(){i.saveConfigToStroage()})},cancelEditing:function(t){this.model.set({editingMode:!1,unfinishedComment:"",unfinishedRating:0}),this.trigger("cancel")},bindFormActions:function(t){var e=this,n=this.$el.find("form"),o=n.find(".validation-error"),r=n.find(".btn-cancel"),s=n.find(".link-edit");n.off("submit"),t.on("invalid",function(t,e){o.text(e)}),r.on("click",function(i){i.preventDefault(),e.cancelEditing(t)}),s.on("click",function(t){t.preventDefault(),e.model.set("editingMode",!0),e.renderForm(),e.trigger("updated")}),n.on("submit",function(e){e.preventDefault(),e.stopPropagation();var o=n.find("[data-stars]")[0].getAttribute("data-stars"),r=i.toDict(n);r.rating=o,r.rated=+o,r.unfinishedComment="",r.unfinishedRating=0,r.editingMode=!1,t.set(r),t.save()})}});return _.extend(h.prototype,r),h}.apply(e,n),!(void 0!==o&&(t.exports=o))},function(t,e,i){var n,o;(function($){"use strict";n=[i(2),i(3)],o=function(t,_){var e=!1,i=t.Model.extend({defaults:{rating:0,articleId:0,rated:!1,comment:"",share_dou:"",share_weibo:"",share_site:"",synced:!1,failed:!1,unfinishedComment:"",unfinishedRating:0,editingMode:!1},url:function(){var t=this.get("articleId");return"/j/article_v2/"+t+"/rating"},validate:function(t){var i=350,n=0|t.rating,o=$.trim(t.comment);return n?e&&o.length>i?"评语最多能写 "+i+" 个字":void 0:"请先为作品打分"}});return i}.apply(e,n),!(void 0!==o&&(t.exports=o))}).call(e,i(6))},function(t,e,i){var n,o;n=[i(2),i(6),i(105),i(106)],o=function(t,$,e,i){var n=t.View.extend({template:$("#tmpl-rating").html(),events:{"mouseover .star-region":"hoveringStar","mouseout .stars-context":"resumeStar","click .star-region":"rate"},render:function(){return this.$el.html(i(this.template,this.model.toJSON())),this.starsContext=this.$el.find(".stars-context").get(0),this.stars=this.starsContext.getAttribute("data-stars"),this}});return $.extend(n.prototype,e),n}.apply(e,n),!(void 0!==o&&(t.exports=o))},function(t,e,i){var n,o;n=[],o=function(){return{rate:function(t){t.preventDefault(),this.stars=this.parseStar(t.target),this.starsContext.setAttribute("data-stars",this.stars),this.trigger("change:stars",this.stars)},parseStar:function(t){return t.getAttribute("data-star")},hoveringStar:function(t){var e=this.parseStar(t.target);this.displayStar(e)},resumeStar:function(){this.displayStar(this.stars)},displayStar:function(t){var e=this.starsContext.className;this.starsContext.className=e.replace(/stars-\d+/g,"stars-"+t)}}}.apply(e,n),!(void 0!==o&&(t.exports=o))},function(t,e,i){var n,o;n=[i(3)],o=function(_){function t(t,e){this.data=t,_.extend(this,e)}return function(e,i,n){i=_.isArray(i)?i:[i];var o=_.map(i,function(i){return i.$item=new t(i,n||{}),_.template(e,i)});return o.join("")}}.apply(e,n),!(void 0!==o&&(t.exports=o))},function(t,e,i){var n,o;n=[i(6),i(3),i(2),i(22),i(108)],o=function($,_,t,e,i){var n=t.View.extend({tagName:"form",className:"annotations-filter",tmpl:$("#tmpl-annotations-filter-list").html(),events:{change:"changeFilter"},initialize:function(){this.listenTo(this.model,"change",this.update)},render:function(t){var e=this.model.toJSON();return e.isAnonymous=t,this.$el.html(_.template(this.tmpl,e)),this.renderExtraClass(),this.filterList=this.$(".filter-list"),this},renderExtraClass:$.noop,update:function(t){var e=t.changedAttributes();"showOthers"in e&&this.filterList.toggleClass("show-others",e.showOthers),this.renderExtraClass()},changeFilter:function(t){var e=$(t.currentTarget),n=i(e);n.showOthers=!!n.showOthers,this.model.set(n)}});return/msie 8/i.test(navigator.userAgent)&&_.extend(n.prototype,{renderExtraClass:function(){this.$(".checked").removeClass("checked"),this.$(":checked").parent().find("i").addClass("checked")}}),n}.apply(e,n),!(void 0!==o&&(t.exports=o))},function(t,e,i){var n,o;n=[i(6)],o=function($){$=$||window.$;var t=function(t){var e={},i="",n=t.serializeArray();return $.each(n,function(){i=this.name,e[i]?($.isArray(e[i])||(e[i]=[e[i]]),e[i].push(this.value||"")):e[i]=this.value||""}),e};return t}.apply(e,n),!(void 0!==o&&(t.exports=o))},function(t,e,i){var n,o;n=[i(6),i(3),i(2),i(22)],o=function($,_,t,e){return t.View.extend({tmpl:$("#tmpl-annotation-guide-dialog").html(),className:"annotation-guide-content",events:{"click .btn-close":"closeDialog"},closeDialog:function(t){t.preventDefault(),this.trigger("close:wrapper")},render:function(){return this.$el.html(this.tmpl),this}})}.apply(e,n),!(void 0!==o&&(t.exports=o))},function(t,e,i){var n,o;n=[i(6),i(3),i(2),i(21),i(22),i(111)],o=function($,_,t,e,i,n){return t.View.extend({tmpl:$("#tmpl-annotation-guide-bubble").html(),events:{"click .lnk-close":"closeBubble","click .btn-more-info":"openAnnotationDialog"},closeBubble:function(t){t.preventDefault(),this.trigger("close:wrapper")},openAnnotationDialog:function(t){t.preventDefault(),this.trigger("open:annotationGuideDialog")},render:function(){return this.$el.html(this.tmpl),n(e.ANNOTATION_GUIDE_PIC),this}})}.apply(e,n),!(void 0!==o&&(t.exports=o))},function(t,e,i){var n;n=function(){var t=function(t){if(t)for(var e=[].concat.call([],t),i=e.length,n=0;n<i;)(new Image).src=e[n++]};return t}.call(e,i,e,t),!(void 0!==n&&(t.exports=n))},function(t,e,i){var n,o;n=[i(3),i(6),i(2),i(113),i(96)],o=function(_,$,t,e,i){function n(t){var e=this;_.bindAll(this,"render","show","hide"),this.app=t.app,this.target=t.target,$.when(this.app.getModelPromise("content"),this.app.getModelPromise("turning")).done(function(){return _.delay(e.render,100)})}function o(){l.css("overflow","hidden")}function r(){l.css("overflow","")}function s(t){t.stopPropagation()}function a(t,e,i){e.on(t,_.bind(i.trigger,i,t))}_.extend(n.prototype,{render:function(){return this.renderSearchBox(),this.renderBubble(),this.hide(),this},renderBubble:function(){this.bubble=new i({html:'<div class="search-dialog"><b class="bubble-close">&times;</b><h3 class="dialog-title">搜索本文</h3><div class="bubble-content"></div></div>',onClickOutside:!1}),this.bubble.set({arrowOffset:18,content:this.searchBox.el,target:this.target}),this.bubble.on("hidden destroyed",this.onHide,this),this.searchBox.$el.on("mousewheel",s)},renderSearchBox:function(){var t=this.app.getModel("turning"),i=this.app.getModel("content");this.searchBox=new e({turningModel:t,contentModel:i}),this.searchBox.$el.on("mouseenter",o).on("mouseleave",r),a("searchResult:jumped",this.searchBox,this.app.vent),this.searchBox.render(),this.searchInput=this.searchBox.$("[name=query]")},show:function(){this.bubble.show(),this.searchInput.select()},hide:function(){this.bubble.hide()},onHide:function(){r(),this.searchInput.blur(),this.app.vent.trigger("searchBox:closed")},toggle:function(){this.bubble.isVisible()?this.hide():this.show()},remove:function(){this.searchBox.remove(),this.bubble.destroy()}});var l=$(document.body);return n}.apply(e,n),!(void 0!==o&&(t.exports=o))},function(t,e,i){var n,o;n=[i(3),i(6),i(2),i(114)],o=function(_,$,t,e){function i(t){t.preventDefault()}var n=t.View.extend({tmpl:$("#tmpl-search-box").html(),pageNumResultTmpl:$("#tmpl-pagenum-result").html(),searchResultTmpl:$("#tmpl-search-result").html(),className:"search-box",initialize:function(t){_.bindAll(this,"search","onKeyDown","jumpToItem"),this.contentModel=t.contentModel,this.turningModel=t.turningModel,this.lastSearch="",this.textSearch=new e(this.contentModel)},events:{"click .result-item":"jumpToItem","keydown .query":"onKeyDown","submit.1 .search-form":"search","submit.2 .search-form":i},render:function(){return this.$el.html(_.template(this.tmpl,{query:this.lastSearch})),this.elInput=this.$("[name=query]"),this.elResults=this.$(".results"),this.elPageNumResult=this.$(".pagenum-result ul"),this.elSearchResult=this.$(".search-result ul"),this.elSearchResultCount=this.$(".search-results-count"),this.elInput.focus(),this.real2read=_.bind(this.turningModel.real2read,this.turningModel),this},update:function(t,e){t&&this.elPageNumResult.html(_.template(this.pageNumResultTmpl,{result:t,real2read:this.real2read}));var i=e&&e.length;i&&this.elSearchResult.html(_.template(this.searchResultTmpl,{items:e,real2read:this.real2read})),this.elSearchResultCount.text(i?e.length:""),this.$el.toggleClass("has-pagenum-result",!!t).toggleClass("has-search-result",e&&!!e.length)},search:function(){var t=$.trim(this.elInput.val());if(t.length){var e=this.findPagePara(t),i=this.textSearch.search(t);this.$el.addClass("search-done"),this.elResults.scrollTop(0),this.query=t,this.pageNumResult=e,this.searchResult=i,this.update(e,i)}},findPagePara:function(t){var e=parseInt(t,10);if(!isNaN(e)){var i=this.turningModel.read2real(e),n=this.contentModel.getPage(i);if(n)return _.defaults(n)}},onKeyDown:function(t){t.stopPropagation()},jumpToItem:function(t){var e=$(t.currentTarget).data(),i=e.pno,n=this.searchResult[e.index];this.turningModel.set("currPage",i),this.trigger("searchResult:jumped",n,this.query)}});return n}.apply(e,n),!(void 0!==o&&(t.exports=o))},function(t,e,i){var n,o;(function($){"use strict";n=[i(3),i(115),i(82)],o=function(_,t,e){function i(e){this.contentModel=e,this.paraList=this.getParaList(),this.textList=this.getTextList(this.paraList),
this.searchWorker=new t(this.textList)}function n(t,i,n){var s=t.slice(0,i),a=t.slice(i,n),l=t.slice(n);return s=o(e(o(s),r)),l=e(l,r),{left:s,self:a,right:l}}function o(t){return t.split("").reverse().join("")}_.extend(i.prototype,{getParaList:function(){var t=this.contentModel,e=t.parasIndexs,i=t.pidAndParaMap;return _.chain(e).map(function(t){return i[t]}).filter(function(t){return t&&"paragraph"===t.type}).value()},getTextList:function(t){var e=$("<div>");return _.map(t,function(t){return e[0].innerHTML=t.text,e.remove("sup"),e[0].innerText})},search:function(t){var e=this,i=this.searchWorker.find(t),o=this.paraList,r=this.textList,s=this.contentModel.pidAndPageMap;return i=_.map(i,function(t){var i=o[t.index],a=r[t.index],l=s[i.pid],h=l[0],c=e.contentModel.getPage(h),d=t.startOffset,u=t.endOffset;return{startOffset:d,endOffset:u,paragraph:i,page:c,paginations:l,texts:n(a,d,u)}})}});var r=20;return i}.apply(e,n),!(void 0!==o&&(t.exports=o))}).call(e,i(6))},function(t,e,i){var n,o;n=[i(3)],o=function(_){function t(t,i){this.opts=_.defaults(i||{},e),this.list=t}var e={avoidHugeSearch:!0},i={ignoreCase:!0,wildcard:!1,regexp:!1},n=/[A-Z]/;return _.extend(t.prototype,{find:function(t,e){if(e=this.parseOptions(e,t),this.opts.avoidHugeSearch&&this.isHugeQuery(t,e))return[];e.wildcard?t=t.replace(/[-[\]{}()+.,\\^$|#\s]/g,"\\$&").replace(/\*/g,".+").replace(/\?/g,"."):e.regexp||(t=t.replace(/[-[\]{}()*+?.,\\^$|#\s]/g,"\\$&"));var i,n=[],o="g"+(e.ignoreCase?"i":""),r=new RegExp(t,o);return _.each(this.list,function(t,e){for(;null!==(i=r.exec(t));)n.push({startOffset:i.index,endOffset:r.lastIndex,index:e,text:t})}),n},parseOptions:function(t,e){return t=t||{},_.isUndefined(t.ignoreCase)&&(t.ignoreCase=!n.test(e)),t=_.defaults(t,i)},isHugeQuery:function(t,e){return!!e.wildcard&&0===t.replace(/[?*]/g,"").length}}),t}.apply(e,n),!(void 0!==o&&(t.exports=o))},function(t,e,i){var n,o;n=[i(6),i(2),i(3),i(21),i(22),i(117),i(10),i(9),i(30),i(49),i(90),i(118),i(120),i(121),i(184),i(190),i(191),i(35),i(32),i(192),i(193),i(194),i(200),i(33),i(201),i(78),i(202),i(203),i(204),i(206),i(207),i(208),i(209),i(210),i(211)],o=function($,t,_,e,i,n,o,r,s,a,l,h,c,d,u,p,f,g,m,v,y,b,w,x,P,k,T,C,M,S,A,I,N,E,D){function F(){var t=$.Deferred();return t.resolve.apply(t,arguments).promise()}var B=t.View.extend({el:".article",events:{"click .inner":"captureTags","click .illus":"expandIllus","mouseenter .inner":"hoverPage","mouseleave .inner":"hoverPage"},initialize:function(t){_.bindAll(this,"renderPages","getArticleData","parseArticleData","renderOnArticleData","bindResize","paging","renderOnPagingDone","jumpToProgress","reRenderArticle","hoverPage","onResizePage","adaptArticleData","adaptDecryptedData","renderHeaderControls"),this.config=t,this.vent=i.vent,this.vent.on({"render:pages":this.renderPages,"rerender:article":this.reRenderArticle}),this.tmplArticle=$("#tmpl-article").html(),this.tmplEmptyPage=$("#tmpl-empty-page").html(),i.utils=i.utils||{},i.utils.applyPurchaseWithIn=h,this.unloadConfirmer=new C,this.pagesContainer=new d({app:i,vent:this.vent}),this.pagesContainer.on("pages:rendered",this.renderHeaderControls,this),this.listenTo(this.pagesContainer,"preloadCountChanged",this.reRenderPages),this.pageJumpManager=new N,this.progressManager=new E,this.listenTo(i.getModel("turning"),"change:currPage",this.pageJump),e.me.isAnonymous||(this.bookmarkManage=new u({vent:this.vent,config:this.config})),i.articleInner=this.articleInner=this.pagesContainer.$el,this.doc=document,this.win=$(window),this.layout=this.config.get("layout"),$(document).on("purchase:finish payment:finish",function(){location.reload()})},render:function(t){this.trigger("view:render"),this.articleId=t;var e=new f({},{articleId:t});return e.fetch(),i.setModel("reviews",e),this.pageJumpManager.render(this.articleInner),this.initArticle(),this},bindResize:function(){this.win.on("resize.article",_.debounce(this.onResizePage,200))},unbindResize:function(){this.win.off("resize.article")},initArticle:function(){this.unbindResize(),i.unsetModel("content"),this.progressManager.preloadProgress(this.articleId),this.trigger("article:init"),this.beforeGetArticleData().then(this.getArticleData).then(this.parseArticleData).done(this.renderOnArticleData).done(this.bindResize).then(this.paging).then(this.renderOnPagingDone).then(this.afterPagingDone).then(this.jumpToProgress).then(this.afterJumpingProgress),this.resetHooks()},beforeGetArticleData:F,afterPagingDone:F,afterJumpingProgress:F,allowedHooks:["beforeGetArticleData","afterPagingDone","afterJumpingProgress"],resetHooks:function(){_.each(this.allowedHooks,function(t){delete this[t]},this)},attachHooks:function(t){_.each(this.allowedHooks,function(e){var i=this[e],n=t[e];n&&(this[e]=function(){function t(){return e}var e=i.apply(this,arguments),o=n.apply(this,arguments);return $.when(o,e).then(t,t)})},this)},onResizePage:function(){this.needReFitWindow()&&(this.fitForWindow(),this.initArticle())},reRenderArticle:function(){this.prevLayout=this.layout,this.layout=this.config.get("layout"),"horizontal"===this.layout?(this.articleInner.height("auto"),this.$el.find(".page").removeAttr("style"),this.fitForWindow()):(this.$el.height("auto"),this.pageHeight=this.config.get("pageHeight"),this.articleInner.removeAttr("style"),this._clearPageStyle()),this.initArticle()},renderHeaderControls:function(){this.config.get("isChapter")?this.renderChapterHeaderControls():this.renderOriginHeaderControls()},renderOriginHeaderControls:function(){var t=new A({className:"header-controls"}),e=this.pagesContainer.getCurrPage().$el;e.find(".header-extra").html(t.render().el)},renderChapterHeaderControls:function(){var t=new I({className:"header-controls"}),e=this.pagesContainer.getCurrPage().$el;e.find(".header-extra").html(t.render({columnId:i.getModel("chapters").columnId,hasAdded:i.getModel("article").get("hasAdded")}).el)},getArticleData:function(){function t(t){var e=t.data,i=JSON.parse(w.dec(e));r.dataFromLocal=!0,i.gift&&(i.gift.opened=!0),r.adaptDecryptedData(i),o.resolve(i)}function n(t){r.dataFromLocal=!1,r.adaptArticleData(t);var n=t.data,a=$.parseJSON(w.dec(n)),l=a.sample&&r.config.get("isChapter");r.adaptDecryptedData(a),i.vent.trigger("article:fetching:finish",a),e.me.isAnonymous||e.me.isAdmin||l||r.updateLocalArticle(s,t),o.resolve(a)}var o=new $.Deferred;y.resetForDifferentUser(e.me.id);var r=this,s=this.articleId,a=y.getArticle(s);return this.previousAid=g.get("previousAid"),this.resetTypePage(),a?(this.adaptArticleData(a),T(s,this).done($.proxy(function(e){e.r?t(a):this.fetchArticle().done(n)},this))):this.fetchArticle().done(n),o.promise()},updateLocalArticle:function(t,e){try{y.freeUpStorageSpace(),y.saveArticle(t,e)}catch(i){l(i)}},parseArticleData:function(t){return this.config.get("isChapter")&&this.isSample&&(this.favorCount=t.n_like||0,this.emptyArticleContent(t)),t},emptyArticleContent:function(t){var e=t.posts,i=[{id:1,type:"paragraph",data:{text:"",format:{}}}];e.length=1,e[0].contents=i},renderOnArticleData:function(t){var e=this.articleId;$("body").addClass("lang-"+this.lang),this.lineHeight="en"===this.lang?24:16*this.config.get("lineHeight"),this.config.set("lineHeight",this.lineHeight/16),this.config.get("isChapter")&&this.isSample||this.injectEmptyCustomSectionToArticleData(t);var n=this.createArticleModel();this.vent.trigger("render:panel",n),n.on("change:hasAdded",function(t,i){y.setArticleAttr(e,"hasAdded",i),this.hasAdded=i});var o="你写的评价尚未提交，确认离开？";return this.listenTo(n.getRating(),"change:unfinishedComment",function(t,e){e?this.unloadConfirmer.addConfirm("rating",o):this.unloadConfirmer.removeConfirm("rating")}),M(t,n,this.config,i),n.get("isSample")&&(n.get("dataFromLocal")&&n.updatePrice(),n.checkPricePeriodically()),this.detectIsArchived(),t},injectEmptyCustomSectionToArticleData:function(t){var e=t.posts,i=e.length,n={data:{},type:"custom"};i&&e[i-1].contents.push(n)},createArticleModel:function(){var t=new p({id:this.articleId,title:this.title,price:this.price,fixedPrice:this.fixedPrice,lang:this.lang,isGift:this.isGift,isSample:this.isSample,hasAdded:this.hasAdded,hasFormula:this.hasFormula,purchaseTime:this.purchaseTime,authorId:this.authorId,"abstract":this["abstract"],dataFromLocal:this.dataFromLocal,cover_url:this.cover_url});return i.setModel("article",t),t},adaptArticleData:function(t){this.title=t.title,this.purchaseTime=t.purchase_time,this.isSample=t.is_sample,this.isGift=t.is_gift,this.hasFormula=t.has_formula,this.hasAdded=t.has_added,this.price=t.price,this.fixedPrice=t.fixed_price,this.lang=t.lang||"cn",this.cover_url=t.cover_url},adaptDecryptedData:function(t){this.authorId=t.authorId,this["abstract"]=t["abstract"]||""},hoverPage:function(t){this.vent.trigger("hover:page",t)},paging:function(t){var e=this.hasFormula;this.prevLayout=this.layout,this.needFitWindow()&&this.fitForWindow(),this.vent.trigger("paging:start",t);var i=new c({autoSpacing:m.fitForMobile});$.each(t.posts,function(e,n){t.posts[e].contents=i.transformParas(n.contents)});var n=b({pageHeight:this.pageHeight,lineHeight:this.lineHeight,data:t,typePage:this.articleInner,metadata:{hasFormula:e},template:{article:this.tmplArticle},layout:this.layout});return n},renderOnPagingDone:function(t){this.totalPage=t.body.length||1;var e=i.getModel("article"),n=i.getModel("turning");return n.enableSet(),n.set("isGift",e.get("isGift")),n.set("totalPage",this.totalPage),i.setModel("content",t),this.bookmarkManage&&this.bookmarkManage.render({article:e,contentModel:t,config:this.config}),this.resetTypePage(),this.preRenderTypePage(),this.pagesContainer.empty(),this.vent.trigger("paging:finish",t.contents),this._trackGAEvent(),t},jumpToProgress:function(){var t=$.Deferred();return this.once("pages:rendered:fully",t.resolve),this.progressManager.loadProgressThenJump(),t.promise()},pageJump:function(){this.$el.find(".page-empty").remove(),this.progressManager.saveReadingProgress();var t=this,e=arguments;_.defer(function(){t.pageJumpManager.pageJump.apply(null,e)})},detectIsArchived:function(){if(this.dataFromLocal){var t=i.getModel("article");return r.post("/j/article_v2/is_archived",{works_id:this.articleId}).done($.proxy(function(e){t.set("hasAdded",0|!e.r)},this))}},fetchArticle:function(){function t(){if(!_.isFunction(history.pushState))return location.href="/ebook/"+n+"/",!1;var t="加载失败，请刷新重试。",e=confirm(t);e&&location.reload()}function e(e){return e.r?t():void l.resolve(e)}var n=this.articleId,o="/j/article_v2/get_reader_data",s={aid:n,reader_data_version:y.getReaderDataVersion()},a=r({url:o,type:"POST",data:s}),l=$.Deferred();return i.vent.trigger("article:fetching:start"),a.success(e).error(t),l.promise()},renderPages:function(t){this.pagesContainer.render({layout:t}),this.completeArticle(),this.trigger("pages:rendered:fully")},reRenderPages:function(){this.renderPages(this.config.get("layout"))},completeArticle:function(){S.loadFigures(this.$el,this.pageWidth);var t=this.config.get("isChapter"),n=e.me.isAnonymous,o=this.$(".custom"),r=i.getModel("article");this.isSample?D.appendPurchaseGuide(o,r):n||t||D.appendRatingSection(o,r),D.appendReviewsLink(o,r,i.getModel("reviews")),D.appendSharingButtons(o,r)},fillHeight:function(t){var e=16*t,i=e%this.lineHeight;return(e-i)/16},fitForWindow:function(){this.winHeight=this.win.height(),this.page=this.$el.find(".page"),this.pageWidth=this.page.width();var t=this.doc.body.clientHeight/16,e=(parseInt(this.page.css("padding-top"),10)+parseInt(this.page.css("padding-bottom"),10))/16,i=t-e,n=15.25;t=i<n?n+e:t,this.typePageSize={width:this.pageWidth/16,height:t-e},this.pageHeight=16*this.fillHeight(this.typePageSize.height),this.$el.height(t+"em"),this.articleInner.height(t+"em"),this._clearPageStyle(),this._setPageStyle()},needFitWindow:function(){return!m.fitForMobile&&"vertical"!==this.layout},needReFitWindow:function(){var t=this.win.height(),e=this.winHeight;return"horizontal"===this.layout&&!m.fitForMobile&&(e!==t||"vertical"===this.prevLayout)},captureTags:function(t){var e=$(t.target);"SUP"===e[0].tagName&&(this.tinyTips=new v,this.tinyTips.set({target:e,hasFormula:this.hasFormula,content:a(_.unescape(e.find(".sup-content").html()))}).update().show())},expandIllus:function(t){if(!m.fitForMobile){var e,i=$(t.currentTarget);i.hasClass("expandable")?S.expandIllus(i):(e=$(t.target).closest(".legend"))&&e.length&&e.find(".text-content").height()>e.height()&&S.expandCaption(i)}},resetTypePage:function(){this.articleInner.html(_.template(this.tmplEmptyPage,{hint:"作品载入中，请稍候 ..."})).css({left:0,right:"auto"})},preRenderTypePage:function(){if("vertical"===this.config.get("layout")){var t=this.config.getPageHeightEm(),e=i.getModel("turning").get("totalPage");this.articleInner.height(t*e+"em")}},_setPageStyle:function(){if(!$("#page-style").length){var t=this.typePageSize.height,e=this.fillHeight(t)+"em",i=t+"em",n="\t            .page { height: pageHeight }\t            .page .bd { height: contentHeight }\t          ".replace("pageHeight",i).replace("contentHeight",e),o=$('<style id="page-style">'+n+"</style>");o.appendTo("head")}},_clearPageStyle:function(){$("#page-style").remove()},_trackGAEvent:function(){function t(){return this.isSample?"sample":this.isGift?"gift":i.getModel("article").get("price")?"paid":"free"}r.post("/j/currtime").done(_.bind(function(e){e=0|e,x._trackEvent(t()+"-open",(e-this.purchaseTime|0)/86400|0)},this))}});return B}.apply(e,n),!(void 0!==o&&(t.exports=o))},function(t,e,i){var n;n=function(){var t={VERTICAL_SCROLLING_DEBOUNCE_LATER:150,READER_INNER_PADDING_EM:5};return{reading:t,allowSelectionParagraphSelector:".paragraph, .headline, .uli, .oli"}}.call(e,i,e,t),!(void 0!==n&&(t.exports=n))},function(t,e,i){var n,o;n=[i(6),i(61),i(119)],o=function($,t,e){function i(i,n){$(n).find(i).each(function(i,o){o=$(o);var r=new t(o,n);new e({purchaseWidget:r,button:o.find('[data-action="purchase"]')})})}return i}.apply(e,n),!(void 0!==o&&(t.exports=o))},function(t,e,i){var n,o;n=[i(6),i(12)],o=function($,t){function e(t){this.purchaseWidget=t.purchaseWidget,this.purchaseEl=this.purchaseWidget._el,this.button=t.button,this.tmplBoughtButton=$("#tmpl-bought-button").html(),this.origButtonHtml=this.button.html(),this.proxyMethods(),this.bindButton(),this.bindPurchase()}return $.extend(e.prototype,{bindButton:function(){var t=this;this.button.on("click",function(e){"#"===t.button.attr("href")&&e.preventDefault(),t.purchaseWidget.doPurchase()})},bindPurchase:function(){this.purchaseEl.on("checkBalance:start",this.onLoading),this.purchaseEl.on("purchase:success",this.onSuccess),this.purchaseEl.on("checkBalance:failed purchase:failed",this.onFailed)},proxyMethods:function(){var t=this,e=["onLoading","onSuccess","onFailed"];$.each(e,function(e,i){t[i]=$.proxy(t[i],t)})},onLoading:function(){this.button.html("购买中...")},onSuccess:function(){this.button.parent().html(t(this.tmplBoughtButton,{url:this.purchaseWidget.getReaderUrl(),isLargeBtn:this.purchaseWidget.isLargeBtn()}))},onFailed:function(){this.button.html(this.origButtonHtml)}}),e}.apply(e,n),!(void 0!==o&&(t.exports=o))},function(t,e,i){var n,o;n=[i(3)],o=function(_){function t(t){this.partConvert=new e(_.extend({typeset:this},t))}function e(t){this.typeset=t.typeset,t.autoSpacing&&(this.plaintext=function(t){return a.test(t)&&(t=t.replace(s,"$1 $2").replace(r,"$1 $2")),_.escape(t)})}var i=function(t,e,i){_.each(t,function(t){e.apply(this,t)},i||this)},n="([぀-ㄯ㈀-㋿㐀-䶿一-鿿豈-﫿])",o="([a-z0-9])",r=new RegExp(o+n,"ig"),s=new RegExp(n+o,"ig"),a=/[a-z0-9]/i;return _.extend(e.prototype,{plaintext:function(t){return _.escape(t)},code:function(){return(/webkit/i.test(navigator.userAgent)?"<wbr>":"")+'<code class="code-inline">'+this.typeset.convertParts.apply(this.typeset,arguments)+"</code>"},footnote:function(t,e){return e&&(e=_.intersection(e,["emphasize"])),e&&e.length||(e=["emphasize"]),'<sup><span class="sup-content">'+this.typeset.convertParts.apply(this.typeset,arguments)+"</span></sup>"},link:function(t,e,i){return"<a class='hypertext' href=\""+_.escape(i.url)+'" target="_blank">'+this.typeset.convertParts.apply(this.typeset,arguments)+"</a>"},latex:function(t){return Ark.features["reader/katex"]?'<span class="mathjax-container">'+_.escape(t)+"</span>":'<span class="mathjax-container">\\('+_.escape(t)+"\\)</span>"}}),i([["regular_script","i","regularscript"],["strikethrough","del"],["emphasize","em"]],function(t,i,n){n||(n=t);var o=_.template('<{{- tagName}} class="{{- tagClassName}}">',{tagName:i,tagClassName:n}),r=_.template("</{{- tagName}}>",{tagName:i});e.prototype[t]=function(){return o+this.typeset.convertParts.apply(this.typeset,arguments)+r}}),_.extend(t.prototype,{convertParts:function(t,e){return this.convertIterator(t,function(t){return e&&!_.contains(e,t.kind)?this.convertOnlyText(t):this.partConvert[t.kind](t.content,e,t)},this)},convertOnlyText:function(t){return this.convertIterator(t,function(t){return _.isString(t.content)?this.partConvert.plaintext(t.content):this.convertOnlyText(t.content)},this)},convertIterator:function(t,e,i){return i=i||this,_.isString(t)?i.partConvert.plaintext(t):(_.isUndefined(t.kind)||(t=[t]),_(t).map(function(t){return e.call(i,t)}).join(""))},transformLegend:function(t){var e=t.data,i=this;!e.legend&&e.full_legend&&(e.legend=e.full_legend),delete e.full_legend,_.each(["legend","full_legend"],function(t){_.isUndefined(e[t])||(_.isString(e[t])&&(e[t]=[{data:{text:e[t]},type:"paragraph"}]),_.each(e[t],function(t){t.data.text=i.convertParts(t.data.text)}))})},transformParas:function(t){return _.isArray(t)||(t=[t]),_.each(t,function(t){var e=t.data;t.data&&("illus"===t.type?this.transformLegend(t):_.isUndefined(e.text)||(e.text=this.convertParts(t.data.text)))},this),t}}),t}.apply(e,n),!(void 0!==o&&(t.exports=o))},function(t,e,i){var n,o;n=[i(6),i(2),i(3),i(21),i(22),i(139),i(145),i(146),i(122),i(154),i(124),i(183),i(32),i(180),i(175)],o=function($,t,_,e,i,n,o,r,s,a,l,h,c,d,u){var p=t.View.extend({el:".article .inner",tmplParagraph:$("#tmpl-paragraph").html(),initialize:function(t){_.bindAll(this,"updateVerticalPreload"),this.app=t.app,this.vent=t.vent,this.config=i.getModel("config"),this.pages=[],this.markingTips=new d,c.fitForDesktop&&(i.vent.on("model:content:set",this.createMarkingsCollection,this),i.vent.on("searchResult:jumped",this.highlightSearchWord,this),i.vent.on("searchBox:closed",this.clearHighlightSearchWord,this),this.createSelectionManager(),this.createArticleMarkingManager()),i.vent.on("model:article:set",this.addSampleTip,this).on("model:article:set",this.addTmplDefalultData,this),this.listenTo(this.config,"goto:stamp",this.jumpStamp),this.on("pages:rendered",this.markCurrPage,this),$(window).off("resize.preload").on("resize.preload",_.debounce(this.updateVerticalPreload,200)),this.updateVerticalPreload()},markCurrPage:function(){this.$(".curr-page").removeClass("curr-page");var t=this.getCurrPage();t&&t.$el.addClass("curr-page")},addSampleTip:function(t){t.get("hasAdded")||t.on("change:hasAdded",function(t,e){e&&this.$(".lnk-collect").remove()},this)},addTmplDefalultData:function(t){this.defaultData=_.defaults({getParaHtml:u},t.attributes)},empty:function(){this.pages=[],this.removeAllSubView()},jumpStamp:function(t){var e=h.getByStamp(t),n=e&&e.pagination;i.getModel("turning").setCurrPage(n)},createPage:function(t){var e=i.getModel("article"),n=i.getModel("content"),o=e.get("hasAdded"),s=this.addSubView(new r({data:_.defaults({page:t,hasAdded:o},this.defaultData),markingTips:this.markingTips,content:n}));return s},getCurrPage:function(){for(var t,e=0,i=this.pages.length;e<i;e++)if(t=this.pages[e],this.pages[e].isCurrPage())return t},render:function(t){t=t||{},t.layout=t.layout||"horizontal";var e;return e="horizontal"===t.layout?this.getHorizontalPages():this.getVerticalPages(),e&&e.length||(e=[{}]),this.renderPages(e),this},getHorizontalPages:function(){var t=i.getModel("turning"),e=t.get("currPage");return this.getPreloadPages(e,1)},renderAllPagesThreshold:20,getVerticalPages:function(){var t=i.getModel("turning"),n=t.get("currPage"),o=t.get("totalPage");return o<=this.renderAllPagesThreshold||"c"===e.works.type?i.getModel("content").getPages():this.getPreloadPages(n,this.verticalPreloadCounts)},verticalPreloadCounts:2,updateVerticalPreload:function(){var t=document.body.clientHeight,e=this.config.get("pageHeight");this.verticalPreloadCounts=Math.ceil(t/e),this.verticalPreloadCounts!==this._preVerticalPreloadCounts&&"vertical"===this.config.get("layout")&&this.trigger("preloadCountChanged",this.verticalPreloadCounts,this._preVerticalPreloadCounts),this._preVerticalPreloadCounts=this.verticalPreloadCounts},getPreloadPages:function(t,e){e=e||1;var n=i.getModel("content"),o=Math.max(0,t-e-1),r=t+e;return n.getPages(o,r)},renderPages:function(t){var e=[],i=[],n=[],o=_.pluck(this.pages,"pagination");if(_.each(t,function(t){var i=_.indexOf(o,t.pagination);i!==-1?n.push(this.pages[i]):e.push(this.createPage(t).render())},this),i=_.difference(this.pages,n),_.each(i,function(t){t.$el.hide().removeClass(),_.defer(_.bind(t.remove,t))}),this.pages=_.sortBy(n.concat(e),function(t){return t.pagination}),e.length){var r=document.createDocumentFragment();_.each(e,function(t){r.appendChild(t.el)},this);var s;s=n.length?n[0].pagination<e[0].pagination?"append":"prepend":"append",this.$el[s](r)}this.trigger("pages:rendered",e),_.each(e,function(t){t.trigger("page:appended")})},createMarkingsCollection:function(t){var e=i.getModel("article"),o=new n([],{articleId:e.id,contentModel:t});i.vent.trigger("markings:created",o),e.markings=o},createArticleMarkingManager:function(){this.articleMarkingManager=new a({pages:this.pages,pagesManager:this,markingTips:this.markingTips})},createSelectionManager:function(){this.selectionManager=new s({el:this.el,pagesManager:this})},highlightClassName:"search-word",clearHighlightSearchWord:function(){$("."+this.highlightClassName).removeClass(this.highlightClassName)},highlightSearchWord:function(t){if(this.clearHighlightSearchWord(),this.pages&&t){var e=_.filter(this.pages,function(e){return _.indexOf(t.paginations,e.pagination)!==-1});e.length||this.once("pages:rendered",_.bind(this.highlightSearchWord,this,t)),_.each(e,function(e){var i=e.parasMap[t.paragraph.pid],n=t.startOffset,o=t.endOffset,r=i.find("[data-offset="+n+"]").index(),s=i.find("[data-offset="+o+"]").index(),a=i.find("span");if(r===-1||s===-1){var l=a.map(function(t,e){return $(e).data("offset")});r===-1&&(r=_.sortedIndex(l,n)-1),s===-1&&(s=_.sortedIndex(l,o))}var h=i.find("span").slice(r,s);h.addClass(this.highlightClassName)},this)}}});return _.extend(p.prototype,o),p}.apply(e,n),!(void 0!==o&&(t.exports=o))},function(t,e,i){var n,o;n=[i(6),i(2),i(3),i(22),i(41),i(123),i(125),i(138)],o=function($,t,_,e,i,n,o,r){var s=t.View.extend({initialize:function(t){this.pagesManager=t.pagesManager,this.tip=t.pagesManager.markingTips,this.tinyPagination=(new r).render(),this.body=$("body"),this.win=$(window),this.on("clear:selection",this.clearSelection,this),this.on("underline",this.convertToUnderline),this.on("del",this.splitUnderline),e.vent.on("markings:created",function(t){this.collection=t},this)},events:{"mousedown .page":"beginSelection"},setBoxInfo:function(){var t=this.$el.parent(),i=t.offset(),n=e.getModel("config").get("layout"),o=parseInt(t.find(".page").css("padding-left"),10),r=5;this.boxInfo={top:i.top,left:i.left+o,right:i.left+t.innerWidth()-o,bottom:"horizontal"===n?i.top+t.height()-r:this.win.height()}},findStartPointFromEvent:function(t){var e=$(t.target),i=null;return e.hasClass("word")&&(i=e),i},useNativeSelection:function(t){var e=$(t.target).closest("p"),i=e.attr("class"),n=/code|custom/gi;return e.length&&n.test(i)},selectionDisabled:function(t){var e=!!$(t.currentTarget).hasClass("selection-disabled"),i=$(t.target).closest("p");return e||i.length&&i.hasClass("illus")},beginSelection:function(t){if(!this.useNativeSelection(t)&&!this.selectionDisabled(t)){t.preventDefault(),this.trigger("clear:selection"),this.setBoxInfo();var e=n(t,this.boxInfo);if(e){var i=this.getInfoFromPoint(e.word,e.mouseCoord);if(i){this.firstPointInfo=i;var o=this.body,r=this,s=$.proxy(this.createSelectionBtns,this);o.addClass("is-selecting"),this.tinyPagination.enable(),o.on("onmousewheel"in document?"mousewheel.create-selection":"DOMMouseScroll.create-selection",function(t){t.preventDefault()}),o.on("mousemove.create-selection",$.proxy(this.moveSelection,this)).on("mouseup.create-selection",function(t){o.removeClass("is-selecting"),r.tinyPagination.disable(),o.off(".create-selection"),r.pagesManager.trigger("stopRender:selection",this.model),r.model&&r.model.isValid()?(s(t),_.defer(function(){o.on("click.clear-selection",function(){r.trigger("clear:selection")})})):r.tip.hide()})}}}},createSelectionBtns:function(t){var e=this.tip,i=["underline","note","sharing","copy","debug","open","translate"],n=this.relocatePoint(this.secondPointInfo);this.checkSubset()&&(i[0]="del");var r=new o({model:this.model,selectionManager:this,container:e,btnList:i});e.set({target:n.point,content:r.render().el,className:"btns-tip",arrowHeight:5,preferedDirection:this.isSelectingDown()&&!this.isSingleLine()?"down":"up"}).show()},checkSubset:function(){var t=this.collection.filter(function(t){return t.isUnderline()});return _.any(t,function(t){return this.checkSingleSubset(t,this.model)},this)},checkSingleSubset:function(t,e){var i=t.getRanges(),n=e.getRanges(),o=_.all(n,function(t,e){return e in i&&(i[e].start<=t.start&&i[e].end>=t.end)});return o&&(this.containerModel=t),o},splitUnderline:function(){if(this.containerModel){var t=this.containerModel.getPoints(),e=_.clone(this.info);t.start.containerId===e.start.containerId&&t.start.offset>=e.start.offset?this.containerModel.destroy():(e.start.offset-=1,this.containerModel.setViaPoints(t.start,this.info.start),this.containerModel.save()),t.end.containerId===e.end.containerId&&t.end.offset<=e.end.offset?this.clearSelection():(e.end.offset+=1,this.model.setViaPoints(this.info.end,t.end),this.convertToUnderline()),this.containerModel=null}},moveSelection:_.throttle(function(t){try{t.preventDefault()}catch(e){}var i,o=n(t,this.boxInfo,this.firstPointInfo);o&&(i=this.getInfoFromPoint(o.word,o.mouseCoord),i&&(this.prevResultWord&&this.prevResultWord===i.point||(this.prevResultWord=i.point,this.secondPointInfo=i,this.currentPointIsStart=o.currentPointIsStart,this.info=this.getPointsInfoOrderByPosition(),this.renderSelection(this.info))))},10),getPointsInfoOrderByPosition:function(){var t=_.clone(this.relocatePoint(this.firstPointInfo)),e=_.clone(this.relocatePoint(this.secondPointInfo)),i={start:t,end:t};return i[this.currentPointIsStart?"start":"end"]=e,i.end.offset=i.end.offset+i.end.length-1,i},getInfoFromPoint:function(t,e){if(t&&t.length){var i=t.closest("p"),n=t.data("offset"),o=t.data("length"),r=i.data("pid")+"",s=i.closest(".page"),a=s.data("pagination"),l=t[0].getBoundingClientRect(),h=s[0].getBoundingClientRect(),c={top:l.top-h.top,bottom:l.bottom-h.top,left:l.left-h.left,right:l.right-h.left};return{offset:n,paragraph:i,containerId:r,pageId:a,viewportOffset:l,offsetToPage:c,point:t,length:o,mouseCoord:e}}},relocatePoint:function(t){function e(){return u?this.getInfoFromPoint(h,l)||t:t}function i(){return u?t:this.getInfoFromPoint(c,l)||t}if(t.length>1)return t;var n=this.isSelectingDown(t),o=this.isFirstPoint(t),r=t.paragraph,s=t.offset,a=t.viewportOffset,l=t.mouseCoord,h=r.find("[data-offset="+(s-1)+"]"),c=r.find("[data-offset="+(s+1)+"]"),d=(a.left+a.right)/2,u=l.x<d;return e=_.bind(e,this),i=_.bind(i,this),n?o?i():e():o?e():i()},isSelectingDown:function(){return this.isFirstPoint(this.secondPointInfo)?this.secondPointInfo.mouseCoord.x>this.firstPointInfo.mouseCoord.x:!this.currentPointIsStart},isFirstPoint:function(t){return t.point===this.firstPointInfo.point},isSingleLine:function(){return this.firstPointInfo.viewportOffset.top===this.secondPointInfo.viewportOffset.top},renderSelection:function(t){this.getModel(t)},clearSelection:function(){this.body.off(".clear-selection"),this.tip.hide(),this.tip.find("textarea").blur(),this.model&&this.model.destroy()},getEmptyModelAttr:function(){return{middleContainers:[],type:"selection"}},getModel:function(t){if(!this.model){var n=e.getModel("content").getParasIndexs(),o=e.getModel("article").id;this.model=new i({type:"selection"},{articleId:o,paragraphsIndex:n}),this.model.on("destroy",function(){this.model=null},this),this.pagesManager.trigger("render:selection",this.model)}return this.model.setViaPoints(t.start,t.end)},convertToNote:function(t,e){this.convertTo("note",{note:t,visible_private:e.visible_private},e)},convertToUnderline:function(){this.convertTo("underline")},convertTo:function(t,e,i){this.model&&(this.collection.addFromSelection(this.model,t,e,i),this.model.destroy())},unbindAll:function(){this.stopListening(),this.undelegateEvents()}});return s}.apply(e,n),!(void 0!==o&&(t.exports=o))},function(t,e,i){var n,o;n=[i(6),i(2),i(3),i(117),i(124)],o=function($,t,_,e,i){var n=e.allowSelectionParagraphSelector,o=n+", .word",r={elementFromPoint:function(t){return $(document.elementFromPoint(t.x,t.y))},clientOffset:function(t){var e=t[0].getBoundingClientRect();return{x:e.left,y:e.top}},isPointInsideRect:function(t,e){var i=e.x,n=e.y;if(i>=t.left&&i<=t.right&&n>=t.top&&n<=t.bottom)return!0},moveCoordToRect:function(t,e){var i=e.x;i>t.right?i=t.right-1:i<t.left&&(i=t.left+1);var n=e.y;return n<t.top?n=t.top+1:n>t.bottom&&(n=t.bottom-1),{x:i,y:n}}},s=function(t,e,i){this.wrapperRect=e,this.currentPointIsStart=!1,this.firstPoint=i,this.setCoord({x:t.clientX,y:t.clientY}),this.find=this.findPoint,this.firstPoint||(this.getCurrentPointIsStart=$.noop)},a={};return a.detectCoordFuncs={isPointInsideParagraph:function(){var t=r.elementFromPoint(this.coord);if(t.is(".marking")||t.hasClass("word")||t.hasClass("code-inline"))return!0;var e=t;return!!((t.is(n)||(e=t.closest(n))&&e.length>0)&&e[0].firstChild&&$.trim(e.text()))||void 0},isPointInsidePage:function(){return r.isPointInsideRect(this.wrapperRect,this.coord)}},a.manipCoordFuncs={moveCoordToPage:function(){this.setCoord(r.moveCoordToRect(this.wrapperRect,this.coord))},moveCoordToPara:function(){var t=this.getCurrentPointIsStart(),e=this.point,i=e.is(".page")?e:e.closest(".page");i.is(".page")&&i.length||(i=$(".page").first());for(var o,r=i.find(n);!r.length&&(i=i[t?"next":"prev"](".page"))&&i.length;)r=i.find(n);do o=this.paraInSelection(i,r);while(!o&&(i=i[t?"next":"prev"](".page"))&&i.length&&(r=i.find(n)));o&&this.setCoord({x:this.coord.x,y:t?o.top:o.bottom})},paraInSelection:function(t,e){var i,n=this.currentPointIsStart,o=this.coord,r=t.find(".bd")[0].getBoundingClientRect();return n||(e=$(e.get().reverse())),e.each(function(){var t=this.getBoundingClientRect(),e=t.top<r.top?r.top:t.top,s=t.bottom>r.bottom?r.bottom:t.bottom;if(e+=1,s-=1,$.trim(this.innerHTML)&&(n&&e>o.y||!n&&s<o.y))return i={top:e,bottom:s},!1}),i},setCoord:function(t){this.coord=t,this.point=r.elementFromPoint(this.coord)},getCurrentPointIsStart:function(){var t,e,i=this.firstPoint.offsetToPage,n=this.point.closest(".page"),o=n[0].getBoundingClientRect(),r={y:this.coord.y-o.top,x:this.coord.x-o.left};if(e=+n.data("pagination"),t=e-this.firstPoint.pageId,0!==t)return this.currentPointIsStart=t<0,this.currentPointIsStart;var s=r.y<i.top||r.x<i.left&&r.y<i.bottom;return this.currentPointIsStart=s,this.currentPointIsStart}},a.findPointFromParaFuncs={findPointFromPara:function(){var t=this.fetchWord();if(t)return t;var e=this.point,i=e.is(n)?e:e.closest("p");if($.trim(i.text())&&i.is(n)&&!$.nodeName(e[0],"sup")){var o,s,a=this.buildLineInfoFromPara(i),l=i[0].getBoundingClientRect(),h=this.coord.x-l.left,c=this.coord.y-l.top;$.each(a.index.top,function(t,e){if(e>c){var i=a.index.bottom[t-1];return o=i&&i>=c?t-1:t,!1}}),_.isUndefined(o)&&(o=a.lines.length-1);var d=a.lines[o];$.each(d,function(t,e){if(e.left>h)return t=t>0?t-1:t,s=d[t],!1}),_.isUndefined(s)&&(s=d[d.length-1]);var u,p=s.span;
return this.word=$(p),u=s.lineBreak?p.getClientRects()[0]:p.getBoundingClientRect(),this.coord=r.moveCoordToRect(u,this.coord),this.word}},buildLineInfoFromPara:i,getParaHeaderRect:function(t,e){var i=e[0].getBoundingClientRect();return{top:t.top,right:i.right,bottom:i.bottom,left:t.left,height:i.bottom-t.top,width:i.right-t.left,spanBCR:i}},getParaFooterRect:function(t,e,i){var n=e[0].getBoundingClientRect(),o={top:n.top,right:t.right,bottom:t.bottom,left:n.left,height:n.top-t.bottom,width:t.right-n.right,spanBCR:n};return i.length>1?(o.top=i[i.length-2].top,o.height=o.top-t.bottom):(o.top=t.top,o.height=t.bottom-t.top),o}},_.extend(s.prototype,{findPoint:function(){try{this.isPointInsidePage()||this.moveCoordToPage(),this.isPointInsideParagraph()||this.moveCoordToPara(),this.findPointFromPara()}catch(t){if(!this.point.is(o))return;throw t}return this.getFindResult()},getFindResult:function(){if(this.word){var t={word:this.word};return this.firstPoint&&(t.currentPointIsStart=this.getCurrentPointIsStart()),t.mouseCoord=this.coord,t}},fetchWord:function(){var t=this.point;return t.hasClass("word")?(this.word=t,this.word):t.hasClass("code-inline")?(this.word=t.parent(),this.word):t.is(".marking")?(this.word=this.getPointUnderMarking(),this.word):void 0},getPointUnderMarking:function(){var t,e=$(),i=this.point;if(i.is(".marking")){do i.hide(),e=e.add(i),i=r.elementFromPoint(this.coord);while(i.is(".marking"));return i.hasClass("word")?t=i:i.hasClass("code-inline")&&(t=i.parent()),e.show(),t}}}),_.each(a,function(t){_.extend(s.prototype,t)}),function(t,e,i){var n=new s(t,e,i);return n.find()}}.apply(e,n),!(void 0!==o&&(t.exports=o))},function(t,e,i){var n,o;n=[i(6),i(3)],o=function($,_){function t(t,e){function i(t,e,i){p=e,o.lines[++f]=[],o.index.top[f]=p.top,o.index.bottom[f]=p.bottom,o.index.offset[f]=+t.getAttribute("data-offset"),i&&(o.index.lineBreak[f]=!0)}function n(t,e,n){_.each(n,function(n,r){var s={top:n.top-u.top,left:n.left-u.left,width:n.width,height:n.height,span:e,lineBreak:!0};if(!p||p.bottom<s.top){var a={top:s.top,bottom:s.top+s.height};i(t,a,r>0)}var l=o.lines[f];l.push(s)})}e=e?e:t;var o,r=t[0],s=r.offsetTop,a=r.offsetLeft,l=r.offsetWidth,h=r.offsetHeight,c=t.find(".word"),d=e?e.find(".word"):c,u=t[0].getBoundingClientRect();o={lines:[],index:{top:[],bottom:[],offset:[],lineBreak:{}},height:h,width:l};var p,f=-1;return c.each(function(t){var e=this,r=e.offsetTop-s,l=e.offsetLeft-a,h=r+e.offsetHeight,c=e.offsetWidth,u=e.offsetHeight,g=e.getClientRects();if(g.length>1)return n(e,d[t],g);if(!p||p.bottom<r){var m={top:r,bottom:r+u};i(e,m)}p.top>r?p.top=r:p.bottom<h&&(p.bottom=h);var v=o.lines[f],y={top:r,left:l,width:c,height:u,span:d[t]};v.push(y)}),o}return function(e,i){i=_.defaults(i||{},{"class":"fake-article"});var n=e.data("info");if(n)return n;var o=e.clone(),r=$("<div>",i).addClass("build-line-info-container"),s=$("<div>",{"class":"content"});return r.append(s).appendTo("body"),s.html(o),n=t(o,e),r.remove(),e.data("info",n),n}}.apply(e,n),!(void 0!==o&&(t.exports=o))},function(t,e,i){var n,o;n=[i(6),i(2),i(3),i(21),i(126),i(135),i(50)],o=function($,t,_,e,i,n,o){var r=i.extend({_super:i.prototype,initialize:function(t){this._super.initialize.call(this,t),this.selectionManager=t.selectionManager},underline:function(t){t.stopPropagation(),this.selectionManager.trigger("underline"),this.clear()},del:function(){this.selectionManager.trigger("del"),this.clear()},note:function(){var t=this;this.createFormInTip(n,{model:this.model,type:"create"},{done:function(e){var i=!0,n=e.pickAttrs("sharing",i),o=e.get("text");t.selectionManager.convertToNote(o,{sharing:n,visible_private:e.get("visible_private")})}})},clear:function(){this.selectionManager.trigger("clear:selection")}}),s=function(){o.openLoginAndSignup({actions:{stamp:this.model.getStamp()}})},a={};return e.me.isAnonymous&&_.each(["note","underline","sharing","debug"],function(t){a[t]=s}),_.extend(r.prototype,a),r}.apply(e,n),!(void 0!==o&&(t.exports=o))},function(t,e,i){var n,o;n=[i(6),i(2),i(3),i(127),i(129),i(130),i(131),i(132)],o=function($,t,_,e,i,n,o,r){var s=t.View.extend({className:"action-list",tagName:"ul",tmplButton:_.template('<li class="action-{{=klass}}"><button class="{{=klass}}">{{=name}}</button>'),btns:{underline:"划线",del:"取消划线",note:"批注",sharing:"分享",debug:"纠错",copy:"复制",open:"打开",translate:"翻译"},events:{"click .underline":"underline","click .note":"note","click .debug":"debug","click .sharing":"sharing","click .del":"del","click .open":"open","click .translate":"translate"},initialize:function(t){var e=this;this.btnList=t.btnList.filter(function(t){return"open"===t?e.model.plainTextIsUrl():"translate"!==t||e.model.plainTextIsEnglish()}),this.container=t.container},render:function(){var t=this.tmplButton,e=this.btns,i=this;return _.each(this.btnList,function(n){i.$el.append(t({klass:n,name:e[n]}))}),this.createCopyBtn(),this},underline:$.noop,del:$.noop,sharing:function(){this.createFormInTip(n,{model:this.model,isNote:this.model.isNote(),url:"/j/share/rec_works_piece",extraParam:{annotation:JSON.stringify(this.model.toJSON()),works_id:this.model.articleId}})},debug:function(){this.createFormInTip(i,{model:this.model})},open:function(){var t=$.trim(this.model.getTextFromRanges());window.open(t)},translate:function(){this.createFormInTip(o,{text:$.trim(this.model.getTextFromRanges())})},note:$.noop,createFormInTip:function(t,i,n){n||(n={});var o=e(this.container,t,i,{autoClose:!0}),r=o.promise;return n.done&&r.done(n.done),r.always(_.bind(this.clear,this)),this.remove(),o},clear:function(){this.container.hide()}});return _.extend(s.prototype,r),s}.apply(e,n),!(void 0!==o&&(t.exports=o))},function(t,e,i){var n,o;n=[i(6),i(2),i(3),i(128)],o=function($,t,_,e){var i={useFormStyle:function(t){t.setClass("bubble-form"),i.updateTipPosition(t)},updateTipPosition:function(t){var e=10;t.update(e)}};return function(t,n,o,r){r||(r={});var s=new n(o);t.setContent(s.render().el),t.set({preferedDirection:t.preferedDirection,arrowHeight:10}),t.show(),i.useFormStyle(t),r.autoClose&&s.promise&&s.promise.always(function(){t.hide()}),s.on("updated",function(){i.updateTipPosition(t)}),s.$el.on("removing",function(){s.stopListening()});var a=t.find("textarea").focus();return a.length&&e.collapseToEnd(a[0]),s}}.apply(e,n),!(void 0!==o&&(t.exports=o))},function(t,e,i){var n,o;n=[],o=function(){var t={},e=document,i=function(t){if(e.selection){t.focus();var i=e.selection,n=i.createRange(),o=n.duplicate();return o.moveToElementText(t),o.setEndPoint("EndToEnd",n),t.selectionStart=o.text.length-n.text.length,t.selectionStart}return t.selectionStart},n=function(t,i,n){if(e.selection){var o=t.createTextRange();o.moveEnd("character",-t.value.length),o.moveEnd("character",n),o.moveStart("character",i),o.select()}else t.setSelectionRange(i,n),t.focus()},o=function(t,e){n(t,e,e)},r=function(t,i){t.value;if(e.selection)t.focus(),e.selection.createRange().text=i;else{var n=t.selectionStart,r=t.value.length;t.value=t.value.slice(0,n)+i+t.value.slice(n,r),o(t,n+i.length)}},s=function(t,e){var n=i(t),r=t.value;t.value=e>0?r.slice(0,n-e)+r.slice(n):r.slice(0,n)+r.slice(n-e),o(t,n-(e<0?0:e))},a=function(t){if(e.selection){var i=t.createTextRange();i.moveToElementText(t),i.collapse("false"),i.select()}else{var n=t.value.length;t.setSelectionRange(n,n),t.focus()}};return t={get:i,set:o,insert:r,remove:s,collapseToEnd:a}}.apply(e,n),!(void 0!==o&&(t.exports=o))},function(t,e,i){var n,o;n=[i(6),i(2),i(3),i(60),i(33),i(98)],o=function($,t,_,e,i,n){var o=t.Model.extend({defaults:{annotation:""},initialize:function(t,e){this.articleId=e.articleId},url:function(){return"/j/article_v2/"+this.articleId+"/erratum"}}),r=t.View.extend({tmplHtml:$("#tmpl-debug-form").html(),tagName:"form",className:"debug-form",initialize:function(t){this.dfd=$.Deferred(),this.promise=this.dfd.promise()},events:{submit:"submitDebugForm","click .ln-cancel":"cancelForm"},cancelForm:function(t){t.preventDefault(),this.dfd.reject()},submitDebugForm:function(t){t.preventDefault();var n=$(t.target),r=n.find("textarea[name=text]").val(),s=this.model.toJSON();s.note=r;var a=new o({annotation:JSON.stringify(s)},{articleId:this.model.articleId});a.save({},{success:function(){e.toast("非常感谢！纠错意见已成功发送"),i._trackEvent("errorCorr")},error:function(){e.toast("纠错失败")}}),this.dfd.resolve(a)},render:function(){return this.$el.html(this.tmplHtml),n.ctrlEnterForm(this.$el),this}});return r}.apply(e,n),!(void 0!==o&&(t.exports=o))},function(t,e,i){var n,o;n=[i(6),i(2),i(3),i(97)],o=function($,t,_,e){return e.extend({onAddCommentAttr:function(){this.model.addCommentNum(1)}})}.apply(e,n),!(void 0!==o&&(t.exports=o))},function(t,e,i){var n,o,r=Object.assign||function(t){for(var e=1;e<arguments.length;e++){var i=arguments[e];for(var n in i)Object.prototype.hasOwnProperty.call(i,n)&&(t[n]=i[n])}return t};n=[i(6),i(2),i(3),i(9)],o=function($,t,_,e){var i="/j/translate",n=/^[.?!\-–'",，。！(]+|[.?!\-–'",，。！)]+$/,o=t.View.extend({tmpl:$("#tmpl-translation").html(),className:"translation-tip",initialize:function(t){var o=this,r=t.text.replace(n,"");e.get(i+"?q="+r).then(function(t){return o.loaded=!0,t.r?o.renderError(t.msg):o.renderContent(t)},function(){return o.renderError("服务器开小差了，请稍后再试")}),this.promise=$.Deferred().promise()},render:function(){return this.loaded?this:(this.$el.html("查询中，请稍候…"),this.trigger("updated"),this)},renderError:function(t){return this.$el.text(t),this.trigger("updated"),this},renderContent:function(t){return this.$el.html(_.template(this.tmpl,r({basic:null},t))),this.trigger("updated"),this}});return o}.apply(e,n),!(void 0!==o&&(t.exports=o))},function(t,e,i){var n,o;n=[i(6),i(2),i(3),i(133),i(60)],o=function($,t,_,e,i){var n=document.queryCommandSupported&&document.queryCommandSupported("copy"),o=$(window),r={createCopyBtn:function(){var t=this,r=this.$el.find(".copy"),s=this.model.getTextFromRanges();if(window.clipboardData)return void r.on("click",function(){var e=window.clipboardData.setData("TEXT",s);i.toast(e?"内容已成功复制到剪贴板":"复制失败，浏览器禁止了复制"),t.clear()});if(n)return void r.on("click",function(){var e=$("<input>").val(s).css({position:"absolute",left:-99999,top:o.scrollTop()+10});e.appendTo(document.body),e.focus().select(),n=document.execCommand("copy"),n&&i.toast("内容已成功复制到剪贴板"),_.defer(function(){e.remove()}),t.clear()});var a=e(r);a.on("ready",function(){a.on("copy",function(){a.setText(s)}).on("aftercopy",function(){i.toast("内容已成功复制到剪贴板"),a.destroy(),t.clear()})}).on("error",function(e){"flash-disabled"===e.name&&r.on("click",function(){prompt("当前浏览器需要安装并启用 Flash 才能使用复制功能，请尝试安装 Flash 或换用其他现代浏览器",s),a.destroy(),t.clear()})})}};return r}.apply(e,n),!(void 0!==o&&(t.exports=o))},function(t,e,i){var n,o;n=[i(6),i(21),i(111),i(60),i(134)],o=function($,t,e,i,n){var o=function(e){return n.config({swfPath:t.ZeroClipboardPath,hoverClass:"is-hover",activeClass:"is-active",trustedDomains:["*"]}),n.on(function(t){switch(t.name){case"flash-disabled":i.toast("复制失败，需要安装或启用 Flash 插件");break;case"clipboard-error":i.toast("复制失败，请重试");break;default:i.toast("复制失败，发生了奇怪的错误")}}),new n(e)};return window.clipboardData||e(t.ZeroClipboardPath),o}.apply(e,n),!(void 0!==o&&(t.exports=o))},function(t,e,i){var n;/*!
	 * ZeroClipboard
	 * The ZeroClipboard library provides an easy way to copy text to the clipboard using an invisible Adobe Flash movie and a JavaScript interface.
	 * Copyright (c) 2009-2014 Jon Rohan, James M. Greene
	 * Licensed MIT
	 * http://zeroclipboard.org/
	 * v2.2.0
	 */
!function(o,r){"use strict";var s,a,l,h=o,c=h.document,d=h.navigator,u=h.setTimeout,p=h.clearTimeout,f=h.setInterval,g=h.clearInterval,m=h.getComputedStyle,v=h.encodeURIComponent,y=h.ActiveXObject,b=h.Error,w=h.Number.parseInt||h.parseInt,x=h.Number.parseFloat||h.parseFloat,P=h.Number.isNaN||h.isNaN,k=h.Date.now,T=h.Object.keys,C=h.Object.defineProperty,M=h.Object.prototype.hasOwnProperty,S=h.Array.prototype.slice,A=function(){var t=function(t){return t};if("function"==typeof h.wrap&&"function"==typeof h.unwrap)try{var e=c.createElement("div"),i=h.unwrap(e);1===e.nodeType&&i&&1===i.nodeType&&(t=h.unwrap)}catch(n){}return t}(),I=function(t){return S.call(t,0)},N=function(){var t,e,i,n,o,s,a=I(arguments),l=a[0]||{};for(t=1,e=a.length;t<e;t++)if(null!=(i=a[t]))for(n in i)M.call(i,n)&&(o=l[n],s=i[n],l!==s&&s!==r&&(l[n]=s));return l},E=function(t){var e,i,n,o;if("object"!=typeof t||null==t||"number"==typeof t.nodeType)e=t;else if("number"==typeof t.length)for(e=[],i=0,n=t.length;i<n;i++)M.call(t,i)&&(e[i]=E(t[i]));else{e={};for(o in t)M.call(t,o)&&(e[o]=E(t[o]))}return e},D=function(t,e){for(var i={},n=0,o=e.length;n<o;n++)e[n]in t&&(i[e[n]]=t[e[n]]);return i},F=function(t,e){var i={};for(var n in t)e.indexOf(n)===-1&&(i[n]=t[n]);return i},B=function(t){if(t)for(var e in t)M.call(t,e)&&delete t[e];return t},L=function(t,e){if(t&&1===t.nodeType&&t.ownerDocument&&e&&(1===e.nodeType&&e.ownerDocument&&e.ownerDocument===t.ownerDocument||9===e.nodeType&&!e.ownerDocument&&e===t.ownerDocument))do{if(t===e)return!0;t=t.parentNode}while(t);return!1},O=function(t){var e;return"string"==typeof t&&t&&(e=t.split("#")[0].split("?")[0],e=t.slice(0,t.lastIndexOf("/")+1)),e},H=function(t){var e,i;return"string"==typeof t&&t&&(i=t.match(/^(?:|[^:@]*@|.+\)@(?=http[s]?|file)|.+?\s+(?: at |@)(?:[^:\(]+ )*[\(]?)((?:http[s]?|file):\/\/[\/]?.+?\/[^:\)]*?)(?::\d+)(?::\d+)?/),i&&i[1]?e=i[1]:(i=t.match(/\)@((?:http[s]?|file):\/\/[\/]?.+?\/[^:\)]*?)(?::\d+)(?::\d+)?/),i&&i[1]&&(e=i[1]))),e},R=function(){var t,e;try{throw new b}catch(i){e=i}return e&&(t=e.sourceURL||e.fileName||H(e.stack)),t},z=function(){var t,e,i;if(c.currentScript&&(t=c.currentScript.src))return t;if(e=c.getElementsByTagName("script"),1===e.length)return e[0].src||r;if("readyState"in e[0])for(i=e.length;i--;)if("interactive"===e[i].readyState&&(t=e[i].src))return t;return"loading"===c.readyState&&(t=e[e.length-1].src)?t:(t=R())?t:r},j=function(){var t,e,i,n=c.getElementsByTagName("script");for(t=n.length;t--;){if(!(i=n[t].src)){e=null;break}if(i=O(i),null==e)e=i;else if(e!==i){e=null;break}}return e||r},V=function(){var t=O(z())||j()||"";return t+"ZeroClipboard.swf"},W=function(){return null==o.opener&&(!!o.top&&o!=o.top||!!o.parent&&o!=o.parent)}(),U={bridge:null,version:"0.0.0",pluginType:"unknown",disabled:null,outdated:null,sandboxed:null,unavailable:null,degraded:null,deactivated:null,overdue:null,ready:null},G="11.0.0",q={},J={},X=null,Y=0,K=0,Z={ready:"Flash communication is established",error:{"flash-disabled":"Flash is disabled or not installed. May also be attempting to run Flash in a sandboxed iframe, which is impossible.","flash-outdated":"Flash is too outdated to support ZeroClipboard","flash-sandboxed":"Attempting to run Flash in a sandboxed iframe, which is impossible","flash-unavailable":"Flash is unable to communicate bidirectionally with JavaScript","flash-degraded":"Flash is unable to preserve data fidelity when communicating with JavaScript","flash-deactivated":"Flash is too outdated for your browser and/or is configured as click-to-activate.\nThis may also mean that the ZeroClipboard SWF object could not be loaded, so please check your `swfPath` configuration and/or network connectivity.\nMay also be attempting to run Flash in a sandboxed iframe, which is impossible.","flash-overdue":"Flash communication was established but NOT within the acceptable time limit","version-mismatch":"ZeroClipboard JS version number does not match ZeroClipboard SWF version number","clipboard-error":"At least one error was thrown while ZeroClipboard was attempting to inject your data into the clipboard","config-mismatch":"ZeroClipboard configuration does not match Flash's reality","swf-not-found":"The ZeroClipboard SWF object could not be loaded, so please check your `swfPath` configuration and/or network connectivity"}},Q=["flash-unavailable","flash-degraded","flash-overdue","version-mismatch","config-mismatch","clipboard-error"],tt=["flash-disabled","flash-outdated","flash-sandboxed","flash-unavailable","flash-degraded","flash-deactivated","flash-overdue"],et=new RegExp("^flash-("+tt.map(function(t){return t.replace(/^flash-/,"")}).join("|")+")$"),it=new RegExp("^flash-("+tt.slice(1).map(function(t){return t.replace(/^flash-/,"")}).join("|")+")$"),nt={swfPath:V(),trustedDomains:o.location.host?[o.location.host]:[],cacheBust:!0,forceEnhancedClipboard:!1,flashLoadTimeout:3e4,autoActivate:!0,bubbleEvents:!0,containerId:"global-zeroclipboard-html-bridge",containerClass:"global-zeroclipboard-container",swfObjectId:"global-zeroclipboard-flash-bridge",hoverClass:"zeroclipboard-is-hover",activeClass:"zeroclipboard-is-active",forceHandCursor:!1,title:null,zIndex:999999999},ot=function(t){if("object"==typeof t&&null!==t)for(var e in t)if(M.call(t,e))if(/^(?:forceHandCursor|title|zIndex|bubbleEvents)$/.test(e))nt[e]=t[e];else if(null==U.bridge)if("containerId"===e||"swfObjectId"===e){if(!bt(t[e]))throw new Error("The specified `"+e+"` value is not valid as an HTML4 Element ID");nt[e]=t[e]}else nt[e]=t[e];{if("string"!=typeof t||!t)return E(nt);if(M.call(nt,t))return nt[t]}},rt=function(){return Kt(),{browser:D(d,["userAgent","platform","appName"]),flash:F(U,["bridge"]),zeroclipboard:{version:Qt.version,config:Qt.config()}}},st=function(){return!!(U.disabled||U.outdated||U.sandboxed||U.unavailable||U.degraded||U.deactivated)},at=function(t,e){var i,n,o,a={};if("string"==typeof t&&t)o=t.toLowerCase().split(/\s+/);else if("object"==typeof t&&t&&"undefined"==typeof e)for(i in t)M.call(t,i)&&"string"==typeof i&&i&&"function"==typeof t[i]&&Qt.on(i,t[i]);if(o&&o.length){for(i=0,n=o.length;i<n;i++)t=o[i].replace(/^on/,""),a[t]=!0,q[t]||(q[t]=[]),q[t].push(e);if(a.ready&&U.ready&&Qt.emit({type:"ready"}),a.error){for(i=0,n=tt.length;i<n;i++)if(U[tt[i].replace(/^flash-/,"")]===!0){Qt.emit({type:"error",name:tt[i]});break}s!==r&&Qt.version!==s&&Qt.emit({type:"error",name:"version-mismatch",jsVersion:Qt.version,swfVersion:s})}}return Qt},lt=function(t,e){var i,n,o,r,s;if(0===arguments.length)r=T(q);else if("string"==typeof t&&t)r=t.split(/\s+/);else if("object"==typeof t&&t&&"undefined"==typeof e)for(i in t)M.call(t,i)&&"string"==typeof i&&i&&"function"==typeof t[i]&&Qt.off(i,t[i]);if(r&&r.length)for(i=0,n=r.length;i<n;i++)if(t=r[i].toLowerCase().replace(/^on/,""),s=q[t],s&&s.length)if(e)for(o=s.indexOf(e);o!==-1;)s.splice(o,1),o=s.indexOf(e,o);else s.length=0;return Qt},ht=function(t){var e;return e="string"==typeof t&&t?E(q[t])||null:E(q)},ct=function(t){var e,i,n;if(t=wt(t),t&&!St(t))return"ready"===t.type&&U.overdue===!0?Qt.emit({type:"error",name:"flash-overdue"}):(e=N({},t),Ct.call(this,e),"copy"===t.type&&(n=Bt(J),i=n.data,X=n.formatMap),i)},dt=function(){var t=U.sandboxed;if(Kt(),"boolean"!=typeof U.ready&&(U.ready=!1),U.sandboxed!==t&&U.sandboxed===!0)U.ready=!1,Qt.emit({type:"error",name:"flash-sandboxed"});else if(!Qt.isFlashUnusable()&&null===U.bridge){var e=nt.flashLoadTimeout;"number"==typeof e&&e>=0&&(Y=u(function(){"boolean"!=typeof U.deactivated&&(U.deactivated=!0),U.deactivated===!0&&Qt.emit({type:"error",name:"flash-deactivated"})},e)),U.overdue=!1,Dt()}},ut=function(){Qt.clearData(),Qt.blur(),Qt.emit("destroy"),Ft(),Qt.off()},pt=function(t,e){var i;if("object"==typeof t&&t&&"undefined"==typeof e)i=t,Qt.clearData();else{if("string"!=typeof t||!t)return;i={},i[t]=e}for(var n in i)"string"==typeof n&&n&&M.call(i,n)&&"string"==typeof i[n]&&i[n]&&(J[n]=i[n])},ft=function(t){"undefined"==typeof t?(B(J),X=null):"string"==typeof t&&M.call(J,t)&&delete J[t]},gt=function(t){return"undefined"==typeof t?E(J):"string"==typeof t&&M.call(J,t)?J[t]:void 0},mt=function(t){if(t&&1===t.nodeType){a&&(Vt(a,nt.activeClass),a!==t&&Vt(a,nt.hoverClass)),a=t,jt(t,nt.hoverClass);var e=t.getAttribute("title")||nt.title;if("string"==typeof e&&e){var i=Et(U.bridge);i&&i.setAttribute("title",e)}var n=nt.forceHandCursor===!0||"pointer"===Wt(t,"cursor");Xt(n),Jt()}},vt=function(){var t=Et(U.bridge);t&&(t.removeAttribute("title"),t.style.left="0px",t.style.top="-9999px",t.style.width="1px",t.style.height="1px"),a&&(Vt(a,nt.hoverClass),Vt(a,nt.activeClass),a=null)},yt=function(){return a||null},bt=function(t){return"string"==typeof t&&t&&/^[A-Za-z][A-Za-z0-9_:\-\.]*$/.test(t)},wt=function(t){var e;if("string"==typeof t&&t?(e=t,t={}):"object"==typeof t&&t&&"string"==typeof t.type&&t.type&&(e=t.type),e){e=e.toLowerCase(),!t.target&&(/^(copy|aftercopy|_click)$/.test(e)||"error"===e&&"clipboard-error"===t.name)&&(t.target=l),N(t,{type:e,target:t.target||a||null,relatedTarget:t.relatedTarget||null,currentTarget:U&&U.bridge||null,timeStamp:t.timeStamp||k()||null});var i=Z[t.type];return"error"===t.type&&t.name&&i&&(i=i[t.name]),i&&(t.message=i),"ready"===t.type&&N(t,{target:null,version:U.version}),"error"===t.type&&(et.test(t.name)&&N(t,{target:null,minimumVersion:G}),it.test(t.name)&&N(t,{version:U.version})),"copy"===t.type&&(t.clipboardData={setData:Qt.setData,clearData:Qt.clearData}),"aftercopy"===t.type&&(t=$t(t,X)),t.target&&!t.relatedTarget&&(t.relatedTarget=xt(t.target)),Pt(t)}},xt=function(t){var e=t&&t.getAttribute&&t.getAttribute("data-clipboard-target");return e?c.getElementById(e):null},Pt=function(t){if(t&&/^_(?:click|mouse(?:over|out|down|up|move))$/.test(t.type)){var e=t.target,i="_mouseover"===t.type&&t.relatedTarget?t.relatedTarget:r,n="_mouseout"===t.type&&t.relatedTarget?t.relatedTarget:r,o=Ut(e),s=h.screenLeft||h.screenX||0,a=h.screenTop||h.screenY||0,l=c.body.scrollLeft+c.documentElement.scrollLeft,d=c.body.scrollTop+c.documentElement.scrollTop,u=o.left+("number"==typeof t._stageX?t._stageX:0),p=o.top+("number"==typeof t._stageY?t._stageY:0),f=u-l,g=p-d,m=s+f,v=a+g,y="number"==typeof t.movementX?t.movementX:0,b="number"==typeof t.movementY?t.movementY:0;delete t._stageX,delete t._stageY,N(t,{srcElement:e,fromElement:i,toElement:n,screenX:m,screenY:v,pageX:u,pageY:p,clientX:f,clientY:g,x:f,y:g,movementX:y,movementY:b,offsetX:0,offsetY:0,layerX:0,layerY:0})}return t},kt=function(t){var e=t&&"string"==typeof t.type&&t.type||"";return!/^(?:(?:before)?copy|destroy)$/.test(e)},Tt=function(t,e,i,n){n?u(function(){t.apply(e,i)},0):t.apply(e,i)},Ct=function(t){if("object"==typeof t&&t&&t.type){var e=kt(t),i=q["*"]||[],n=q[t.type]||[],o=i.concat(n);if(o&&o.length){var r,s,a,l,c,d=this;for(r=0,s=o.length;r<s;r++)a=o[r],l=d,"string"==typeof a&&"function"==typeof h[a]&&(a=h[a]),"object"==typeof a&&a&&"function"==typeof a.handleEvent&&(l=a,a=a.handleEvent),"function"==typeof a&&(c=N({},t),Tt(a,l,[c],e))}return this}},Mt=function(t){var e=null;return(W===!1||t&&"error"===t.type&&t.name&&Q.indexOf(t.name)!==-1)&&(e=!1),e},St=function(t){var e=t.target||a||null,i="swf"===t._source;switch(delete t._source,t.type){case"error":var n="flash-sandboxed"===t.name||Mt(t);"boolean"==typeof n&&(U.sandboxed=n),tt.indexOf(t.name)!==-1?N(U,{disabled:"flash-disabled"===t.name,outdated:"flash-outdated"===t.name,unavailable:"flash-unavailable"===t.name,degraded:"flash-degraded"===t.name,deactivated:"flash-deactivated"===t.name,overdue:"flash-overdue"===t.name,ready:!1}):"version-mismatch"===t.name&&(s=t.swfVersion,N(U,{disabled:!1,outdated:!1,unavailable:!1,degraded:!1,deactivated:!1,overdue:!1,ready:!1})),qt();break;case"ready":s=t.swfVersion;var o=U.deactivated===!0;N(U,{disabled:!1,outdated:!1,sandboxed:!1,unavailable:!1,degraded:!1,deactivated:!1,overdue:o,ready:!o}),qt();break;case"beforecopy":l=e;break;case"copy":var r,h,c=t.relatedTarget;!J["text/html"]&&!J["text/plain"]&&c&&(h=c.value||c.outerHTML||c.innerHTML)&&(r=c.value||c.textContent||c.innerText)?(t.clipboardData.clearData(),t.clipboardData.setData("text/plain",r),h!==r&&t.clipboardData.setData("text/html",h)):!J["text/plain"]&&t.target&&(r=t.target.getAttribute("data-clipboard-text"))&&(t.clipboardData.clearData(),t.clipboardData.setData("text/plain",r));break;case"aftercopy":At(t),Qt.clearData(),e&&e!==zt()&&e.focus&&e.focus();break;case"_mouseover":Qt.focus(e),nt.bubbleEvents===!0&&i&&(e&&e!==t.relatedTarget&&!L(t.relatedTarget,e)&&_t(N({},t,{type:"mouseenter",bubbles:!1,cancelable:!1})),_t(N({},t,{type:"mouseover"})));break;case"_mouseout":Qt.blur(),nt.bubbleEvents===!0&&i&&(e&&e!==t.relatedTarget&&!L(t.relatedTarget,e)&&_t(N({},t,{type:"mouseleave",bubbles:!1,cancelable:!1})),_t(N({},t,{type:"mouseout"})));break;case"_mousedown":jt(e,nt.activeClass),nt.bubbleEvents===!0&&i&&_t(N({},t,{type:t.type.slice(1)}));break;case"_mouseup":Vt(e,nt.activeClass),nt.bubbleEvents===!0&&i&&_t(N({},t,{type:t.type.slice(1)}));break;case"_click":l=null,nt.bubbleEvents===!0&&i&&_t(N({},t,{type:t.type.slice(1)}));break;case"_mousemove":nt.bubbleEvents===!0&&i&&_t(N({},t,{type:t.type.slice(1)}))}if(/^_(?:click|mouse(?:over|out|down|up|move))$/.test(t.type))return!0},At=function(t){if(t.errors&&t.errors.length>0){var e=E(t);N(e,{type:"error",name:"clipboard-error"}),delete e.success,u(function(){Qt.emit(e)},0)}},_t=function(t){if(t&&"string"==typeof t.type&&t){var e,i=t.target||null,n=i&&i.ownerDocument||c,o={view:n.defaultView||h,canBubble:!0,cancelable:!0,detail:"click"===t.type?1:0,button:"number"==typeof t.which?t.which-1:"number"==typeof t.button?t.button:n.createEvent?0:1},r=N(o,t);i&&n.createEvent&&i.dispatchEvent&&(r=[r.type,r.canBubble,r.cancelable,r.view,r.detail,r.screenX,r.screenY,r.clientX,r.clientY,r.ctrlKey,r.altKey,r.shiftKey,r.metaKey,r.button,r.relatedTarget],e=n.createEvent("MouseEvents"),e.initMouseEvent&&(e.initMouseEvent.apply(e,r),e._source="js",i.dispatchEvent(e)))}},It=function(){var t=nt.flashLoadTimeout;if("number"==typeof t&&t>=0){var e=Math.min(1e3,t/10),i=nt.swfObjectId+"_fallbackContent";K=f(function(){var t=c.getElementById(i);Gt(t)&&(qt(),U.deactivated=null,Qt.emit({type:"error",name:"swf-not-found"}))},e)}},Nt=function(){var t=c.createElement("div");return t.id=nt.containerId,t.className=nt.containerClass,t.style.position="absolute",t.style.left="0px",t.style.top="-9999px",t.style.width="1px",t.style.height="1px",t.style.zIndex=""+Yt(nt.zIndex),t},Et=function(t){for(var e=t&&t.parentNode;e&&"OBJECT"===e.nodeName&&e.parentNode;)e=e.parentNode;return e||null},Dt=function(){var t,e=U.bridge,i=Et(e);if(!e){var n=Rt(h.location.host,nt),o="never"===n?"none":"all",r=Ot(N({jsVersion:Qt.version},nt)),s=nt.swfPath+Lt(nt.swfPath,nt);i=Nt();var a=c.createElement("div");i.appendChild(a),c.body.appendChild(i);var l=c.createElement("div"),d="activex"===U.pluginType;l.innerHTML='<object id="'+nt.swfObjectId+'" name="'+nt.swfObjectId+'" width="100%" height="100%" '+(d?'classid="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000"':'type="application/x-shockwave-flash" data="'+s+'"')+">"+(d?'<param name="movie" value="'+s+'"/>':"")+'<param name="allowScriptAccess" value="'+n+'"/><param name="allowNetworking" value="'+o+'"/><param name="menu" value="false"/><param name="wmode" value="transparent"/><param name="flashvars" value="'+r+'"/><div id="'+nt.swfObjectId+'_fallbackContent">&nbsp;</div></object>',e=l.firstChild,l=null,A(e).ZeroClipboard=Qt,i.replaceChild(e,a),It()}return e||(e=c[nt.swfObjectId],e&&(t=e.length)&&(e=e[t-1]),!e&&i&&(e=i.firstChild)),U.bridge=e||null,e},Ft=function(){var t=U.bridge;if(t){var e=Et(t);e&&("activex"===U.pluginType&&"readyState"in t?(t.style.display="none",function i(){if(4===t.readyState){for(var n in t)"function"==typeof t[n]&&(t[n]=null);t.parentNode&&t.parentNode.removeChild(t),e.parentNode&&e.parentNode.removeChild(e)}else u(i,10)}()):(t.parentNode&&t.parentNode.removeChild(t),e.parentNode&&e.parentNode.removeChild(e))),qt(),U.ready=null,U.bridge=null,U.deactivated=null,s=r}},Bt=function(t){var e={},i={};if("object"==typeof t&&t){for(var n in t)if(n&&M.call(t,n)&&"string"==typeof t[n]&&t[n])switch(n.toLowerCase()){case"text/plain":case"text":case"air:text":case"flash:text":e.text=t[n],i.text=n;break;case"text/html":case"html":case"air:html":case"flash:html":e.html=t[n],i.html=n;break;case"application/rtf":case"text/rtf":case"rtf":case"richtext":case"air:rtf":case"flash:rtf":e.rtf=t[n],i.rtf=n}return{data:e,formatMap:i}}},$t=function(t,e){if("object"!=typeof t||!t||"object"!=typeof e||!e)return t;var i={};for(var n in t)if(M.call(t,n))if("errors"===n){i[n]=t[n]?t[n].slice():[];for(var o=0,r=i[n].length;o<r;o++)i[n][o].format=e[i[n][o].format]}else if("success"!==n&&"data"!==n)i[n]=t[n];else{i[n]={};var s=t[n];for(var a in s)a&&M.call(s,a)&&M.call(e,a)&&(i[n][e[a]]=s[a])}return i},Lt=function(t,e){var i=null==e||e&&e.cacheBust===!0;return i?(t.indexOf("?")===-1?"?":"&")+"noCache="+k():""},Ot=function(t){var e,i,n,o,r="",s=[];if(t.trustedDomains&&("string"==typeof t.trustedDomains?o=[t.trustedDomains]:"object"==typeof t.trustedDomains&&"length"in t.trustedDomains&&(o=t.trustedDomains)),o&&o.length)for(e=0,i=o.length;e<i;e++)if(M.call(o,e)&&o[e]&&"string"==typeof o[e]){if(n=Ht(o[e]),!n)continue;if("*"===n){s.length=0,s.push(n);break}s.push.apply(s,[n,"//"+n,h.location.protocol+"//"+n])}return s.length&&(r+="trustedOrigins="+v(s.join(","))),t.forceEnhancedClipboard===!0&&(r+=(r?"&":"")+"forceEnhancedClipboard=true"),"string"==typeof t.swfObjectId&&t.swfObjectId&&(r+=(r?"&":"")+"swfObjectId="+v(t.swfObjectId)),"string"==typeof t.jsVersion&&t.jsVersion&&(r+=(r?"&":"")+"jsVersion="+v(t.jsVersion)),r},Ht=function(t){if(null==t||""===t)return null;if(t=t.replace(/^\s+|\s+$/g,""),""===t)return null;var e=t.indexOf("//");t=e===-1?t:t.slice(e+2);var i=t.indexOf("/");return t=i===-1?t:e===-1||0===i?null:t.slice(0,i),t&&".swf"===t.slice(-4).toLowerCase()?null:t||null},Rt=function(){var t=function(t){var e,i,n,o=[];if("string"==typeof t&&(t=[t]),"object"!=typeof t||!t||"number"!=typeof t.length)return o;for(e=0,i=t.length;e<i;e++)if(M.call(t,e)&&(n=Ht(t[e]))){if("*"===n){o.length=0,o.push("*");break}o.indexOf(n)===-1&&o.push(n)}return o};return function(e,i){var n=Ht(i.swfPath);null===n&&(n=e);var o=t(i.trustedDomains),r=o.length;if(r>0){if(1===r&&"*"===o[0])return"always";if(o.indexOf(e)!==-1)return 1===r&&e===n?"sameDomain":"always"}return"never"}}(),zt=function(){try{return c.activeElement}catch(t){return null}},jt=function(t,e){var i,n,o,r=[];if("string"==typeof e&&e&&(r=e.split(/\s+/)),t&&1===t.nodeType&&r.length>0)if(t.classList)for(i=0,n=r.length;i<n;i++)t.classList.add(r[i]);else if(t.hasOwnProperty("className")){for(o=" "+t.className+" ",i=0,n=r.length;i<n;i++)o.indexOf(" "+r[i]+" ")===-1&&(o+=r[i]+" ");t.className=o.replace(/^\s+|\s+$/g,"")}return t},Vt=function(t,e){var i,n,o,r=[];if("string"==typeof e&&e&&(r=e.split(/\s+/)),t&&1===t.nodeType&&r.length>0)if(t.classList&&t.classList.length>0)for(i=0,n=r.length;i<n;i++)t.classList.remove(r[i]);else if(t.className){for(o=(" "+t.className+" ").replace(/[\r\n\t]/g," "),i=0,n=r.length;i<n;i++)o=o.replace(" "+r[i]+" "," ");t.className=o.replace(/^\s+|\s+$/g,"")}return t},Wt=function(t,e){var i=m(t,null).getPropertyValue(e);return"cursor"!==e||i&&"auto"!==i||"A"!==t.nodeName?i:"pointer"},Ut=function(t){var e={left:0,top:0,width:0,height:0};if(t.getBoundingClientRect){var i=t.getBoundingClientRect(),n=h.pageXOffset,o=h.pageYOffset,r=c.documentElement.clientLeft||0,s=c.documentElement.clientTop||0,a=0,l=0;if("relative"===Wt(c.body,"position")){var d=c.body.getBoundingClientRect(),u=c.documentElement.getBoundingClientRect();a=d.left-u.left||0,l=d.top-u.top||0}e.left=i.left+n-r-a,e.top=i.top+o-s-l,e.width="width"in i?i.width:i.right-i.left,e.height="height"in i?i.height:i.bottom-i.top}return e},Gt=function(t){if(!t)return!1;var e=m(t,null),i=x(e.height)>0,n=x(e.width)>0,o=x(e.top)>=0,r=x(e.left)>=0,s=i&&n&&o&&r,a=s?null:Ut(t),l="none"!==e.display&&"collapse"!==e.visibility&&(s||!!a&&(i||a.height>0)&&(n||a.width>0)&&(o||a.top>=0)&&(r||a.left>=0));return l},qt=function(){p(Y),Y=0,g(K),K=0},Jt=function(){var t;if(a&&(t=Et(U.bridge))){var e=Ut(a);N(t.style,{width:e.width+"px",height:e.height+"px",top:e.top+"px",left:e.left+"px",zIndex:""+Yt(nt.zIndex)})}},Xt=function(t){U.ready===!0&&(U.bridge&&"function"==typeof U.bridge.setHandCursor?U.bridge.setHandCursor(t):U.ready=!1)},Yt=function(t){if(/^(?:auto|inherit)$/.test(t))return t;var e;return"number"!=typeof t||P(t)?"string"==typeof t&&(e=Yt(w(t,10))):e=t,"number"==typeof e?e:"auto"},Kt=function(t){var e,i,n,r=U.sandboxed,s=null;if(t=t===!0,W===!1)s=!1;else{try{i=o.frameElement||null}catch(a){n={name:a.name,message:a.message}}if(i&&1===i.nodeType&&"IFRAME"===i.nodeName)try{s=i.hasAttribute("sandbox")}catch(a){s=null}else{try{e=document.domain||null}catch(a){e=null}(null===e||n&&"SecurityError"===n.name&&/(^|[\s\(\[@])sandbox(es|ed|ing|[\s\.,!\)\]@]|$)/.test(n.message.toLowerCase()))&&(s=!0)}}return U.sandboxed=s,r===s||t||Zt(y),s},Zt=function(t){function e(t){var e=t.match(/[\d]+/g);return e.length=3,e.join(".")}function i(t){return!!t&&(t=t.toLowerCase())&&(/^(pepflashplayer\.dll|libpepflashplayer\.so|pepperflashplayer\.plugin)$/.test(t)||"chrome.plugin"===t.slice(-13))}function n(t){t&&(a=!0,t.version&&(c=e(t.version)),!c&&t.description&&(c=e(t.description)),t.filename&&(h=i(t.filename)))}var o,r,s,a=!1,l=!1,h=!1,c="";if(d.plugins&&d.plugins.length)o=d.plugins["Shockwave Flash"],n(o),d.plugins["Shockwave Flash 2.0"]&&(a=!0,c="2.0.0.11");else if(d.mimeTypes&&d.mimeTypes.length)s=d.mimeTypes["application/x-shockwave-flash"],o=s&&s.enabledPlugin,n(o);else if("undefined"!=typeof t){l=!0;try{r=new t("ShockwaveFlash.ShockwaveFlash.7"),a=!0,c=e(r.GetVariable("$version"))}catch(u){try{r=new t("ShockwaveFlash.ShockwaveFlash.6"),a=!0,c="6.0.21"}catch(p){try{r=new t("ShockwaveFlash.ShockwaveFlash"),a=!0,c=e(r.GetVariable("$version"))}catch(f){l=!1}}}}U.disabled=a!==!0,U.outdated=c&&x(c)<x(G),U.version=c||"0.0.0",U.pluginType=h?"pepper":l?"activex":a?"netscape":"unknown"};Zt(y),Kt(!0);var Qt=function(){return this instanceof Qt?void("function"==typeof Qt._createClient&&Qt._createClient.apply(this,I(arguments))):new Qt};C(Qt,"version",{value:"2.2.0",writable:!1,configurable:!0,enumerable:!0}),Qt.config=function(){return ot.apply(this,I(arguments))},Qt.state=function(){return rt.apply(this,I(arguments))},Qt.isFlashUnusable=function(){return st.apply(this,I(arguments))},Qt.on=function(){return at.apply(this,I(arguments))},Qt.off=function(){return lt.apply(this,I(arguments))},Qt.handlers=function(){return ht.apply(this,I(arguments))},Qt.emit=function(){return ct.apply(this,I(arguments))},Qt.create=function(){return dt.apply(this,I(arguments))},Qt.destroy=function(){return ut.apply(this,I(arguments))},Qt.setData=function(){return pt.apply(this,I(arguments))},Qt.clearData=function(){return ft.apply(this,I(arguments))},Qt.getData=function(){return gt.apply(this,I(arguments))},Qt.focus=Qt.activate=function(){return mt.apply(this,I(arguments))},Qt.blur=Qt.deactivate=function(){return vt.apply(this,I(arguments))},Qt.activeElement=function(){return yt.apply(this,I(arguments))};var te=0,ee={},ie=0,ne={},oe={};N(nt,{autoActivate:!0});var re=function(t){var e=this;e.id=""+te++,ee[e.id]={instance:e,elements:[],handlers:{}},t&&e.clip(t),Qt.on("*",function(t){return e.emit(t)}),Qt.on("destroy",function(){e.destroy()}),Qt.create()},se=function(t,e){var i,n,o,a={},l=ee[this.id],h=l&&l.handlers;if(!l)throw new Error("Attempted to add new listener(s) to a destroyed ZeroClipboard client instance");if("string"==typeof t&&t)o=t.toLowerCase().split(/\s+/);else if("object"==typeof t&&t&&"undefined"==typeof e)for(i in t)M.call(t,i)&&"string"==typeof i&&i&&"function"==typeof t[i]&&this.on(i,t[i]);if(o&&o.length){for(i=0,n=o.length;i<n;i++)t=o[i].replace(/^on/,""),a[t]=!0,h[t]||(h[t]=[]),h[t].push(e);if(a.ready&&U.ready&&this.emit({type:"ready",client:this}),a.error){for(i=0,n=tt.length;i<n;i++)if(U[tt[i].replace(/^flash-/,"")]){this.emit({type:"error",name:tt[i],client:this});break}s!==r&&Qt.version!==s&&this.emit({type:"error",name:"version-mismatch",jsVersion:Qt.version,swfVersion:s})}}return this},ae=function(t,e){var i,n,o,r,s,a=ee[this.id],l=a&&a.handlers;if(!l)return this;if(0===arguments.length)r=T(l);else if("string"==typeof t&&t)r=t.split(/\s+/);else if("object"==typeof t&&t&&"undefined"==typeof e)for(i in t)M.call(t,i)&&"string"==typeof i&&i&&"function"==typeof t[i]&&this.off(i,t[i]);if(r&&r.length)for(i=0,n=r.length;i<n;i++)if(t=r[i].toLowerCase().replace(/^on/,""),s=l[t],s&&s.length)if(e)for(o=s.indexOf(e);o!==-1;)s.splice(o,1),o=s.indexOf(e,o);else s.length=0;return this},le=function(t){var e=null,i=ee[this.id]&&ee[this.id].handlers;return i&&(e="string"==typeof t&&t?i[t]?i[t].slice(0):[]:E(i)),e},he=function(t){if(fe.call(this,t)){"object"==typeof t&&t&&"string"==typeof t.type&&t.type&&(t=N({},t));var e=N({},wt(t),{client:this});ge.call(this,e)}return this},ce=function(t){if(!ee[this.id])throw new Error("Attempted to clip element(s) to a destroyed ZeroClipboard client instance");t=me(t);for(var e=0;e<t.length;e++)if(M.call(t,e)&&t[e]&&1===t[e].nodeType){t[e].zcClippingId?ne[t[e].zcClippingId].indexOf(this.id)===-1&&ne[t[e].zcClippingId].push(this.id):(t[e].zcClippingId="zcClippingId_"+ie++,ne[t[e].zcClippingId]=[this.id],nt.autoActivate===!0&&ve(t[e]));var i=ee[this.id]&&ee[this.id].elements;i.indexOf(t[e])===-1&&i.push(t[e])}return this},de=function(t){var e=ee[this.id];if(!e)return this;var i,n=e.elements;t="undefined"==typeof t?n.slice(0):me(t);for(var o=t.length;o--;)if(M.call(t,o)&&t[o]&&1===t[o].nodeType){for(i=0;(i=n.indexOf(t[o],i))!==-1;)n.splice(i,1);var r=ne[t[o].zcClippingId];if(r){for(i=0;(i=r.indexOf(this.id,i))!==-1;)r.splice(i,1);0===r.length&&(nt.autoActivate===!0&&ye(t[o]),delete t[o].zcClippingId)}}return this},ue=function(){var t=ee[this.id];return t&&t.elements?t.elements.slice(0):[]},pe=function(){ee[this.id]&&(this.unclip(),this.off(),delete ee[this.id])},fe=function(t){if(!t||!t.type)return!1;if(t.client&&t.client!==this)return!1;var e=ee[this.id],i=e&&e.elements,n=!!i&&i.length>0,o=!t.target||n&&i.indexOf(t.target)!==-1,r=t.relatedTarget&&n&&i.indexOf(t.relatedTarget)!==-1,s=t.client&&t.client===this;return!(!e||!(o||r||s))},ge=function(t){var e=ee[this.id];if("object"==typeof t&&t&&t.type&&e){var i=kt(t),n=e&&e.handlers["*"]||[],o=e&&e.handlers[t.type]||[],r=n.concat(o);if(r&&r.length){var s,a,l,c,d,u=this;for(s=0,a=r.length;s<a;s++)l=r[s],c=u,"string"==typeof l&&"function"==typeof h[l]&&(l=h[l]),"object"==typeof l&&l&&"function"==typeof l.handleEvent&&(c=l,l=l.handleEvent),"function"==typeof l&&(d=N({},t),Tt(l,c,[d],i))}}},me=function(t){return"string"==typeof t&&(t=[]),"number"!=typeof t.length?[t]:t},ve=function(t){if(t&&1===t.nodeType){var e=function(t){(t||(t=h.event))&&("js"!==t._source&&(t.stopImmediatePropagation(),t.preventDefault()),delete t._source)},i=function(i){(i||(i=h.event))&&(e(i),Qt.focus(t))};t.addEventListener("mouseover",i,!1),t.addEventListener("mouseout",e,!1),t.addEventListener("mouseenter",e,!1),t.addEventListener("mouseleave",e,!1),t.addEventListener("mousemove",e,!1),oe[t.zcClippingId]={mouseover:i,mouseout:e,mouseenter:e,mouseleave:e,mousemove:e}}},ye=function(t){if(t&&1===t.nodeType){var e=oe[t.zcClippingId];if("object"==typeof e&&e){for(var i,n,o=["move","leave","enter","out","over"],r=0,s=o.length;r<s;r++)i="mouse"+o[r],n=e[i],"function"==typeof n&&t.removeEventListener(i,n,!1);delete oe[t.zcClippingId]}}};Qt._createClient=function(){re.apply(this,I(arguments))},Qt.prototype.on=function(){return se.apply(this,I(arguments))},Qt.prototype.off=function(){return ae.apply(this,I(arguments))},Qt.prototype.handlers=function(){return le.apply(this,I(arguments))},Qt.prototype.emit=function(){return he.apply(this,I(arguments))},Qt.prototype.clip=function(){return ce.apply(this,I(arguments))},Qt.prototype.unclip=function(){return de.apply(this,I(arguments))},Qt.prototype.elements=function(){return ue.apply(this,I(arguments))},Qt.prototype.destroy=function(){return pe.apply(this,I(arguments))},Qt.prototype.setText=function(t){if(!ee[this.id])throw new Error("Attempted to set pending clipboard data from a destroyed ZeroClipboard client instance");return Qt.setData("text/plain",t),this},Qt.prototype.setHtml=function(t){if(!ee[this.id])throw new Error("Attempted to set pending clipboard data from a destroyed ZeroClipboard client instance");return Qt.setData("text/html",t),this},Qt.prototype.setRichText=function(t){if(!ee[this.id])throw new Error("Attempted to set pending clipboard data from a destroyed ZeroClipboard client instance");return Qt.setData("application/rtf",t),this},Qt.prototype.setData=function(){if(!ee[this.id])throw new Error("Attempted to set pending clipboard data from a destroyed ZeroClipboard client instance");return Qt.setData.apply(this,I(arguments)),this},Qt.prototype.clearData=function(){if(!ee[this.id])throw new Error("Attempted to clear pending clipboard data from a destroyed ZeroClipboard client instance");return Qt.clearData.apply(this,I(arguments)),this},Qt.prototype.getData=function(){if(!ee[this.id])throw new Error("Attempted to get pending clipboard data from a destroyed ZeroClipboard client instance");return Qt.getData.apply(this,I(arguments))},n=function(){return Qt}.call(e,i,e,t),!(n!==r&&(t.exports=n))}(function(){return this||window}())},function(t,e,i){var n,o;n=[i(6),i(2),i(3),i(136)],o=function($,t,_,e){return e}.apply(e,n),!(void 0!==o&&(t.exports=o))},function(t,e,i){var n,o;n=[i(6),i(2),i(3),i(98),i(137),i(100)],o=function($,t,_,e,i,n){var o=t.View.extend({tmpl:$("#tmpl-note-form").html(),tagName:"form",className:"note-form",initialize:function(t){this.model=t.model,this.content=t.content||"",this.dfd=$.Deferred(),this.promise=this.dfd.promise(),this.isCreating="create"===t.type,this.formAttrGroup=this.isCreating?"config":"edit"},events:{submit:"submitForm","click .ln-cancel":"cancelForm"},render:function(){var t=new i,n=this.isCreating?t.get("visible_private"):this.model.get("visible_private");return this.initializeSharing(t,{disableWithoutSharing:!1}),this.$el.html(_.template(this.tmpl,{content:this.content,sharingActionsHtml:this.renderSharingHtml({sharingLabel:"分享",hasVisibleSetting:!0,allowShare:this.isCreating,visible_private:n})})),this.bindSharingActions(),e.ctrlEnterForm(this.$el),this},cancelForm:function(t){t.preventDefault(),this.dfd.reject(),this.trigger("form:cancelled")},readonlyForm:function(){e.readonlyForm(this.$el)},resumeForm:function(){e.resumeForm(this.$el)},submitForm:function(t){t.preventDefault();var e=this.formModel,i=this.getText();return i?(e.saveConfigToStroage(this.formAttrGroup),e.set("text",i),e.set("visible_private",this.visibleChecker.is(":checked")?"on":""),this.dfd.resolve(e),void this.trigger("form:submitted",e)):void alert("请填写批注内容")}});return _.extend(o.prototype,n),o}.apply(e,n),!(void 0!==o&&(t.exports=o))},function(t,e,i){var n,o;n=[i(2),i(3),i(6),i(99)],o=function(t,_,$,e){var i=["broadcast_to_site","share_dou","share_weibo"],n=i.concat(["visible_private"]),o={share_dou:"",share_weibo:"",broadcast_to_site:""};return e.extend({defaults:function(){return _.extend({share_dou:"on",share_weibo:"on",broadcast_to_site:"on",visible_private:"",text:""},this.getConfigFromStorage()||{})},attrsGroup:_.defaults({config:n,checkbox:n,sharing:i,edit:i},e.prototype.attrsGroup),configStroageKey:"noteFormDefaults",pickAttrs:function(t,i){var n=e.prototype.pickAttrs.apply(this,arguments),r=!!this.get("visible_private"),s=this.getGroupKeys(t);return i&&r&&(n=_.extend(n,_.pick(o,s))),n}})}.apply(e,n),!(void 0!==o&&(t.exports=o))},function(t,e,i){var n,o;n=[i(6),i(2),i(3),i(22)],o=function($,t,_,e){function i(t,e,i){return t=t||0,Math.max(Math.min(t,i),e)}function n(t,e,i){var n,o,r=!1;o=function(){r||(e(),n=setTimeout(o,i))},t.one("mouseleave",function(){
r=!0}),o()}var o=t.View.extend({el:".tiny-pagination-layer",events:{"mouseenter .tiny-page-switcher":"processTurning","mousemove .tiny-page-switcher":"stopPropagation"},initialize:function(){_.bindAll(this,["renderSwitchers"]),this.configModel=e.getModel("config"),this.scrollBody=$("html, body"),e.vent.on("pages:layout:finish",this.renderSwitchers)},render:function(){return this.switcherEl=this.$(".tiny-page-switcher"),this.prevEl=this.$(".page-prev-switcher"),this.nextEl=this.$(".page-next-switcher"),this},enable:function(){this.$el.attr("page-distance",0)},disable:$.noop,minHeaderSwitcherHeight:40,maxHeaderSwitcherHeight:80,minFooterSwitcherHeight:30,maxFooterSwitcherHeight:40,bufferZoneHeight:5,renderSwitchers:function(){var t=$(".page").eq(0),e=parseInt(t.css("padding-top"),10),n=t.find(".bd").height(),o=t.outerHeight()-e-n;this.prevEl.height(i(e-this.bufferZoneHeight,this.minHeaderSwitcherHeight,this.maxHeaderSwitcherHeight)),this.nextEl.height(i(o-this.bufferZoneHeight,this.minFooterSwitcherHeight,this.maxFooterSwitcherHeight))},processTurning:function(t){var e=$(t.currentTarget),n=e.data("direction"),o="prev"===n,r=this.configModel.get("layout");if("horizontal"===r){var s=0|e.attr("page-distence"),a=s+(o?-1:1);a=i(a,-1,1),this.$el.attr("page-distance",a),this.highlightPaginationBtn(o),this.turnPage(o)}else this.scrollPage(o)},turnPage:function(t){var i=e.getModel("turning"),n=i.get("currPage"),o=t?-1:1;return i.setCurrPage(n+o),this},highlightPaginationBtn:function(t){var e=".pagination .page-"+(t?"prev":"next"),i=$(e);i.addClass("on"),setTimeout(_.bind(i.removeClass,i,"on"),300)},scrollPage:function(t){var e=200,i=16*this.configModel.get("lineHeight"),o=this.scrollBody;n(this.switcherEl,function(){o.animate({scrollTop:(t?"-=":"+=")+2*i+"px"},e,"linear")},e)},stopPropagation:function(t){t.stopPropagation()}});return o}.apply(e,n),!(void 0!==o&&(t.exports=o))},function(t,e,i){var n,o;n=[i(2),i(3),i(22),i(33),i(140),i(141),i(41),i(142),i(143),i(144),i(90)],o=function(t,_,e,i,n,o,r,s,a,l,h){var c=t.Collection.extend({model:r,url:function(){return"/j/article_v2/"+this.articleId+"/annotations_by_paragraphs"},addFromSelection:function(t,e,i,n){var o=_.extend(t.toJSON(),{type:e},i,{tags:["mine"]});return"underline"===e?this.addUnderline(o):void this.add(o,n)},addUnderline:function(t){var e=t instanceof r?t:new r(t,{articleId:this.articleId,paragraphsIndex:this.paragraphsIndex}),i=this.linesColl.getModelsToMerge(e);i.length&&e.merge(i),this.add(e)},initialize:function(t,e){this.articleId=e.articleId,this.contentModel=e.contentModel,this.paragraphsIndex=this.contentModel.getParasIndexs(),this.linesColl=new s,this.markingsMap=new a,this.cachedPids={};var i=this;this.on("add",function(t,e,i){this.addToMap(t,e,i),this.broadcastWithPid("marking:{{pid}}:added",t)},this),this.on("effectiveChange",function(t,e){return t.isUnderline()?(i.linesColl.remove(t),i.linesColl.add(t),i.markingsMap.remove(t),void i.markingsMap.add(t)):void t.save({},e)}),this.on("remove",function(t){this.removeFromMap(t),this.broadcastWithPid("marking:{{pid}}:removed",t)}),_.each(["added","removed"],function(t){this.markingsMap.on(t,function(e,i){this.trigger("markingsMap:"+e+":"+t,i)},this)},this)},addToMap:function(t,e,i){var n=this;t.isRecommendation()&&this.trigger("recommendation:added",t),this.markingsMap.add(t),t.isUnderline()&&this.linesColl.add(t),t.isNew()&&t.save({},i).done(function(){n.trackAddByGa(t.get("type"))})},removeFromMap:function(t){this.markingsMap.remove(t),t.isUnderline()&&this.linesColl.remove(t)},trackAddByGa:function(t){var e,n=t;switch(n){case"underline":e="underline";break;case"note":e="note";break;case"rec_underline":break;default:h("modelType is invalid")}i._trackEvent(e)},notCachedPids:function(t){return _.difference(t,_.keys(this.cachedPids))},addCachedPids:function(t){_.each(t,function(t){this.cachedPids[t]=!0},this)},fetchByPids:function(t){var e=this.notCachedPids(t),i=this.markingsMap.getByPids(t),o=this;return _.each(i,function(t){o.broadcastWithPid("marking:{{pid}}:added",t)}),e.length?this.fetch({data:{paragraph_ids:e.join(",")},remove:!1,type:"post",success:function(){o.addCachedPids(e)}}):n()},getModelsByPid:function(t){return this.markingsMap.get(t)},parse:function(t,e){return _.isArray(t)||(t=[t]),_.each(t,function(t){t.endContainerId+="",t.startContainerId+="";for(var e=t.middleContainers,i=0,n=e.length;i<n;i++)e[i]+=""}),this.markingsFilter||(this.markingsFilter=new l({collection:this,limitFactor:.2,contentModel:this.contentModel})),e.dontFilterOut?(delete e.dontFilterOut,t):this.markingsFilter.filter(t)},broadcastWithPid:function(t,e){_.each(e.getContainerIds(),function(i){this.trigger(t.replace("{{pid}}",i),e)},this)}});return _.extend(c.prototype,o),c}.apply(e,n),!(void 0!==o&&(t.exports=o))},function(t,e,i){var n,o;n=[i(6)],o=function($){return function(){var t=new $.Deferred,e=t.promise();return arguments.length?t.resolve.apply(e,arguments):t.resolve(),e}}.apply(e,n),!(void 0!==o&&(t.exports=o))},function(t,e,i){var n,o;n=[i(2),i(3),i(6)],o=function(t,_,$){var e=t.Collection.prototype;return{add:function(t,i){t=$.makeArray(t),t=_.forEach(t,function(t){var n=this.get(t.id||t.cid);n?n.set(t):e.add.call(this,t,i)},this)},push:function(t,i){var n=this.get(t.id||t.cid);return n?(n.set(t),n):e.push.call(this,t,i)}}}.apply(e,n),!(void 0!==o&&(t.exports=o))},function(t,e,i){var n,o;n=[i(3),i(143)],o=function(_,t){function e(){this.pidToUnderlinesMap=new t}return _.extend(e.prototype,{add:function(t){this.pidToUnderlinesMap.add(t)},remove:function(t){this.pidToUnderlinesMap.remove(t)},getRelatedModels:function(t){var e=[];return _.each(t.getRanges(),function(t,i){var n=this.pidToUnderlinesMap.get(i);e=e.concat(n)},this),_.uniq(e)},getModelsToMerge:function(t){var e=[];return _.each(this.getRelatedModels(t),function(i){i.checkConflict(t)&&e.push(i)}),e}}),e}.apply(e,n),!(void 0!==o&&(t.exports=o))},function(t,e,i){var n,o;n=[i(3),i(2)],o=function(_,t){function e(){this.markingsMap={}}return _.extend(e.prototype,t.Events,{get:function(t){return this.markingsMap[t]=this.markingsMap[t]||[],this.markingsMap[t]},add:function(t){function e(e){i=this.get(e),_.contains(i,t)||(i.push(t),this.trigger("added",e,t))}var i,n=(t.toJSON(),this._getMapPids(t));_.each(n,e,this)},remove:function(t){_.each(this._getMapPids(t),function(e){this.markingsMap[e]=_.without(this.markingsMap[e],t),this.trigger("removed",e,t)},this)},_getMapPids:function(t){return t.isNote()?[t.get("endContainerId")]:t.getContainerIds()},getNoteCounterByPid:function(t){var e=_.filter(this.get(t),function(t){return t.isNote()});return e.length},getByPids:function(t){var e=_.map(t,function(t){return this.get(t)},this);return _.union.apply(this,e)},getMapData:function(){return this.markingsMap}}),e}.apply(e,n),!(void 0!==o&&(t.exports=o))},function(t,e,i){var n,o;(function($){"use strict";n=[i(3),i(58)],o=function(_,t){function e(t){this.origCollection=t.collection,this.contentModel=t.contentModel,this.limitFactor=t.limitFactor,this.LocalMarkings=t.collection.constructor.extend({fakeSync:!0})}return _.extend(e.prototype,{filter:function(t){var e=new this.LocalMarkings([],{articleId:this.id,contentModel:this.contentModel});return e.add(t),this.rejectLostParaMarkings(e),this.findHotAndAddTag(e),e.toJSON()},rejectLostParaMarkings:function(t){t.remove(t.reject(this.markingParasExist,this))},findHotAndAddTag:function(t){var e=t.markingsMap.getMapData(),i=this.origCollection.markingsMap.getMapData();_.each(e,function(t,e){var n=_.filter(i[e],this.isHotNote),o=_.filter(t,this.isHotNote),r=this.paraHotNotesLimit(e)-n.length-o.length;_.chain(t).filter(this.isCandidateHotNote,this).sortBy(this.getCreateTime,this).sortBy(this.getHotScore,this).reverse().first(r).each(this.addHotTag)},this)},isCandidateHotNote:function(t){return t.isNote()&&t.isOthers()&&!this.origCollection.get(t.id)},addHotTag:function(t){var e=t.get("tags");e.push("hot"),t.set("tags",e)},isHotNote:function(t){return _.contains(t.get("tags"),"hot")},getHotScore:function(t){return t.get("n_favorites")},getCreateTime:function(e){return t(e.get("create_time"))},paraHotNotesLimit:function(t){var e=$("p[data-pid="+t+"] .word").length;return Math.ceil(e*this.limitFactor)},markingParasExist:function(t){var e=t.getContainerIds(),i=this.contentModel;return _.every(e,function(t){return i.isPidExist(t)})}}),e}.apply(e,n),!(void 0!==o&&(t.exports=o))}).call(e,i(6))},function(t,e,i){var n,o;n=[i(3),i(2)],o=function(_,t){return{remove:function(){this.removeAllSubView(),t.View.prototype.remove.apply(this,arguments)},removeAllSubView:function(){var t=this.subViews();t.length&&(_.each(t,function(t){t.remove()},this),this._subViews=null)},removeSubView:function(t){_.without(this.subViews(),t)},addSubView:function(t){var e=t.remove,i=this;return t.hasParentView=!0,t.remove=function(){i.removeSubView(t),e.apply(this,arguments)},this.subViews().push(t),t},hasSubView:function(t){return _.contains(this.subViews(),t)},subViews:function(){return this._subViews||(this._subViews=[]),this._subViews}}}.apply(e,n),!(void 0!==o&&(t.exports=o))},function(t,e,i){var n,o;n=[i(6),i(2),i(3),i(22),i(117),i(32),i(133),i(60),i(78),i(145),i(67),i(66),i(147),i(149),i(153),i(82)],o=function($,t,_,e,i,n,o,r,s,a,l,h,c,d,u,p){var f=t.View.extend({className:"page",tmplPage:$("#tmpl-page").html(),tmplSampleChapterPage:$("#tmpl-sample-chapter-page").html(),initialize:function(t){_.bindAll(this,"showCodeToolbar"),this.vent=e.vent,this.data=t.data,this.markingTips=t.markingTips,this.turningModel=e.getModel("turning"),this.isSampleChapter=e.getModel("config").get("isChapter")&&e.getModel("chapters").currChapterNeedBuy(),this.isSampleChapter?this.initSampleChapterPage():this.initNormalPage()},initNormalPage:function(){this.pagination=this.data.page.pagination,this.on("render:selection",this.renderSelection,this),this.on("render:done",function(){this.paras=this.getParas(),this.parasMap=this.getParasMap(),this.paraPids=this.getPids()},this),n.fitForDesktop&&this.on("page:appended",function(){this.createAnnotationCounterLayer()},this)},initSampleChapterPage:function(){this.$el.addClass("selection-disabled")},events:{"mouseenter .code":"showCodeToolbar","mouseleave .code":"hideCodeToolbar"},render:function(){return this.isSampleChapter?this.renderSampleChapterPage():this.renderNormalPage(),this.trigger("render:done"),this},renderNormalPage:function(){var t=this.data.page.pagination,i=this.data.id,n=e.getModel("config").get("isChapter"),o=n&&e.getModel("column").toJSON().id,r=(n?["/column",o,"chapter",i,""]:["/ebook",i,""]).join("/");this.setPageOffsetTop(),this.$el.html(_.template(this.tmplPage,_.extend(this.data,{url:r,readPageNum:this.turningModel.real2read(t),pageTitle:n?this.data.title:this.data.page.title,figureUtil:s}))),this.highlightCode(),this.$el.attr("data-pagination",this.pagination)},setPageOffsetTop:function(){var t=e.getModel("config");if("vertical"===t.get("layout")){var n=t.getPageHeightEm(),o=this.data.page.pagination,r=i.reading.READER_INNER_PADDING_EM,s=n*(o-1)+r;this.$el.css({top:s+"em",position:"absolute"})}},renderSampleChapterPage:function(){var t=e.getModel("chapters"),i=t.getCurrChapter().toJSON(),o=e.getModel("column"),r=o.toJSON(),s=_.extend(this.data,{chapter:i,column:r,chapterNum:t.getCurrIndex()+1,readPageNum:this.turningModel.real2read(this.data.page.pagination),sec2date:u.sec2date,truncate:p});this.$el.html(_.template(this.tmplSampleChapterPage,s)),this.$el.attr("data-pagination",this.pagination);var a,c=i.id,d=r.id,f=["/column",d,"chapter",c].join("/"),g="/reader"+f,m=_.extend(i,{url:f,is_large_btn:!0,is_hollow_btn:!0,redirect_url:g,is_mobile_direct_purchase:n.fitForMobile,columnId:d}),v=this.$(".purchase-section"),y=(new l).render({data:m});r.can_sale&&(a=h(o)),a&&v.append(a.el),v.append(y.el),_.delay(function(){e.utils.applyPurchaseWithIn("[data-widget=faster-purchase]",".sample-chapter-page")},0)},createAnnotationCounterLayer:function(){var t=new c({page:this});this.addSubView(t),this.$el.append(t.render().$el)},getParasMap:function(){var t={};return this.paras.each(function(){var e=$(this);t[""+e.data("pid")]=e}),t},getPids:function(){return _.keys(this.parasMap)},getParas:function(){return this.$el.find("p[data-pid]")},isCurrPage:function(){return this.data.page.pagination===this.turningModel.get("currPage")},highlightCode:function(){function t(t,e){d.renderTextToEl(t.html(),e,t,!1)}var e=this.$el.find(".code code");e.length&&e.each(function(e,i){var n=$(i),o=n.data("language"),r=n.hasClass("line-split");r?n.children(".line").each(function(e,i){t($(i),o)}):t(n,o)})},showCodeToolbar:function(t){var e=$(t.currentTarget),i=e.find("code"),n=e.css("margin-top"),s=Math.abs(parseInt(n,10));$('<em class="arkicon-copy copy" title="复制代码"></em>').appendTo(e).end().css("top",s?s+10:18);var a=this.$el.find(".copy");if(window.clipboardData)return void a.one("click",function(){var t=i.text(),e=window.clipboardData.setData("TEXT",t);r.toast(e?"代码已成功复制到剪贴板":"复制失败，浏览器禁止了复制")});var l=o(a);l.on("ready",function(){l.on("copy",function(){var t=i.text();l.setText(t)}).on("aftercopy",function(){r.toast("内容已成功复制到剪贴板"),l.destroy()})})},hideCodeToolbar:function(t){if(!/\bcopy\b/g.test(t.target.className)){var e=$(t.currentTarget);e.find(".copy").remove()}}});return _.extend(f.prototype,a),f}.apply(e,n),!(void 0!==o&&(t.exports=o))},function(t,e,i){var n,o;n=[i(6),i(2),i(3),i(22),i(145),i(148)],o=function($,t,_,e,i,n){var o=".paragraph, .headline",r=t.View.extend({className:"annotation-counter-layer",initialize:function(t){this.config=e.getModel("config"),this.page=t.page;var i=this.config.get("annotationsConfig");this.listenTo(i,"change:showOthers",this.onAnnotationsConfigChange),this.$el.toggle(i.get("showOthers"))},render:function(){var t=this.page.paras.filter(o),i=this,r=e.getModel("article").markings,s=this.config.get("layout");return t.each(function(){var t=$(this);if(("horizontal"===s||!t.data("offset"))&&$.trim(t.text()).length){var e=(t.data("pid"),new n({para:t,markings:r}));i.addSubView(e),i.$el.append(e.render().el)}}),this.$el.css({top:-e.pageInfo.pageHeight}),this},onAnnotationsConfigChange:function(t,e){this.$el.toggle(e)}});return _.extend(r.prototype,i),r}.apply(e,n),!(void 0!==o&&(t.exports=o))},function(t,e,i){var n,o;n=[i(6),i(2),i(3),i(22)],o=function($,t,_,e){var i=t.View.extend({className:"annotation-counter",tagName:"a",initialize:function(t){this.para=t.para,this.pid=this.para.data("pid")+"",this.markings=t.markings,this.listenToMarkingsMap(),this.currentCounter=0},events:{click:"openAnnotationsPage"},openAnnotationsPage:function(t){t.preventDefault(),e.vent.trigger("open:paraAnnotationsOverlay",this.pid)},listenToMarkingsMap:function(){var t="";_.each(["added","removed"],function(e){t+="markingsMap:"+this.pid+":"+e+" "},this),this.listenTo(this.markings,t,function(){this.updateNumber()},this)},updateNumber:function(){var t=this.markings.markingsMap,e=t.getNoteCounterByPid(this.pid);return e?(this.currentCounter||this.$el.show(),void(this.currentCounter!==e&&(this.currentCounter=e,this.$el.text(e>99?"99+":e)))):(this.currentCounter=0,void this.$el.hide())},render:function(){var t=this.para[0],i=t.offsetTop,n=this.para.data("offset"),o=e.getModel("config").get("layout"),r=16;"horizontal"===o&&n&&(i=t.offsetTop+n*r);var s=parseInt(this.para.css("padding-top"),10);i+=s;var a=.25,l=parseInt(this.para.css("line-height"),10),h=l*a;return i+=h,this.$el.css({top:i,right:-33}),this.updateNumber(),this}});return i}.apply(e,n),!(void 0!==o&&(t.exports=o))},function(t,e,i){var n,o;n=[i(6),i(3),i(150),i(151),i(152)],o=function($,_,t,e,i){function n(t){var e=i[t];if(!e||!e.length)return[t];var o=[],r=void 0;return _.forEach(e,function(t){[].push.apply(o,n(t))}),r=_.uniq(e.concat(o)),r.push(t),r}function o(e,i){i?t("codemirror/lib/codemirror",function(){t("codemirror/addon/runmode/runmode",e)}):t("codemirror/addon/runmode/runmode-standalone",e)}function r(e,i,r){o(function(){var o="mode/"+e+"/"+e,r=n(o),s=_.map(r,function(t){return"codemirror/"+t});t(s,function(){i(window.CodeMirror)})},r)}var s="javascript",a=2;t.path(Ark.CDN_PUBLIC_PATH+"js/lib/"),t.urlArgs("v="+a);var l={renderTextToEl:function(t,i,n,o){var a=_.unescape(t);if(i=i||s,i=e.languageToModeName(i),!i)return void n.html(_.escape(a));var l={tabSize:2};r(i,function(CodeMirror){CodeMirror.runMode(a,i,n[0],l),n.addClass("cm-s-solarized cm-s-light")},o)}};return l}.apply(e,n),!(void 0!==o&&(t.exports=o))},function(t,e,i){var n,o;/*!
	  * $script.js JS loader & dependency manager
	  * https://github.com/ded/script.js
	  * (c) Dustin Diaz 2014 | License MIT
	  */
!function(r,s){"undefined"!=typeof t&&t.exports?t.exports=s():(n=s,o="function"==typeof n?n.call(e,i,e,t):n,!(void 0!==o&&(t.exports=o)))}("$script",function(){function t(t,e){for(var i=0,n=t.length;i<n;++i)if(!e(t[i]))return l;return 1}function e(e,i){t(e,function(t){return i(t),1})}function i(r,s,a){function l(t){return t.call?t():u[t]}function c(){if(!--y){u[v]=1,m&&m();for(var i in f)t(i.split("|"),l)&&!e(f[i],l)&&(f[i]=[])}}r=r[h]?r:[r];var d=s&&s.call,m=d?s:a,v=d?r.join(""):s,y=r.length;return setTimeout(function(){e(r,function t(e,i){return null===e?c():(i||/^https?:\/\//.test(e)||!o||(e=e.indexOf(".js")===-1?o+e+".js":o+e),g[e]?(v&&(p[v]=1),2==g[e]?c():setTimeout(function(){t(e,!0)},0)):(g[e]=1,v&&(p[v]=1),void n(e,c)))})},0),i}function n(t,e){var i,n=s.createElement("script");n.onload=n.onerror=n[d]=function(){n[c]&&!/^c|loade/.test(n[c])||i||(n.onload=n[d]=null,i=1,g[t]=2,e())},n.async=1,n.src=r?t+(t.indexOf("?")===-1?"?":"&")+r:t,a.insertBefore(n,a.lastChild)}var o,r,s=document,a=s.getElementsByTagName("head")[0],l=!1,h="push",c="readyState",d="onreadystatechange",u={},p={},f={},g={};return i.get=n,i.order=function(t,e,n){!function o(r){r=t.shift(),t.length?i(r,o):i(r,e,n)}()},i.path=function(t){o=t},i.urlArgs=function(t){r=t},i.ready=function(n,o,r){n=n[h]?n:[n];var s=[];return!e(n,function(t){u[t]||s[h](t)})&&t(n,function(t){return u[t]})?o():!function(t){f[t]=f[t]||[],f[t][h](o),r&&r(s)}(n.join("|")),i},i.done=function(t){i([null],t)},i})},function(t,e,i){var n,o;n=[i(3)],o=function(_){function t(t){return t.charAt(0).toUpperCase()+t.slice(1)}var e=[["apl"],["asterisk"],["asn.1"],["cpp","C++","go"],["c","C","go"],["objc","Objective-C","clike"],["shader","Shader","go"],["scala","Scala","go"],["nesc","nesC","go"],["clojure"],["cmake"],["cobol"],["coffeescript","CoffeeScript"],["commonlisp","Common Lisp"],["crystal"],["css","CSS"],["cypher"],["d"],["dart"],["diff"],["django"],["dockerfile","Dockerfile"],["dtd"],["ebnf"],["ecl"],["eiffel"],["elm"],["erlang"],["fcl"],["forth"],["fortran"],["gas"],["gherkin"],["go"],["groovy"],["haml"],["handlebars"],["haskell"],["haxe"],["ejs","Ejs","htmlembedded"],["aspx","Aspx","htmlembedded"],["jsp","Jsp","htmlembedded"],["erb","Erb","htmlembedded"],["html","HTML","htmlmixed"],["http","HTTP"],["idl","IDL"],["jade"],["java","Java","clike"],["javascript","JavaScript"],["jinja2"],["jsx"],["julia"],["less"],["livescript","LiveScript"],["lua"],["markdown","Markdown","gfm"],["mathematica"],["mbox"],["mirc"],["ml","ML","mllike"],["modelica"],["mscgen"],["mumps"],["nginx"],["nsis"],["ntriples"],["octave"],["oz"],["pascal"],["pegjs"],["perl"],["php"],["pig"],["powershell"],["properties"],["protobuf"],["puppet"],["python"],["q"],["r"],["rpm"],["rst"],["ruby"],["rust"],["sas"],["sass"],["scheme"],["shell","Shell/Bash"],["sieve"],["slim"],["smalltalk"],["smarty"],["solr"],["sparql","SPARQL"],["spreadsheet"],["sql","SQL"],["stex"],["stylus","Stylus"],["swift","Swift"],["tcl"],["tiddlywiki"],["tiki"],["toml"],["tornado"],["troff"],["ttcn"],["ttcn-cfg"],["turtle"],["vb","Visual Basic"],["vbscript"],["velocity"],["verilog"],["vhdl"],["vue"],["webidl"],["xml","XML"],["xquery","XQuery"],["yacas"],["yaml"],["z80"]],i={bash:"shell"};e=_.sortBy(e,0),_.each(e,function(e){var i=e[0];e[1]=e[1]||t(i),e[2]=e[2]||i});var n=_.chain(e).pluck(2).uniq().value(),o={};return _.each(e,function(t){o[t[0]]=t}),_.each(i,function(t,e){o[e]=o[t]}),{modes:e,keys:n,languageToModeName:function(t){var e=o[t];return e&&e[2]},languageToScreenName:function(t){var e=o[t];return e&&e[1]}}}.apply(e,n),!(void 0!==o&&(t.exports=o))},function(t,e,i){var n,o;n=[],o=function(){return{"addon/edit/closetag":["addon/fold/xml-fold"],"addon/edit/matchtags":["addon/fold/xml-fold"],"addon/fold/foldgutter":["addon/fold/foldcode"],"addon/hint/css-hint":["mode/css/css"],"addon/hint/html-hint":["addon/hint/xml-hint"],"addon/hint/sql-hint":["mode/sql/sql"],"addon/lint/html-lint":["htmlhint"],"addon/merge/merge":["diff_match_patch"],"addon/runmode/colorize":["addon/runmode/runmode"],"addon/search/jump-to-line":["addon/dialog/dialog"],"addon/search/match-highlighter":["addon/search/matchesonscrollbar"],"addon/search/matchesonscrollbar":["addon/scroll/annotatescrollbar","addon/search/searchcursor"],"addon/search/search":["addon/dialog/dialog","addon/search/searchcursor"],"keymap/sublime":["addon/edit/matchbrackets","addon/search/searchcursor"],"keymap/vim":["addon/dialog/dialog","addon/edit/matchbrackets","addon/search/searchcursor"],"mode/dart/dart":["mode/clike/clike"],"mode/django/django":["addon/mode/overlay","mode/htmlmixed/htmlmixed"],"mode/dockerfile/dockerfile":["addon/mode/simple"],"mode/factor/factor":["addon/mode/simple"],"mode/gfm/gfm":["addon/mode/overlay","mode/markdown/markdown"],"mode/haml/haml":["mode/htmlmixed/htmlmixed","mode/ruby/ruby"],"mode/handlebars/handlebars":["addon/mode/multiplex","addon/mode/simple"],"mode/haskell-literate/haskell-literate":["mode/haskell/haskell"],"mode/htmlembedded/htmlembedded":["addon/mode/multiplex","mode/htmlmixed/htmlmixed"],"mode/htmlmixed/htmlmixed":["mode/css/css","mode/javascript/javascript","mode/xml/xml"],"mode/jade/jade":["mode/css/css","mode/htmlmixed/htmlmixed","mode/javascript/javascript"],"mode/jsx/jsx":["mode/javascript/javascript","mode/xml/xml"],"mode/markdown/markdown":["mode/meta","mode/xml/xml"],"mode/nsis/nsis":["addon/mode/simple"],"mode/pegjs/pegjs":["mode/javascript/javascript"],"mode/php/php":["mode/clike/clike","mode/htmlmixed/htmlmixed"],"mode/powershell/powershell":["codemirror"],"mode/rst/rst":["addon/mode/overlay","mode/python/python","mode/stex/stex"],"mode/rust/rust":["addon/mode/simple"],"mode/slim/slim":["mode/htmlmixed/htmlmixed","mode/ruby/ruby"],"mode/soy/soy":["mode/htmlmixed/htmlmixed"],"mode/tornado/tornado":["addon/mode/overlay","mode/htmlmixed/htmlmixed"],"mode/twig/twig":["addon/mode/multiplex"],"mode/vue/vue":["addon/mode/overlay","mode/coffeescript/coffeescript","mode/css/css","mode/handlebars/handlebars","mode/jade/jade","mode/javascript/javascript","mode/sass/sass","mode/stylus/stylus","mode/xml/xml"],"mode/yaml-frontmatter/yaml-frontmatter":["mode/yaml/yaml"]}}.apply(e,n),!(void 0!==o&&(t.exports=o))},function(t,e,i){var n;n=function(){var t=function(t,i){i=i||{},i.dateFromNow=i.dateFromNow||!0,i.withoutYear=i.withoutYear||!1;var n=new Date(1e3*t),o="";if(i.dateFromNow){var r=e(n);if(r)return r}return i.withoutYear||(o=n.getFullYear()+"-"),o+=n.getMonth()+1+"-"+n.getDate()},e=function(t){var e=+new Date,i=e-t,n=Math.floor(i/864e5);if(!(n>2)){var o=Math.floor(i/1e3);if(o<180)return"刚刚";var r=Math.floor(o/60);if(r<60)return r+"分钟前";var s=Math.floor(r/60);return s<24?s+"小时前":n+"天前"}};return{sec2date:t}}.call(e,i,e,t),!(void 0!==n&&(t.exports=n))},function(t,e,i){var n,o;n=[i(6),i(2),i(3),i(22),i(156),i(155),i(169),i(178),i(182),i(53)],o=function($,t,_,e,i,n,o,r,s,a){var l=t.View.extend({initialize:function(t){this.collection=t.collection,this.markingTips=t.markingTips,this.pagesManager=t.pagesManager,e.vent.on("markings:created",this.bindCollection,this).on("open:paraAnnotationsOverlay",this.openParaAnnotaitonsOverlay,this).on("open:singleAnnotationOverlay",this.openSingleAnnotationOverlay,this),this.listenTo(this.pagesManager,"pages:rendered",this.createPageMarkingManagers,this),this.listenTo(this.pagesManager,"render:selection",function(t){this.trigger("render:selection",t),this.currentSelectionModel=t}),this.listenTo(this.pagesManager,"stopRender:selection",function(){this.currentSelectionModel=null})},openParaAnnotaitonsOverlay:function(t){var e=this.collection.getModelsByPid(t);if(e.length){var i=new o({annotationModels:e,pid:t});this.createAnnotationsOverlay(i,"para-annotations/"+t+"/")}},openSingleAnnotationOverlay:function(t,e){if(!this.isInArticle(t))return this.outRangeAlert(t);var i=new r({model:t,pid:e}),n=t.get("id");this.createAnnotationsOverlay(i,"annotation/"+n+"/")},createPageMarkingManagers:function(t,e){if(this.collection){var n=[];_.each(t,function(t){var e=t.$el,o=new i({collection:this.collection,page:t,container:e,markingTips:this.markingTips,articleMarkingManager:this});t.addSubView(o),n=n.concat(t.paraPids),e.append(o.render().el),this.currentSelectionModel&&o.renderSelection(this.currentSelectionModel)},this),this.collection.fetchByPids(_.uniq(n))}},bindCollection:function(t){this.collection&&this.stopListening(this.collection),this.collection=t;var i=e.getModel("article").get("isSample");i&&this.listenTo(t,"recommendation:added",this.checkInRangeAndAlert)},isInArticle:function(t){var i=e.getModel("content"),n=i.pidAndPageMap;return t.get("startContainerId")in n},outRangeAlert:function(t){var i=e.getModel("article"),n=(i.id,e.getModel("config").get("isChapter")),o=t.isNote(),r="无法查看"+(o?"批注":"这段内容"),l="很抱歉，因为"+(o?"批注":"这句话")+"所在的这段内容不在可以免费试读的范围内，购买后可以阅读。";if(n)return a({type:"tips",title:r,content:l}).addClass("general-tips").setButtons([{text:"知道了"}]).on("confirm",function(){this.close()}).open();var h=$("#tmpl-alert-with-aside").html(),c={title:r,text:l,confirm:"知道了",asideTitle:"",asideText:"对这本书感兴趣？",asideConfirm:"去购买"},d="/"+i.getBookUrl(),u=new s({html:_.template(h,c)});u.el.find(".aside-confirm").attr("href",d).attr("target","_blank")},checkInRangeAndAlert:function(t){this.isInArticle(t)||this.outRangeAlert(t)}});return _.extend(l.prototype,n),l}.apply(e,n),!(void 0!==o&&(t.exports=o))},function(t,e,i){var n,o;n=[i(6),i(2),i(3),i(22),i(54)],o=function($,t,_,e,i){return{createAnnotationsOverlay:function(t,n){var o=(e.getModel("article"),e.router.getBookUrl({ignoreSearch:!0})),r=i({body:t.render().$el,klass:"full-height-overlay",closable:!0}).open(),s=t.remove;return t.remove=function(){return this.removing=!0,s.call(this)},n&&e.navigate(o+n),t.on("removed",function(){r.close(),e.vent.trigger("unfreeze:control")}),t.listenTo(e.router,"route",function(){this.overlayModel.trigger("remove:view")}),t.$el.on("removing",function(){t.removing||(t.stopListening(),e.vent.trigger("unfreeze:control"),e.navigate(o))}),t.$el.find(".lnk-close").on("click",function(t){t.preventDefault(),r.close()}),e.vent.trigger("freeze:control"),t.trigger("appended",r),r}}}.apply(e,n),!(void 0!==o&&(t.exports=o))},function(t,e,i){var n,o;n=[i(6),i(2),i(3),i(22),i(157),i(145)],o=function($,t,_,e,i,n){var o=t.View.extend({className:"markings-layer",initialize:function(t){this.collection=t.collection,this.page=t.page,this.container=t.container,this.markingTips=t.markingTips,this.articleMarkingManager=t.articleMarkingManager,this.markingsIds={},this.listenTo(this.articleMarkingManager,"render:selection",this.renderSelection,this),this.listenToMarkingsAdded()},render:function(){return this.$el.css({top:-e.pageInfo.pageHeight}),this},listenToMarkingsAdded:function(){_.each(this.page.paraPids,function(t){_.each(["marking:"+t+":added","othersNote:"+t+":favorited"],function(t){this.listenTo(this.collection,t,this._renderMarking)},this)},this)},renderSelection:function(t){var e=this._getMarkingView(t).render().el;this.$el.append(e)},_renderMarking:function(t,e,i){if(this._canRenderOnPage(t)&&!this._checkMarkingExist(t)){var n=this._getMarkingView(t);this.$el.append(n.el),n.render()}},_checkMarkingExist:function(t){var e=t.cid;return!!this.markingsIds[e]||(this.markingsIds[e]=!0,!1)},_canRenderOnPage:function(t){return!t.isOthers()||t.isRecommendation()||t.isFromUrl()},_getMarkingView:function(t){return this.addSubView(new i({model:t,paragraphs:this.page.parasMap,markingTips:this.markingTips,markingManager:this}))},hideAllLines:function(){this.$el.addClass("hide-all-lines"),this.$(".highlight").removeClass("highlight")},showAllLines:function(){this.$el.removeClass("hide-all-lines")}});return _.extend(o.prototype,n),o}.apply(e,n),!(void 0!==o&&(t.exports=o))},function(t,e,i){var n,o;n=[i(6),i(2),i(3),i(158),i(163),i(164),i(168)],o=function($,t,_,e,i,n,o){var r={underline:e,selection:i,note:n,rec_underline:o},s=t.View.extend({className:"page-marking-container",initialize:function(t){this.paragraphs=t.paragraphs,this.markingTips=t.markingTips,this.markingManager=t.markingManager,this.listenTo(this.model,"change:type",this.render),this.listenTo(this.model,"destroy",this.remove)},render:function(){this.$el.empty();var t=this.model.get("type");return t in r&&(this.innerView=new r[t]({model:this.model,paragraphs:this.paragraphs,markingTips:this.markingTips,markingManager:this.markingManager}),this.$el.append(this.innerView.el),this.innerView.render()),this},remove:function(){return this.innerView.remove(),t.View.prototype.remove.apply(this,arguments)}});return s}.apply(e,n),!(void 0!==o&&(t.exports=o))},function(t,e,i){var n,o;n=[i(6),i(2),i(3),i(21),i(159),i(162),i(51)],o=function($,t,_,e,i,n,o){var r=e.me.isAnonymous?{setMarkingTips:function(){o()}}:{},s=i.extend({events:{click:"clickOnLine",mousedown:"fireMouseDownUnderMark"},initialize:function(t){this.paragraphs=t.paragraphs,this.markingTips=t.markingTips,this.listenTo(this.model,"change",this.render)},fireMouseDownUnderMark:function(t){this.$el.hide(),this.fireMouseEvent(document.elementFromPoint(t.clientX,t.clientY),t),this.$el.show()},fireMouseEvent:function(t,e){var i,n=t;document.createEvent?(i=document.createEvent("MouseEvents"),i.initMouseEvent(e.type,!0,!0,window,e.detail,e.screenX,e.screenY,e.clientX,e.clientY,e.ctrlKey,e.altKey,e.shiftKey,e.metaKey,e.button,null),n.dispatchEvent(i)):document.createEventObject&&(i=document.createEventObject(),n.fireEvent("on"+e.type,i))},clickOnLine:function(t){t.stopPropagation();var e=$(t.target),i=this.markingTips;this.setMarkingTips({left:t.pageX,top:i.getOffsetWithin(e).top,width:0,height:18},["del","note","sharing","copy","debug","open","translate"])},setMarkingTips:function(t,e){var i=new n({model:this.model,btnList:e,container:this.markingTips});this.markingTips.set({target:t,className:"btns-tip",content:i.render().el,arrowHeight:5}).show()}});return _.extend(s.prototype,r),s}.apply(e,n),!(void 0!==o&&(t.exports=o))},function(t,e,i){var n,o;n=[i(6),i(2),i(3),i(160)],o=function($,t,_,e){var i=t.View.extend({className:"underline",underlineClass:"underline",tagClass:"",typeClass:"",initialize:function(t){this.paragraphs=t.paragraphs,this.plotOptions=_.extend({},this.plotOptions,t.plotOptions),this.listenTo(this.model,"change:tags",this.updateUnderlineClass)},render:function(){return this.lines=this.plotRange(this.model.getRanges(),this.paragraphs,this.underlineClass),this.updateUnderlineClass(),this.$el.html(this.lines),this},updateUnderlineClass:function(){this.updateTagClass(),this.updateTypeClass()},updateTagClass:function(){this.lines.removeClass(this.tagClass),this.tagClass=this.getTagClass(),this.lines.addClass(this.tagClass)},updateTypeClass:function(){this.lines.removeClass(this.typeClass),this.typeClass=this.getTypeClass(),this.lines.addClass(this.typeClass)},getTagClass:function(){return this.model.getShowTag()+"-underline"},getTypeClass:function(){return this.model.get("type")+"-underline"}});return _.extend(i.prototype,e),i}.apply(e,n),!(void 0!==o&&(t.exports=o))},function(t,e,i){var n,o;n=[i(6),i(2),i(3),i(22),i(117),i(124),i(161)],o=function($,t,_,e,i,n,o){var r=i.allowSelectionParagraphSelector,s={plotOptions:{containerAttrs:{"class":"fake-article"},isDrawInArticle:!0},plotRange:function(t,e,i){var n=$();return _.each(t,function(t,o){if(o in e){var s=this.paragraphs[o],a=$.trim(s.text());if(!a.length||!s.is(r))return;var l=this.plotPara(s,t.start,t.end,i);n=n.add(l)}},this),n},plotPara:function(t,e,i,r){e=e||0;for(var s,a=n(t,this.plotOptions.containerAttrs),l=[],h=a.index.offset,c=0,d=h[c],u=h[c+1];!_.isUndefined(u)&&u<=e;){if(c+=1,e===u){a.index.lineBreak[c]&&l.push(c-1);break}d=u,u=h[c+1]}do l.push(c),d=u,u=h[++c];while(!_.isUndefined(u)&&(i>=u||!isFinite(i)));var p={};p[l[0]]={start:e};var f=l[l.length-1];return p[f]=_.extend(p[f]||{},{end:i}),_.each(l,function(n){var l,h,c=a.lines[n],d=p[n];d&&(_.isUndefined(d.start)||(l=o(c,e,!0)),_.isUndefined(d.end)||(h=o(c,i)));var u=this.plotLine(t,c,r,l,h);s=s?s.add(u):u},this),s},plotLine:function(t,e,i,n,o){n||(n=_.first(e)),o||(o=_.last(e));var r=n.top+t[0].offsetTop,s=n.height,a=n.left,l=o.left+o.width-a;return this.drawBox(r,a,s,l).addClass(i)},drawBox:function(t,i,n,o){return this.plotOptions.isDrawInArticle&&(t<0||t+n>e.pageInfo.pageHeight)?$():$("<div></div>",{"class":"marking",css:{top:t,left:i+1,height:n,width:o-1}})}};return s}.apply(e,n),!(void 0!==o&&(t.exports=o))},function(t,e,i){var n,o;n=[i(6)],o=function($){function t(t,e,i){for(var n,o,r,s,a=0,l=t.length;a<l;++a){if(s=$(t[a].span),r=s.data("offset"),i||(r+=s.data("length")-1),r>e){if(0===a)break;o=a}if(r===e){n=t[a];break}}return n?n:!!o&&t[o-1]}return t}.apply(e,n),!(void 0!==o&&(t.exports=o))},function(t,e,i){var n,o;n=[i(6),i(2),i(3),i(21),i(22),i(126),i(135),i(51)],o=function($,t,_,e,i,n,o,r){var s=function(){r(),this.clear()},a=e.me.isAnonymous?{debug:s,sharing:s}:{},l=n.extend({del:function(){this.model.destroy(),this.clear()},note:function(){var t=this;this.createFormInTip(o,{model:this.model,type:"create"},{done:function(e){var n=!0,o=t.model.omit("id"),r=i.getModel("article").markings,s=e.get("text"),a=e.pickAttrs("sharing",n);_.extend(o,{note:s,type:"note",visible_private:e.get("visible_private")}),r.add(o,{sharing:a})}})}});return _.extend(l.prototype,a),l}.apply(e,n),!(void 0!==o&&(t.exports=o))},function(t,e,i){var n,o;n=[i(6),i(2),i(3),i(160)],o=function($,t,_,e){var i=t.View.extend({className:"selection",initialize:function(t){this.paragraphs=t.paragraphs,this.listenTo(this.model,"change",this.render)},render:function(){return this.$el.empty(),this.$el.append(this.plotRange(this.model.getRanges(),this.paragraphs,"selection")),this}});return _.extend(i.prototype,e),i}.apply(e,n),!(void 0!==o&&(t.exports=o))},function(t,e,i){var n,o;n=[i(6),i(2),i(3),i(22),i(165),i(159),i(124),i(161)],o=function($,t,_,e,i,n,o,r){var s=t.View.extend({className:"note",initialize:function(t){this.paragraphs=t.paragraphs,this.markingTips=t.markingTips,this.markingManager=t.markingManager,this.config=e.getModel("config").get("annotationsConfig"),this.listenTo(this.config,"change",this.render),this.listenTo(this.model,"render:line",this.renderLine),this.listenTo(this.model,"remove:line",this.removeLine)},render:function(){return this.willHide(this.model)?this.hide():this.show(),this.model.get("open_on_render")&&this.displayInTip(),this},show:function(){if(!this.isShown){this.isShown=!0;var t=this.model.get("endContainerId"),e=this.model.get("endOffset");if(t in this.paragraphs){var i,n,s,a=this.paragraphs[t],l=o(a),h=l.lines;for(n=0,s=h.length;n<s&&!(i=r(h[n],e));++n);if(n>=s&&(n=s-1),i||(i=_.last(h[n])),!i)return;this._renderDot(a,i)}}},_renderDot:function(t,n){var o=$(n.span),r=o.data("note-dot");if(r)return this.dot=r,void this.dot.assignNote(this);var s=n.top+t[0].offsetTop;s<0||s>e.pageInfo.pageHeight||(this.dot=new i({para:t,spanInfo:n,markingTips:this.markingTips}).render(),o.data("note-dot",this.dot),this.dot.assignNote(this))},appendDot:function(t){this.$el.append(t)},displayInTip:function(){this.dot&&this.dot.displayNote(this)},renderLine:function(){this.removeLine(),this.underline=new n({model:this.model,paragraphs:this.paragraphs}),this.$el.append(this.underline.render().el),this.hideOtherLines()},removeLine:function(){this.underline&&(this.underline.remove(),this.underline=null,this.showOtherLines())},hideOtherLines:function(){this.markingManager.hideAllLines(),this.underline.$el.addClass("highlight"),this.underline.lines.addClass("highlight")},showOtherLines:function(){this.markingManager.showAllLines()},willHide:function(){return!(!this.config.isFilterOut(this.model)||this.model.isRecommendation())},hide:function(){this.isShown&&(this.dot&&this.dot.unassignNote(this),this.$el.empty(),this.isShown=!1)},remove:function(){return this.hide(),t.View.prototype.remove.apply(this,arguments)}});return s}.apply(e,n),!(void 0!==o&&(t.exports=o))},function(t,e,i){var n,o;n=[i(6),i(2),i(3),i(22),i(166)],o=function($,t,_,e,i){var n=["mine","favorite","following","hot","others"],o={en:{height:6,width:8},cn:{height:9,width:9}},r={en:1,cn:2},s=t.View.extend({className:"note-dot",events:{click:"displayTip"},initialize:function(t){this.para=t.para,this.spanInfo=t.spanInfo,this.markingTips=t.markingTips,this.assignedNotes=[];var i=e.getModel("article").get("lang");this.dotStyle=o[i]||o.cn,this.underlineHeight=r[i]||r.cn},render:function(){var t=this.spanInfo.top+this.para[0].offsetTop,e=parseInt(this.para.css("line-height"),10),i=e-this.spanInfo.height-this.underlineHeight,n={top:t-(this.dotStyle.height+i)/2,left:this.spanInfo.left+(this.spanInfo.width-this.dotStyle.width)/2};return this.$el.css(n),this},displayTip:function(t){this.displayNote()},displayNote:function(t){var e=new i({markingTips:this.markingTips,notes:this.assignedNotes,specificNote:t}),n=this;this.tip=e,this.markingTips.set({target:this.$el,className:"btns-tip",content:e.render().el}).setClass("note-display-tip").show(),e.on("render:done",function(t){e.updateTipPosition(),n.setShowModel(t.model)}),e.on("hide",function(){e.remove(),n.tip=null,n.setShowModel(n.masterNote.model)}),e.updateTipPosition()},assignNote:function(t){this.assignedNotes.push(t),this.updateNotes()},unassignNote:function(t){var e=_.indexOf(this.assignedNotes,t);this.assignedNotes.splice(e,1),this.updateNotes()},updateNotes:function(){return this.assignedNotes.length?(this.assignedNotes=this.getSortedNotes(this.assignedNotes),this.setMasterNote(this.assignedNotes[0]),void(this.tip?(this.tip.notes=this.assignedNotes,this.tip.render()):this.setShowModel(this.masterNote.model))):void this.remove()},setMasterNote:function(t){var e=t.model;e.getShowTag();this.masterNote=t,t.appendDot(this.$el),this.delegateEvents()},setShowModel:function(t){this.showNoteModel&&this.stopListening(this.showNoteModel),this.showNoteModel=t,this.updateDotClass(),this.listenTo(t,"change:tags",this.updateDotClass)},updateDotClass:function(){this.$el.removeClass(this.dotClass),this.dotClass=this.getDotClass(this.showNoteModel.getShowTag()),this.$el.addClass(this.dotClass)},getDotClass:function(t){return t+"-note"},getSortedNotes:function(t){return _.sortBy(t,function(t){return _.indexOf(n,t.model.getShowTag())})}});return s}.apply(e,n),!(void 0!==o&&(t.exports=o))},function(t,e,i){var n,o;n=[i(6),i(2),i(3),i(22),i(49),i(167)],o=function($,t,_,e,i,n){var o=t.View.extend({tmpl:$("#tmpl-note-display").html(),commentTextTmpl:$("#tmpl-annotation-comment-text").html(),favoriteTextTmpl:$("#tmpl-annotation-favorite-text").html(),className:"note-display",initialize:function(t){this.noteTip=this.markingTips=t.markingTips,this.notes=t.notes,this.currentNote=this.notes[0],t.specificNote&&(this.currentNote=t.specificNote)},events:{"click .share":"shareNote","click .edit":"editNote","click .delete":"deleteNote","click .favorite":"favoriteNote","click .tip-pagination a":"turnPage","click .comment":"jumpComments"},render:function(){return this.changeToNote(this.currentNote),this},renderNote:function(t){var n=this.getNoteIndex(t),o=t.model,r=this.notes.length,s=o.toJSON(),a=s.owner.user_id;this.$el.html(_.template(this.tmpl,{note:s,isPrivate:o.isPrivate(),actions:o.getActionsList(),favorited:o.isFavorited(),current:n+1,autoLink:i,total:r,isArticleAuthor:a===e.getModel("article").get("authorId")})),this.favoriteText=this.$(".favorite"),this.commentText=this.$(".comment"),this.privateText=this.$(".private-info"),this.shareWrapper=this.$(".share-wrapper"),0===n&&this.$(".prev").addClass("disabled"),n===r-1&&this.$(".next").addClass("disabled"),o.trigger("render:line"),this.markingTips.once("hidden",function(){o.trigger("remove:line"),this.trigger("hide")},this),this.updateFavorite(o),this.updateComment(o),this.updatePrivate(o)},changeToNote:function(t){var e=t.model;this.renderNote(t),this.stopListening(this.currentNote.model),this.listenTo(e,"change:n_favorites",this.updateFavorite).listenTo(e,"change:n_comments",this.updateComment).listenTo(e,"change:visible_private",this.updatePrivate),this.currentNote=t,this.trigger("render:done",t)},jumpComments:function(t){t.preventDefault();var i=this.currentNote.model;e.vent.trigger("open:singleAnnotationOverlay",i)},updatePrivate:function(t){if(this.privateText.length){var e=t.isPrivate();this.privateText[e?"show":"hide"](),this.shareWrapper[e?"hide":"show"]()}},updateFavorite:function(t){if(this.favoriteText.length){var e=t.toJSON();e.isFavorited=t.isFavorited(),this.favoriteText.html(_.template(this.favoriteTextTmpl,e))}},updateComment:function(t){this.commentText.length&&this.commentText.html(_.template(this.commentTextTmpl,t.toJSON()))},turnPage:function(t){t.preventDefault();var e=$(t.currentTarget),i=e.hasClass("prev"),n=this.getCurrentIndex();e.hasClass("disabled")||(this.currentNote.removeLine(),this.changeToNote(i?this.notes[n-1]:this.notes[n+1]))},getCurrentIndex:function(){return this.getNoteIndex(this.currentNote)},getNoteIndex:function(t){var e=_.indexOf(this.notes,t);return e<0?(this.notes.push(t),this.notes.length-1):e},updateTipPosition:function(){var t=10;this.markingTips.update(t)}});return _.extend(o.prototype,n,{loginRedirectType:"page",_getNoteModel:function(){return this.currentNote.model}}),o}.apply(e,n),!(void 0!==o&&(t.exports=o))},function(t,e,i){var n,o;n=[i(6),i(2),i(3),i(21),i(127),i(50),i(135),i(130)],o=function($,t,_,e,i,n,o,r){var s={_getNoteModel:$.noop,_setTarget:!1,favoriteNote:function(t){t.preventDefault();var e=this._getNoteModel(),i=e.isFavorited();e.isFavoriting||e.editFavorite(!i)},shareNote:function(t){t.preventDefault();var e=this._getNoteModel();this._setTarget&&this.noteTip.set({target:$(t.currentTarget)}),i(this.noteTip,r,{model:e,isNote:e.isNote(),url:"/j/share/rec_annotation",extraParam:{annotation_id:e.get("id"),works_id:e.articleId}},{autoClose:!0})},editNote:function(t){t.preventDefault();var e=this._getNoteModel();this._setTarget&&this.noteTip.set({target:$(t.currentTarget)}),i(this.noteTip,o,{model:e,type:"edit",content:e.get("note")},{autoClose:!0}).promise.done(function(t){e.set({note:t.get("text"),visible_private:t.get("visible_private")})})},deleteNote:function(t){t.preventDefault();var e=confirm("真的要删除这条批注吗？");return!!e&&(this.noteTip.hide(),this._getNoteModel().destroy(),!0)}},a=function(t){t.preventDefault();var e={page:{actions:{stamp:this._getNoteModel().getStamp()}}};n.openLoginAndSignup(e[this.loginRedirectType])},l={};return e.me.isAnonymous&&_.each(["favoriteNote","shareNote","replyNote"],function(t){l[t]=a}),_.extend(s,l),s}.apply(e,n),!(void 0!==o&&(t.exports=o))},function(t,e,i){var n,o;n=[i(3),i(158)],o=function(_,t){return t.extend({underlineClass:"underline others-underline",render:function(){this.$el.empty(),this.$el.append(this.plotRange(this.model.getRanges(),this.paragraphs,this.underlineClass));var t=this.$(".others-underline"),e=this.model;return _.delay(function(){t.css("opacity","0")},3e3),_.delay(function(){e.destroy()},5e3),this},clickOnLine:function(t){t.stopPropagation()}})}.apply(e,n),!(void 0!==o&&(t.exports=o))},function(t,e,i){var n,o;n=[i(6),i(2),i(3),i(22),i(58),i(170),i(173)],o=function($,t,_,e,i,n,o){var r=t.Model.extend({filterFunc:{hot:function(){return _.sortBy(this.annotationModels,function(t){return-t.get("n_favorites")})},newest:function(){return _.sortBy(this.annotationModels,function(t){return-i(t.get("create_time"))})},favorite:function(){return _.filter(this.annotationModels,function(t){return t.isFavorited()})}},initialize:function(t,e){this.annotationModels=e.annotationModels},annotaitonsIsEmpty:function(){return!this.annotationModels.length},getAnnotations:function(){var t=this.get("navType"),e=this.filterFunc[t];return e.call(this)}});return t.View.extend(_.extend({tmpl:$("#tmpl-para-annotations-overlay").html(),className:"annotations-overlay-wrapper",optionProps:["annotationModels","pid"],events:{"click .filter-tabs a":"filterItems"},initialize:function(t){_.extend(this,_.pick(t,this.optionProps)),this.overlayModel=new r({pid:this.pid},{annotationModels:this.annotationModels}),this.overlayModel.on("remove:view",function(){this.remove().trigger("removed")},this),this.overlayModel.on("change:navType",function(){this.updateTabs(),this.renderAnnotationsList(),this.contentContainer.emptyMarkingManager(),this.annotationsList.hoverFirstAnnotation()},this),this.on("appended",function(){this.contentContainer.renderMarkingManager(),this.overlayModel.set("navType","hot"),this.annotationsList.hoverFirstAnnotation()},this)},filterItems:function(t){var e=$(t.currentTarget),i=e.data("nav-type");this.overlayModel.set("navType",i)},updateTabs:function(){var t=this.$(".filter-tabs"),e=this.overlayModel.get("navType"),i=t.find(".actived"),n=t.find("a[data-nav-type="+e+"]");i&&n[0]===i[0]||(i&&i.removeClass("actived"),n.addClass("actived"))},render:function(){return this.$el.html(_.template(this.tmpl,{totalAnnotations:this.annotationModels.length})),this.overlayContainer=this.$(".annotations-overlay"),this.sideSection=this.$(".side"),this.createContentContainer(this.getContents()),this.annotationsList=this.createAnnotationsList(),this},getContents:function(){var t=e.getModel("content"),i=t.getParagraph(this.pid);return[i]},renderAnnotationsList:function(){this.annotationsList.render()},createAnnotationsList:function(){var t=new n({overlayModel:this.overlayModel,el:this.$(".annotations-list")});return t.on("hoverClass:added",function(t){var e=t.data("view"),i=e.model,n=this.contentContainer;n.renderUnderline(i).scrollToCurrentMarking()},this),t}},o))}.apply(e,n),!(void 0!==o&&(t.exports=o))},function(t,e,i){var n,o;n=[i(6),i(2),i(3),i(171)],o=function($,t,_,e){var i="<p>暂时没有被你收藏的他人批注</p><p>可以对你认为有趣的他人批注点击“收藏”，它们就会出现在这里</p>",n="<p>暂时没有划线和批注</p><p>可以在阅读时选中文字后添加</p>";return t.View.extend({events:{"mouseenter li":"hoverAnnotation"},initialize:function(t){this.overlayModel=t.overlayModel},hoverAnnotation:function(t){var e=$(t.currentTarget),i=this.$(".hover");i[0]!==e[0]&&(i.removeClass("hover"),this.addHoverClass(e))},addHoverClass:function(t){t.addClass("hover"),this.trigger("hoverClass:added",t)},hoverFirstAnnotation:function(){var t=this.$(".annotation-item").first();t.length&&this.addHoverClass(t)},renderNoAnnotations:function(t){var e=$("<div>",{"class":"no-annotations-label"});this.$el.html(e.html(t))},render:function(){this.$el.empty();var t=this.overlayModel.getAnnotations();if(this.overlayModel.annotaitonsIsEmpty())return void this.renderNoAnnotations(n);if(!t.length){var o="favorite"===this.overlayModel.get("navType");return void(o&&this.renderNoAnnotations(i))}return _.each(t,function(t){if(t.isNote()){var i=new e({model:t,overlayModel:this.overlayModel});this.$el.append(i.render().el)}},this),this}})}.apply(e,n),!(void 0!==o&&(t.exports=o))},function(t,e,i){var n,o;n=[i(6),i(2),i(3),i(22),i(54),i(49),i(172)],o=function($,t,_,e,i,n,o){var r=t.View.extend({tmpl:$("#tmpl-para-annotations-overlay-annotation-item").html(),tagName:"li",className:"annotation-item",events:{click:"openSingleAnnotation"},initialize:function(t){this.$el.data("view",this),this.overlayModel=t.overlayModel},openSingleAnnotation:function(){this.overlayModel.trigger("remove:view"),e.vent.trigger("open:singleAnnotationOverlay",this.model,this.overlayModel.get("pid"))},render:function(){var t=this.model.toJSON(),i=t.owner.user_id;return this.$el.html(_.template(this.tmpl,_.extend(t,{printTime:o,isPrivate:this.model.isPrivate(),isArticleAuthor:i===e.getModel("article").get("authorId"),autoLink:n}))),this}});return r}.apply(e,n),!(void 0!==o&&(t.exports=o))},function(t,e,i){var n,o;n=[i(58)],o=function(t){function e(t){var e=String(t);return 1===e.length&&(e="0"+e),e}return function(i,n){var o=t(i);return o.getFullYear()+"-"+e(o.getMonth()+1)+"-"+e(o.getDate())+(n?"":" "+e(o.getHours())+":"+e(o.getMinutes()))}}.apply(e,n),!(void 0!==o&&(t.exports=o))},function(t,e,i){var n,o;n=[i(6),i(2),i(3),i(174)],o=function($,t,_,e){return{createContentContainer:function(t){var i=this.contentContainer=new e({height:$(window).height()-40});
this.sideSection.append(i.render().el),i.renderContent(t)}}}.apply(e,n),!(void 0!==o&&(t.exports=o))},function(t,e,i){var n,o;n=[i(6),i(2),i(3),i(22),i(175),i(177)],o=function($,t,_,e,i,n){return t.View.extend({className:"content-container",tmplHtml:$("#tmpl-content-container").html(),initialize:function(t){this.height=t.height,this.$el.css({height:this.height,overflowX:"hidden"}),this.markingManager=new n({contentContainer:this})},render:function(){return this.$el.html(this.tmplHtml),this.content=this.$(".content"),this},renderMarkingManager:function(){return this.hasScroll=this.content.height()>this.height,this.$el.css("overflowY",this.hasScroll?"auto":"hidden"),this.$el.append(this.markingManager.render().el),this},emptyMarkingManager:function(){return this.markingManager.empty(),this},renderUnderline:function(t){var e=this.markingManager;return e.renderUnderline(t),this},scrollToCurrentMarking:function(){var t=this.markingManager,e=t.getCurrentMarkingPosition(),i=60;this.$el.stop().animate({scrollTop:e.top-i},"slow")},renderContent:function(t){var e=this.content;return e.empty(),this.jqParas={},_.each(t,function(t){t=_.clone(t),e.append(i(t));var n=t.pid;this.jqParas[t.pid]=e.find("p[data-pid="+n+"]")},this),this},loadFigures:function(){var t=this.content.find(".illus"),e=this.content.width();return t.length?(_.each(t,function(t){t=$(t).css("height","auto");var i=t.find("img"),n=i.data("src"),o=i.data("orig-width"),r=i.data("orig-height");if(e<o){var s=o/r;o=e,r=e/s}i.attr("src",n).css({width:o,height:r}).removeClass("loading")}),this):this}})}.apply(e,n),!(void 0!==o&&(t.exports=o))},function(t,e,i){var n,o;n=[i(6),i(3),i(22),i(32),i(176)],o=function($,_,t,e,i){var n=$("#tmpl-paragraph").html(),o=function(){var t=function(t){return i(t)};return e.fitForDesktop||(t=function(t){return t}),t}(),r=function(t){return"illus"!==t.type&&"code"!==t.type&&t.klass.indexOf("pagebreak")===-1?o(t.text):t.text};return function(t){return _.template(n,{p:t,getParaContent:r})}}.apply(e,n),!(void 0!==o&&(t.exports=o))},function(t,e,i){var n,o;n=[i(6),i(3),i(120),i(30)],o=function($,_,t,e){function i(t){var e=$(t)[0],i=0;return"<dfn>"+n(e,i).html+"</dfn>"}function n(t,e){for(var i,n,r,s,l="",h={},d=t.childNodes,u=d.length,p=0;p<u;)i=d[p],$.nodeName(i,"span")&&c.test(i.className)?(s=i.getElementsByTagName("script")[0],r=s.textContent||$.trim(s.innerHTML),n=r.length,l+=a.makeWord(i.innerHTML,e,n),p+=1,e+=n):(h=o(i,e),l+=h.html,e=h.offset,p++);return{html:l,offset:e}}function o(t,e){var i,o=t.nodeName.toLowerCase();if(3===t.nodeType)return i=s(t,e),{html:i.html,offset:i.offset};if(1!==t.nodeType)throw"nodetype error";if(_.indexOf(l,o)!==-1)return{html:t.outerHTML,offset:e};if("code"===o){var c=t.textContent||$.trim(t.innerHTML),d=c.length;return{html:a.makeWord(t.outerHTML,e,d),offset:e+d}}return _.indexOf(h,o)!==-1?(i=n(t,e),{html:r(t,i.html),offset:i.offset}):void 0}function r(t,e){var i=t.tagName,n=_.toArray(t.attributes).map(function(t){return t.name+'="'+t.value+'"'}).join(" ");return"<"+i+" "+n+">"+e+"</"+i+">"}function s(t,e){var i=new d(t,e);return i.getResult()}var a={makeWord:function(t,e,i){return'<span class="word" data-length="'+i+'" data-offset="'+e+'">'+t+"</span>"},rTwoSpanEnd:/<\/span><\/span>$/},l=["sup","wbr"],h=["em","i","del","a"],c=/mathjax-container/,d=function(t,e){this.contents=[],this.types=[],this.step=-1,this.offset=e,this.iterator=new u(t)};d.prototype.doIterator=function(){var t=function(){this.generatorSpan()};return e.hasBadChineseLineBreak()&&(t=function(){this.detectChinesePunctuation(),this.generatorSpan()}),t}(),d.prototype.detectChinesePunctuation=function(){var t=this.token,e=t.type;this.step<0&&"en"!==e||(this.advanceIsWord()&&this.currentIsType(["punc-not-allowed-at-end","punc-not-allowed-start-and-end"])&&(e="word"),this.step<1&&this.advanceIsType("punc-not-allowed-start-and-end")||e in this.typeHandler&&this.typeHandler[e].call(this))},d.prototype.typeHandler={"punc-not-allowed-at-start":function(){this.currentIsWord()?this.autoWbr():this.step>=1&&this.currentIsType(["punc-not-allowed-at-start","punc-not-allowed-start-and-end"])&&this.currentIsWbred()&&this.insertToPrevWbr()},"punc-not-allowed-start-and-end":function(){this.autoWbr()},en:function(){var t=this.token;t.word.length<=1||(t.html=(this.currentIsType("space")?"":"<wbr>")+t.html.replace('class="word"','class="en word"'))},word:function(){this.autoWbr()},"punc-not-allowed-break":function(){this.currentIsType("punc-not-allowed-break")&&this.autoWbr()}},d.prototype.currentIsWord=function(){return this.isWord(this.types[this.step])},d.prototype.currentIsType=function(t){return this.isType(this.types[this.step],t)},d.prototype.currentIsWbred=function(){return a.rTwoSpanEnd.test(this.contents[this.step])},d.prototype.advanceIsWord=function(){return this.isWord(this.token.type)},d.prototype.advanceIsType=function(t){return this.isType(this.token.type,t)},d.prototype.isType=function(t,e){return _.isArray(e)?_.contains(e,t):e===t},d.prototype.isWord=function(t){return"cjk"===t||"en"===t},d.prototype.generatorSpan=function(){var t=this.token;this.types.push(t.type),this.contents.push(t.html),this.step++},d.prototype.autoWbr=function(){"space"!==this.types[this.step]&&this[this.currentIsWbred()?"insertToPrevWbr":"wrapWbr"]()},d.prototype.wrapWbr=function(){this.contents[this.step]='<span class="wbr">'+this.contents[this.step],this.token.html=this.token.html+"</span>"},d.prototype.insertToPrevWbr=function(){this.contents[this.step]=this.contents[this.step].slice(0,-7),this.token.html+="</span>"},d.prototype.getResult=function(){for(;this.iterator.hasNext();){this.token=this.iterator.next();var t=this.token.word,e=t.length;this.token.html=a.makeWord(_.escape(t),this.offset,e),this.doIterator(),this.offset+=e}return{html:this.contents.join(""),offset:this.offset}};var u=function(t){this.node=t,this.current=null,this.value=t.nodeValue,this.length=t.length,this.index=0};return _.extend(u.prototype,{rPuncNotAllowedAtStart:/[\!%\),\.:;\?\]\}¢°’”‟›℃∶、。》〕〗〞﹚﹜！％），．：；？］｝]/,rPuncNotAllowedAtEnd:/[$(£¥﹙﹛《〈「『〔〖〝＄（．［｛￡￥]/,rPuncNotAllowedBreak:/[—…‥]/,rPuncNotAllowedStartAndEnd:/[“”‘’'"]/,rEnPunc:/[\x21-\x23\x25-\x2A\x2C-\x2F\x3A\x3B\x3F\x40\x5B-\x5D\x5F\x7B\x7D\xA1\xAB\xAD\xB7\xBB\xBF\u0374\u0375\u037E\u0387\u055A-\u055F\u0589\u05BE\u05C0\u05C3\u05F3\u05F4\u060C\u061B\u061F\u066A-\u066D\u06D4\u0964\u0965\u0970\u0E2F\u0E5A\u0E5B\u0EAF\u0F04-\u0F12\u0F3A-\u0F3D\u0F85\u10FB\u2010-\u2027\u2030-\u2043\u2045\u2046\u207D\u207E\u208D\u208E\u2329\u232A\u3001-\u3003\u3006\u3008-\u3011\u3014-\u301F\u3030\u30FB\uFD3E\uFD3F\uFE30-\uFE44\uFE49-\uFE52\uFE54-\uFE61\uFE63\uFE68\uFE6A\uFE6B\uFF01-\uFF03\uFF05-\uFF0A\uFF0C-\uFF0F\uFF1A\uFF1B\uFF1F\uFF20\uFF3B-\uFF3D\uFF3F\uFF5B\uFF5D\uFF61-\uFF65]/,rIgnorePunc:/[「\《\[\（\(\)\）\]\》」]/,hasNext:function(){return this.index<this.length},next:function(){var t=this.getWholeWord(),e=t[0],i=t[1];return this.index+=e.length,this.current={word:e,type:i},this.current}}),u.prototype.isEnWord=function(t,e){var i=(t>=33&&t<=591||this.rEnPunc.test(e))&&!this.rIgnorePunc.test(e);return i},u.prototype.getWholeWord=function(){var t=this.value,e=this.index,i=t.charCodeAt(e),n=t.charAt(e),o="";if(isNaN(i))return[];if(32===i){do o+=t.charAt(e++);while(32===t.charCodeAt(e));return[o,"space"]}if(this.rPuncNotAllowedStartAndEnd.test(n))return[n,"punc-not-allowed-start-and-end"];if(this.rPuncNotAllowedAtStart.test(n))return[n,"punc-not-allowed-at-start"];if(this.rPuncNotAllowedAtEnd.test(n))return[n,"punc-not-allowed-at-end"];if(this.rPuncNotAllowedBreak.test(n))return[n,"punc-not-allowed-break"];if(this.isEnWord(i,n)){var r=i,s=n;do o+=s,s=t.charAt(++e),r=t.charCodeAt(e);while(this.isEnWord(r,s));return[o,"en"]}if(i<55296||i>57343)return[n,"cjk"];if(55296<=i&&i<=56319){if(t.length<=e+1)throw"High surrogate without following low surrogate";var a=t.charCodeAt(e+1);if(56320>a||a>57343)throw"High surrogate without following low surrogate";return[n+t.charAt(e+1),"cjk"]}if(0===e)throw"Low surrogate without preceding high surrogate";var l=t.charCodeAt(e-1);if(55296>l||l>56319)throw"Low surrogate without preceding high surrogate";return[]},i}.apply(e,n),!(void 0!==o&&(t.exports=o))},function(t,e,i){var n,o;n=[i(6),i(2),i(3),i(22),i(175),i(145),i(159)],o=function($,t,_,e,i,n,o){var r=t.View.extend({className:"markings-layer",initialize:function(t){this.contentContainer=t.contentContainer},render:function(){var t=this.contentContainer.content.height()+20;return this.$el.css({top:-t}),this},empty:function(){return this.$el.empty(),this},renderUnderline:function(t){var e=$("<div>",{"class":"page-marking-container"});e.html(this._getUnderlineView(t)),this.$el.html(e)},getCurrentMarkingPosition:function(){return this.$(".marking").position()},_getUnderlineView:function(t){t.isMine();return this.addSubView(new o({model:t,paragraphs:this.contentContainer.jqParas,plotOptions:{containerAttrs:{"class":"fake-content-container",css:this.contentContainer.hasScroll?{overflowY:"scroll"}:{}},isDrawInArticle:!1}})).render().el}});return _.extend(r.prototype,n),r}.apply(e,n),!(void 0!==o&&(t.exports=o))},function(t,e,i){var n,o;n=[i(6),i(2),i(3),i(22),i(173),i(45),i(179)],o=function($,t,_,e,i,n,o){return t.View.extend(_.extend({tmplHtml:$("#tmpl-single-annotation-overlay").html(),className:"annotations-overlay-wrapper",initialize:function(e){this.overlayModel=new t.Model({}),e.pid&&this.overlayModel.set("pid",e.pid),this.overlayModel.on("remove:view",function(){this.remove().trigger("removed")},this),this.on("appended",function(t){this.contentContainer.loadFigures().renderMarkingManager().renderUnderline(this.model).scrollToCurrentMarking(),this.noteSection.trigger("create:noteTip",{renderTo:t.el}),this.annotationComments.updateListHeight()},this)},render:function(){this.$el.html(this.tmplHtml),this.overlayContainer=this.$(".annotations-overlay"),this.sideSection=this.$(".side");var t=new o({model:this.model,overlayModel:this.overlayModel});return this.noteSection=t,this.annotationComments=new n({markingModel:this.model,className:"single-annotation-overlay-comments",commentFormIsTop:!1,commentTargetInfo:{article:{authorId:e.getModel("article").get("authorId")}}}),this.$(".main").append(t.render().$el).append(this.annotationComments.render().$el),this.createContentContainer(this.getContents()),this},getContents:function(){var t=e.getModel("content");return _.chain(this.model.getContainerIds()).filter(function(e){return t.canPidRender(e)}).map(function(e){return t.getParagraph(e)}).value()}},i))}.apply(e,n),!(void 0!==o&&(t.exports=o))},function(t,e,i){var n,o;n=[i(6),i(2),i(3),i(22),i(167),i(180),i(172),i(49)],o=function($,t,_,e,i,n,o,r){var s=t.View.extend({className:"note-section",tmpl:$("#tmpl-single-note").html(),tmplNoteActions:$("#tmpl-single-note-actions").html(),tmplFavoriteText:$("#tmpl-annotation-favorite-text").html(),initialize:function(t){this.overlayModel=t.overlayModel,this.on("create:noteTip",function(t){this.createNoteTip(t)},this),this.listenTo(this.model,"change:note",function(t,e){this.$(".note").text(e)},this).listenTo(this.model,"change:n_comments",function(t,e){this.$(".comments-num").text(e)}).listenTo(this.model,"change:n_favorites",this.updateFavorite,this).listenTo(this.model,"change:visible_private",this.updatePrivate,this),this.$el.on("removing",_.bind(function(){this.stopListening()},this))},events:{"click .share":"shareNote","click .edit":"editNote","click .delete":"deleteNote","click .favorite":"favoriteNote","click .lnk-para-annotations":"lnkParaAnnotations"},render:function(){return this.$el.html(this.getSingleNoteHtml()),this.favoriteText=this.$(".favorite"),this.privateTextWrapper=this.$(".private-info-wrapper"),this.shareWrapper=this.$(".share-wrapper"),this.updateFavorite(this.model),this.updatePrivate(this.model),this},updateFavorite:function(t){if(this.favoriteText.length){var e=t.toJSON();e.isFavorited=t.isFavorited(),this.favoriteText.html(_.template(this.tmplFavoriteText,e))}},updatePrivate:function(t){if(this.privateTextWrapper.length){var e=t.isPrivate();this.privateTextWrapper[e?"show":"hide"](),this.shareWrapper[e?"hide":"show"]()}},lnkParaAnnotations:function(t){t.preventDefault(),this.openParaAnnotations()},openParaAnnotations:function(){var t=this.overlayModel.get("pid")||this.model.get("endContainerId");this.overlayModel.trigger("remove:view"),e.vent.trigger("open:paraAnnotationsOverlay",t)},createNoteTip:function(t){this.noteTip=new n(t)},getSingleNoteHtml:function(){var t=this.model.toJSON(),i=t.owner.user_id;return _.template(this.tmpl,_.extend(t,{noteActionsHtml:this.getNoteActionsHtml(),printTime:o,isPrivate:this.model.isPrivate(),isArticleAuthor:i===e.getModel("article").get("authorId"),autoLink:r}))},getNoteActionsHtml:function(){return _.template(this.tmplNoteActions,_.extend(this.model.toJSON(),{actions:this.model.getActionsList(),isPrivate:this.model.isPrivate(),isMine:this.model.isMine()}))}});return _.extend(s.prototype,i,{loginRedirectType:"overlay",_getNoteModel:function(){return this.model},deleteNote:function(t){var e=i.deleteNote.call(this,t);e&&this.openParaAnnotations()},_setTarget:!0}),s}.apply(e,n),!(void 0!==o&&(t.exports=o))},function(t,e,i){var n,o;n=[i(6),i(3),i(2),i(94),i(181)],o=function($,_,t,e,i){var n=$(window),o=$.trim($("#tmpl-tooltip").html()),r="tooltip",s=15,a={html:o,id:""},l=e.extend({_super:e.prototype,constructor:function(t){t=$.extend({},a,t),this._super.constructor.call(this,t),this.setUpEvents()},set:function(t){return _.extend(this,{preferedDirection:"up"},_.pick(t,"target","preferedDirection")),this.setClass(t.className),this._super.set.call(this,t)},hide:function(){return this._super.hide.call(this)},setPosition:function(t,e){e=e||this.opt.arrowHeight||0;var o,r,a,l,h,c=3,d=t instanceof $,u=this._node.outerHeight()+c+e,p=this._node.outerWidth(),f=p/2,g=n.width(),m=n.height(),v=0;if(d){var y=this.getOffsetWithin(t),b=t[0].getBoundingClientRect();h={top:y.top,left:y.left,bcrLeft:b.left,bcrRight:b.right,bcrTop:b.top,bcrBottom:b.bottom,height:t.outerHeight(),width:t.outerWidth()}}else h=_.clone(t),_.extend(h,{bcrLeft:h.left,bcrRight:h.left+h.width,bcrTop:h.top-this.body.scrollTop()}),h.bcrBottom=h.bcrTop+(h.height||0);return o={},r=!0,"down"===this.preferedDirection&&h.bcrBottom+u<m&&(r=!1),h.bcrTop<u&&(r=!1),r?o.top=h.top-u:o.top=h.top+h.height+e+c,o.left=h.left-(p-h.width)/2,a=g-h.bcrRight-f+h.width/2-s,l=h.bcrLeft-f+h.width/2-s,a<0?v=a:l<0&&(v=-l),o.left=o.left+v,i(this._node,{backgroundColor:this._node.css("background-color")||"transparent",borderColor:this._node.css("border-left-color")||"transparent",arrowWidth:e,borderSize:1,orention:r?"bottom":"top",offset:p/2-v}),this._node.css(o),this},update:function(t){this.setPosition(this.target,t)},setClass:function(t){return this._node[0].className=r+(t?" "+t:""),this},setUpEvents:function(){var t=this;this.body.on("mousedown",function(e){var i=$(e.target),n=i.parents().andSelf();n.is(t._node)||t.hide()}),this._node.on("click mouseup",function(t){t.stopPropagation()})}});return l}.apply(e,n),!(void 0!==o&&(t.exports=o))},function(t,e,i){var n,o;n=[i(6),i(3),i(2)],o=function($,_,t){var e={backgroundColor:"",borderColor:"",arrowHeight:"",borderSize:"",offset:"",orention:"",arrowWidth:""},i={top:"left",bottom:"left",right:"top",left:"top"},n={top:"bottom",bottom:"top",left:"right",right:"left"};return function(t,o){t.find("._arrow-box").remove(),o=_.defaults(o,e),o.arrowHeight||(o.arrowHeight=o.arrowWidth);var r=$("<div>"),s=$("<div>"),a=n[o.orention],l=i[o.orention],h={"border-style":"solid","border-color":"transparent",hegiht:0,position:"absolute"};h[a]="100%";var c={"border-width":o.arrowHeight+"px "+o.arrowWidth+"px"};c["border-"+a+"-color"]=o.backgroundColor,c[l]=o.offset,c["margin-"+l]=-o.arrowHeight+"px";var d=o.arrowHeight+o.borderSize,u=o.arrowWidth+o.borderSize,p={"border-width":d+"px "+u+"px"};p["border-"+a+"-color"]=o.borderColor,p[l]=o.offset,p["margin-"+l]=-d+"px",$().add(s).add(r).css(h).css({"border-color":"transparent"}).addClass("_arrow-box"),s.css(c).addClass("arrow-inner"),r.css(p).addClass("arrow-outer"),t.append(r).append(s)}}.apply(e,n),!(void 0!==o&&(t.exports=o))},function(t,e,i){var n,o;n=[i(6),i(3),i(2),i(54)],o=function($,_,t,e){function i(t){_.bindAll(this,"close"),t=_.defaults(t||{},n),_.extend(this,t),this.overlay=e({klass:"alert-overlay"}),this.render(t.html).open()}var n={html:"",closeSelector:".close, .confirm",contentSelector:".content"};return _.extend(i.prototype,t.Events,{render:function(t){return this.el=$(t||this.html),this.overlay.setBody(this.el),this.deletgateEvent(),this},deletgateEvent:function(){return this.el.on("click.alert",this.closeSelector,this.close),this},undelegateEvent:function(){return this.el.off(".alert"),this},open:function(){return this.overlay.open(),this.trigger("opened"),this},close:function(t){t.preventDefault();var e=$(t.currentTarget),i=e.data("name");return this.overlay.close(),this.trigger("closed",i),this}}),i}.apply(e,n),!(void 0!==o&&(t.exports=o))},function(t,e,i){var n,o;n=[i(3),i(6),i(22),i(175),i(124)],o=function(_,$,t,e,i){function n(i){var n=$("<div>"),o=t.getModel("content").getParagraph(i);return n.html(e(o)),n.find("p")}function o(e){var o={pagination:0},r=t.getModel("content"),s=r.findPaginations(e.pid);if(!s)return o.error=!0,o;if(1===s.length)o.pagination=s[0];else if(s.length>1){var a,l=n(e.pid),h=i(l),c=s[0],d=r.findPageOffsetInfo(e.pid);$.each(s,function(t,i){return a=d[t],!(e.offset<h.index.offset[a])&&void(c=i)}),o.pagination=c}return o}return{getByStamp:o}}.apply(e,n),!(void 0!==o&&(t.exports=o))},function(t,e,i){var n,o;n=[i(2),i(3),i(6),i(22),i(186),i(185),i(187),i(188),i(183),i(44)],o=function(t,_,$,e,i,n,o,r,s,a){var l=t.View.extend({el:".bookmarks-layout",events:{"click .bookmark":"toggleBookmark"},initialize:function(t){return _.bindAll(this,"showOrHideBookmark","toggleBookmark","renderBookmark"),this.app=e,this.vent=e.vent,this.config=t.config,this.vent.on({"render:bookmark":this.renderBookmark,"hover:page":this.showOrHideBookmark}),this},render:function(t){return this.articleModel=t.article,this.worksId=this.articleModel.id,this.contentModel=t.contentModel,this.toc=this.contentModel.contents,this.hasToc=!!this.toc.length,this.isGift=this.articleModel.get("isGift"),this.collection=new n([],{articleId:this.worksId,contentModel:this.contentModel}),this.bookmark=this.$el.find(".bookmark"),this.collection.fetch(),this.tocPageNumbers=this.contentModel.getTocPageNumbers(),this.listenTo(this.collection,"reset add remove",_.bind(function(){this.articleModel.bookmarks=this.collection},this)),this},getPagePids:function(t){var e=$("[data-pagination="+t+"]"),i=e.find("p[data-pid]"),n=[];return _.each(i,function(t){n.push($(t).data("pid")+"")}),n},getCurrPage:function(){return e.getModel("turning").get("currPage")},newBookmarkAttrs:r,renderBookmark:function(){var t=this.getCurrPage();if(this.isBookmarkKeepHiding())return this.bookmark.hide(),this;if(!this.collection.length)return this.deactive();var e=this.getPagePids(t),i=this.collection.getPids(),n=_.intersection(i,e);this.contentModel.findPaginations(n);if(_.contains(i,0)){var o=this.collection.where({paragraph_id:0}),r=_.map(o,function(t){return t.get("part_sequence")}),l=_.indexOf(this.tocPageNumbers,t),h=_.contains(r,l);if(!this.hasToc&&1===t||this.hasToc&&h){var c=r[_.indexOf(r,l)];return this.model=this.collection.findWhere({part_sequence:c}),this.active()}}if(this.model=this.collection.findWhere({paragraph_id:n[0]}),!this.model)return this.deactive();var d=this.model.get("paragraph_offset"),u=new a({pid:n[0],offset:d}),p=s.getByStamp(u);return p.pagination!==t?this.deactive():this.active()},isBookmarkKeepHiding:function(){if(!e.hasModel("turning")||!e.getModel("turning").isPageTurned())return!0;var t=(this.getCurrPage(),e.getModel("turning").currIsGiftPage()),i=e.getModel("config").get("isChapter")&&e.getModel("chapters").currChapterNeedBuy();return t||i},showOrHideBookmark:function(t){this.isBookmarkKeepHiding()||!this.bookmark||this.bookmark.hasClass("active")||t.relatedTarget&&/bookmark|inner/.test(t.relatedTarget.className)||("mouseenter"===t.type?this.bookmark.stop(!0,!0).show():this.bookmark.fadeOut())}});return _.extend(l.prototype,o),l}.apply(e,n),!(void 0!==o&&(t.exports=o))},function(t,e,i){var n,o;n=[i(2),i(3),i(6),i(186)],o=function(t,_,$,e){var i=t.Collection.extend({model:e,url:function(){return"/j/bookmark/gets_by_works?works_id="+this.articleId},initialize:function(t,e){this.articleId=e.articleId,this.contentModel=e.contentModel,this.parasIndexs=this.contentModel.parasIndexs},getPids:function(){return this.pluck("paragraph_id")},comparator:function(t){return _.indexOf(this.parasIndexs,t.get("paragraph_id"))}});return i}.apply(e,n),!(void 0!==o&&(t.exports=o))},function(t,e,i){var n,o;n=[i(2),i(3),i(6)],o=function(t,_,$){var e=t.Model.extend({url:"/j/bookmark/",defaults:{"abstract":"",paragraph_id:"",paragraph_offset:0,works_id:"",part_paragraph_sequence:0,part_sequence:0,percent:"0.00"},_mixInData:function(t,e){return t=t?_.clone(t):{},t.data=_.extend({},t.data,e),t},destroy:function(e){return e=this._mixInData(e,{bookmark_id:this.id}),t.Model.prototype.destroy.call(this,e)},sync:function(e,i,n){if(/create|delete/.test(e))return n.url=this.url+e,t.sync(e,i,n)},parse:function(t){return t},getStamp:function(){return{pid:this.get("paragraph_id"),offset:this.get("paragraph_offset"),sequence:this.get("part_sequence")}},getPercent:function(){if(!this.collection)return"< 1";var t=this.getSequence()/this.collection.contentModel.parasIndexs.length;return t*=100,t=Math.round(t),t=t?t:"< 1"},getSequence:function(){return this.collection?_.indexOf(this.collection.contentModel.parasIndexs,this.get("paragraph_id")):0}});return e}.apply(e,n),!(void 0!==o&&(t.exports=o))},function(t,e,i){var n,o;n=[i(3),i(186)],o=function(_,t,e){return{addBookmark:function(){this.model=new t({works_id:this.worksId});var e;try{e=this.newBookmarkAttrs()}catch(i){if("NoParagraph"===i.message)return;throw i}this.model.save(e).done(_.bind(function(t){this.collection.add(this.model)},this)),this.active()},removeBookmark:function(){this.model.destroy(),delete this.model,this.deactive()},toggleBookmark:function(){return!this.model||this.model.isNew()?this.addBookmark():this.removeBookmark(),this},active:function(){return this.bookmark.addClass("active").show(),this},deactive:function(t){return this.bookmark.removeClass("active"),this}}}.apply(e,n),!(void 0!==o&&(t.exports=o))},function(t,e,i){var n,o;n=[i(3),i(6),i(22),i(189)],o=function(_,$,t,e){function i(){return t.getModel("turning").get("currPage")}function n(e){var i=t.getModel("content"),n={partIndex:0,parasIndex:0},o=i.getPartPidsArray();return _.each(o,function(t,i){var o=_.indexOf(t,e);o!==-1&&(n={partIndex:i,parasIndex:o})}),n}function o(o){o=o||i();var r=t.getModel("content"),s=e(o),a=s.pid||0,l=s.offset||0,h=n(a),c=h.partIndex;return a||(c=_.indexOf(r.getTocPageNumbers(),o)),{paragraph_id:a,paragraph_offset:l,part_sequence:c,part_paragraph_sequence:h.parasIndex}}return o}.apply(e,n),!(void 0!==o&&(t.exports=o))},function(t,e,i){var n,o;n=[i(3),i(6),i(22),i(44),i(124)],o=function(_,$,t,e,i){function n(n){var o=t.getModel("content"),r=o.body[n-1],s=new e({pid:null,offset:0});if(r.stamp)return r.stamp;var a=r.paragraphs;if(!(a&&a.length&&a[0]&&a[0].pid))throw new Error("NoParagraph");var l=a[0];s.pid=l.pid;var h=$("[data-pagination="+n+"]"),c=!!h.length;if(c&&o.isPara(l)){var d=o.findStampOffset(s.pid,n);if(!d)return s;var u=h.find("p[data-pid="+s.pid+"]"),p=i(u),f=p.index.offset[d];s.offset=f}return c&&(r.stamp=s),s}return n}.apply(e,n),!(void 0!==o&&(t.exports=o))},function(t,e,i){var n,o;n=[i(3),i(2),i(22),i(103),i(9)],o=function(_,t,e,i,n){var o=t.Model.extend({defaults:{id:"",title:"",price:0,progress:0,totalPages:0,purchaseTime:0,hasAdded:0,defaultSharingText:"",isGift:!1,isSample:!1,hasFormula:!1,"abstract":"",dataFromLocal:!1,cover_url:"",onsaleTime:""},url:function(){return"/j/article_v2/"+this.id+"/"},initialize:function(){this.createRating()},isLoaded:function(){return!!this.get("title")},createRating:function(){var t=new i({articleId:this.id});return this.get("isSample")?(t.set("failed",!0),t.set("synced",!0)):t.fetch().fail(function(){t.set("failed",!0)}).always(function(){t.set("synced",!0)}),this._rating=t,t},getRating:function(){return this._rating},archive:function(){var t=this.url()+"archive",e=this;return n.request("POST",t).done(function(){e.set({isArchived:!0})})},getBookUrl:function(t){t=t||{};var e=t.ignoreSearch?"":location.search,i=["ebook",this.id,e?e:""].join("/");return i},urlInMobileStore:function(){return"/ebook/"+this.get("id")},isFree:function(){return 0===+this.get("price")},updatePrice:function(){this.id&&n("/j/article_v2/"+this.id+"/price").done(_.bind(function(t){this.set("price",+t.price)},this))},checkPricePeriodically:function(){this._checkPriceTimerId=setInterval(_.bind(function(){this.updatePrice()},this),6e5)},unbindAll:function(){this._checkPriceTimerId&&clearInterval(this._checkPriceTimerId)}});return window.Article=o,o}.apply(e,n),!(void 0!==o&&(t.exports=o))},function(t,e,i){var n,o;n=[i(3),i(2)],o=function(_,t){var e=t.Model.extend({defaults:{n_reviews:0},url:function(){return"/j/ebook/"+this.articleId+"/n_reviews"},parse:function(t){return{n_reviews:t}},initialize:function(t,e){this.articleId=e.articleId}});return e}.apply(e,n),!(void 0!==o&&(t.exports=o))},function(t,e,i){var n,o;n=[i(6),i(3),i(2),i(94),i(29)],o=function($,_,t,e,i){var n=$(window),o=".tips-outer",r=(i.hasTouch()?"tap.tips":"click.tips",$.trim($("#tmpl-tips").html())),s={horizontal:{percent:[.3,.7],direct:["left","center","right"]}},a={left:.1,center:.5,right:.9},l=10,h={top:"initial",bottom:"initial",right:"initial",left:"initial"},c={html:r,contentClass:".footnote"},d=e.extend({_super:e.prototype,constructor:function(t){t=$.extend({},c,t),this.removeAll(),this._super.constructor.call(this,t)},_getDirection:function(t){var e=this.getOffsetWithin(t),i=e.left/n.width(),o=(e.top/n.height(),s.horizontal);return{horizontal:o.direct[_.sortedIndex(o.percent,i)],vertical:e.top-this._node.outerHeight()-12<0?"top":"bottom"}},setPosition:function(t){var e=$(t),i=this.getOffsetWithin(e),n=this._node.outerWidth(),o=this._node.outerHeight(),r=this._getDirection.call(this,e),s=_.clone(h);return s.left=i.left+e.width()/2-n*a[r.horizontal],"top"===r.vertical?s.top=i.top+l+e.height():s.top=i.top-l-o,this._node[0].className=this._node[0].className.replace(/\s*arrow-\w+\s*/g," "),this._node.addClass("arrow-"+r.vertical).addClass("arrow-"+r.horizontal).css(s),this.opt.width&&this._node.width(this.opt.width),this},update:function(){return this._super.update.apply(this,arguments),this},removeAll:function(){var t=$(o);t.length&&t.remove()},destroy:function(){var t=this;this._node.fadeOut(200,function(){t._super.destroy.apply(t,arguments)})},onClickOutside:function(){this.destroy()}});return d}.apply(e,n),!(void 0!==o&&(t.exports=o))},,function(t,e,i){var n,o,r=Object.assign||function(t){for(var e=1;e<arguments.length;e++){var i=arguments[e];for(var n in i)Object.prototype.hasOwnProperty.call(i,n)&&(t[n]=i[n])}return t};n=[i(6),i(3),i(21),i(22),i(195),i(29),i(196),i(197),i(78),i(198)],o=function($,_,t,e,i,n,o,s,a,l){function h(t,e){return+t/(e||16)}function c(t,e){var i=t%e;return t+(e-i)}function d(t,e){var i=Math.round(t/e);return e*i}function u(t,e,i){return i>.8*Math.min(e,t)}function p(t,e,i){var n=t.outerHeight(!0)/i.lineHeight;return e-n>=0}function f(n){function f(){return H.length+1}function w(t,e){t&&(z[t]?z[t].push(e):z[t]=[e])}function k(t,e){j[t]=_.pick(e,"text","klass","pid","type")}function T(){return{paragraphs:[],pagination:f()}}function C(){var t,e,o=F.find(".story"),r=L||x;_.each(o,function(i,n){i=$(i),t=i.find(".info"),e=i.find("p"),R=T(),U=B,r&&M(t),S(e)}),F.css("visibility","visible"),A.resolve(new i({body:H,posts:G,gift:q,pidAndPageMap:z,pidAndParaMap:j,pageAndOffsetRowMap:V,originToc:n.data.toc}))}function M(t){var e=c(t.height(),I)/I+O;W=t.find(g).text(),U-=e,R.info={title:W,subtitle:t.find(m).text(),orig_author:t.find(v).text(),translator:t.find(y).text(),height:h(e*I)},R.content={height:h(N-e*I)}}function S(t){function e(t){return/code|paragraph/.test(t)||"throughPage"===n.illusMode&&/illus/.test(t)}function i(t,e){return!e&&!/custom/.test(t)}function o(){var t=parseInt(s.attr("group-item-index"),10),e=parseInt(s.attr("depth"),10),i={};return _.isNaN(t)||(i.groupItemIndex=t),_.isNaN(e)||(i.depth=e),r({text:b,klass:v,pid:l,type:y},i)}var s,l,f,g,m,v,y,b,x,C,M,S,A,E,D,F,L,O,z,j,W={};x=t.length,_.each(t,function(t,r){if(s=$(t),W={},s.hasClass("pagebreak")&&!P&&U>=0)return R.breaked=!0,void(U=0);if(l=s.data("pid")+"",b=$.trim(s.html()),v=s.attr("class"),M=e(v),S=i(v,M),j=/illus|code/.exec(v),y=j&&j[0]||"paragraph",F=D,D=v.indexOf("headline")!==-1,L=!1,r&&F&&D&&(L="vertical"===n.layout||p(s,U,n),L?(s.addClass("continuous-headline"),v=s.attr("class")):s.addClass("continuous-headline-breaked-by-page")),g=s.outerHeight(!0),m=g-s.height(),A=g%I!==0,A&&(g=D?d(g,I):c(g,I)),f=g/I,E=g>N&&!M,D&&!L&&n.avoidBottomHeadline&&U>0&&U-f<=0&&(U=0),0===U&&(H.push(R),R=T(),U=B),U-=f,(U>=0||U<0&&f>1&&M)&&(A&&(W.height=h(g-m)),C=_.extend(o(),W),R.paragraphs.push(C),w(l,R.pagination)),U<0&&S){var G=(f+U)*I;u(g,N,G)&&(a.resizeIllusElem(s,{maxHeight:G}),b=$.trim(s.html()),C=_.extend(o(),W),R.paragraphs.push(C),w(l,R.pagination),U=0)}U<0&&!function q(){W={},H.push(R),R=T(),E&&(f=B),O=U+f,z=O*I,A&&(W.height=h((E?N:g)-m)),M&&(W.offset=h(z)),C=_.extend(o(),W),R.paragraphs.push(C),w(l,R.pagination),M&&(V[l]?V[l].push(O):V[l]=[0,O]),M?U+=B:U=B-f,U<0&&q()}(),k(l,C),r+1===x&&H.push(R)})}n=_.defaults(n,{lineHeight:32,pageHeight:768,layout:"horizontal"}),_.isBoolean(n.illusMode)||(n.illusMode="horizontal"===n.layout?"zoom":"throughPage"),_.isBoolean(n.avoidBottomHeadline)||(n.avoidBottomHeadline="horizontal"===n.layout);var A=$.Deferred(),I=n.lineHeight,N=n.pageHeight,E=n.metadata.hasFormula,D=$(".loading-hint"),F=n.typePage.find(".content"),B=N/I,L=_.last(n.data.toc).part_no>0,O=2,H=[],R={},z={},j={},V={},W="",U=0,G=n.data.posts,q=n.data.gift,J=n.data.metaData;return e.pageInfo={pageHeight:N},!Ark.features["reader/katex"]&&b&&E&&!o()?(D.remove(),F.html($("#tmpl-mathplayer-hint").html()),A.reject(),A.promise()):(q&&H.push({note:{recipient:t.me.name,words:q.words,sender:q.sender,date:q.date},pagination:f()}),x||H.push({titlePageInfo:{title:J.title,subtitle:J.subtitle,author:J.author,translator:J.translator,publisher:J.publisher,provider:J.provider,isOriginWorks:J.isOriginWorks},isTitlePage:!0,pagination:f()}),n.data.splitCode=s,F.css("visibility","hidden").html(_.template(n.template.article,_.extend({figureUtil:a},n.data))),F.find(".illus").each(function(t,e){e=$(e),e.outerHeight(!0)<=N||a.resizeIllusElem(e,{maxHeight:N})}),E?l(F,C):/msie 10.0/i.test(navigator.userAgent)?_.delay(C,180):C(),A.promise())}var g="h1",m="h2",v=".orig-author",y=".translator",b=/msie/i.test(navigator.userAgent),w="c"===t.works.type,x=t.works.isChapter,P=w&&!n.isMobile();return f}.apply(e,n),!(void 0!==o&&(t.exports=o))},function(t,e,i){var n,o;n=[i(3)],o=function(_){var t=["body","posts","gift","originToc","pidAndPageMap","pageAndOffsetRowMap","pidAndParaMap"],e=function(e){_.extend(this,_.pick(e,t)),this.convertPidToString(),this.parasIndexs=this.makeParasIndexs(),this.contents=this.makeContents(),this.addPageTocRef()};return _.extend(e.prototype,{isEmpty:function(){return!this.body},isPara:function(t){return"paragraph"===t.type},getParagraph:function(t){return this.pidAndParaMap[t]},getPage:function(t){return this.body[t-1]},getPages:function(){return Array.prototype.slice.apply(this.body,arguments)},findPaginations:function(t){return this.pidAndPageMap[t]},findPageOffsetInfo:function(t){return this.pageAndOffsetRowMap[t]},findStampOffset:function(t,e){var i=this.findPaginations(t);if(i.length<2)return 0;var n=this.findPageOffsetInfo(t),o=_.indexOf(i,e);return n[o]},isPidExist:function(t){
return t in this.pidAndParaSourceMap},canPidRender:function(t){var e=this.getParaSourceByPid(t);return"pagebreak"!==e.type},getParasIndexs:function(){return this.parasIndexs},getParaSourceByPid:function(t){return this.pidAndParaSourceMap[t]},convertPidToString:function(){_.forEach(this.posts,function(t){_.forEach(t.contents,function(t){t.id+=""})}),_.forEach(this.originToc,function(t){t.paragraph_id+=""})},makeParasIndexs:function(){var t=this.pidAndParaSourceMap={};return _.chain(this.posts).map(function(t){return t.contents}).flatten(!0).map(function(e){var i=e.id;return t[i]=e,i}).value()},makeContents:function(){var t,e,i,n,o=this.posts,r=this.pidAndPageMap,s=this.originToc,a=this.parasIndexs;s=_.chain(s).filter(function(t){return t.level<3}).map(function(s){return s.readable=!1,t=s.paragraph_id,e=s.part_no,t in r&&(s.readable=!0,s.isStoryTitle=!1,s.pageNum=r[t][0],s.sequence=_.indexOf(a,t)),i!==e&&(i=e,s.readable=!!o[e],s.isStoryTitle=!0,n=o[e]&&o[e].contents&&o[e].contents[0]&&_.find(o[e].contents,function(t){return"pagebreak"!==t.type}),t=n&&n.id,t&&(s.pageNum=r[t][0],s.paragraph_id=t,s.sequence=_.indexOf(a,t))),s}).value();var l=this.gift?2:1;return s.unshift({isTitlePage:!0,isStoryTitle:!1,level:0,pageNum:l,paragraph_id:"",part_no:0,readable:!0,sequence:0,title:"版权信息"}),this.gift&&s.unshift({isGiftPage:!0,isStoryTitle:!1,level:0,pageNum:1,paragraph_id:"",part_no:0,readable:!0,sequence:0,title:"赠言"}),s},getPartPidsArray:_.memoize(function(){var t=this.posts,e=[],i=[];return _.each(t,function(t){i=_.chain(t.contents).flatten(!0).map(function(t){return t.id}).value(),e.push(i)}),e}),addPageTocRef:function(){var t,e,i,n,o,r=this.contents,s=this,a=this.getTocPageNumbers();_.each(a,function(l,h){n=r[h],e=n.title,t=a[h+1]||1/0,i=[l-1,t-1],o=s.getPages.apply(s,i),_.each(o,function(t){t.title=e,t.tocItem=n})})},_tocPageNumbers:null,getTocPageNumbers:function(){return this._tocPageNumbers||(this._tocPageNumbers=_.chain(this.contents).map(function(t){return t.pageNum}).filter(function(t){return 0===t||!!t}).value()),this._tocPageNumbers},getTocFromPara:function(t){for(var e=this.parasIndexs.indexOf(t),i=this.contents,n=this.gift?2:1,o=void 0,r=i.length;n<r&&!(i[n].sequence>e);n++)o=i[n];return o}}),e}.apply(e,n),!(void 0!==o&&(t.exports=o))},function(t,e,i){var n;n=function(){return function(){try{new ActiveXObject("MathPlayer.Factory.1");return!0}catch(t){return!1}}}.call(e,i,e,t),!(void 0!==n&&(t.exports=n))},function(t,e,i){var n,o;n=[i(6),i(3)],o=function($,_){var t=/msie 8/i.test(navigator.userAgent),e=function(t){return t};return t&&(e=function(t){var e=t.split("\n");return'<span class="line">'+e.join('</span><span class="line">')+"</span>"},e.doSplit=!0),e}.apply(e,n),!(void 0!==o&&(t.exports=o))},function(t,e,i){var n,o;(function($){"use strict";n=[i(2),i(53),i(90),i(150)],o=function(t,e,n,o){function r(){try{ga("send",{hitType:"event",eventCategory:"reader",eventAction:"latex",eventValue:c,eventLabel:d?"katex":"mathjax"}),h&&ga("send",{hitType:"event",eventCategory:"reader",eventAction:"latexFailed",eventValue:h,eventLabel:d?"katex":"mathjax"})}catch(t){}if(Ark.showTexError&&(window.console&&window.console.info&&(window.console.info("Total: ",c,", Failed: ",h),window.console.info("Duration:",Date.now()-a)),l.length)){var i="<p>"+l.join("</p><p>")+"</p>";e({title:"[仅编辑可见] 公式处理出错 ("+h+")",content:i}).open()}}function s(e,s){a=Date.now(),d?i.e(6,function(t){var i=[t(199)];(function(t){var i;e.find(".mathjax-container").each(function(e,o){i=o.textContent;try{t.render(i,o)}catch(r){n(r.toString()),l.push(r.toString()),h+=1}o.innerHTML='<script type="math/tex">'+i+"</script>"+o.innerHTML,c+=1}),r(),s()}).apply(null,i)}):o(Ark.MathJaxLibUrl,function(){$(".loading-hint").remove();var i=window.MathJax.Hub;c=$(".mathjax-container").length,t.history.bind("all",function(t,e,i){$("#MathJax_Message").is(":visible")&&"home"===i&&(location.href="/reader/")}),i.Register.MessageHook("TeX Jax - parse error",function(t){h+=1,l.push(t.slice(0,-2)),n(t)}),i.Register.MessageHook("Math Processing Error",function(t){h+=1,l.push(t.slice(0,-2)),n(t)}),i.Queue(["Typeset",i,e[0]],[r],[s])})}var a,l=[],h=0,c=0,d=Ark.features["reader/katex"];return s}.apply(e,n),!(void 0!==o&&(t.exports=o))}).call(e,i(6))},,function(t,e,i){var n;n=function(){function t(t){this._key=[],this._tbl={};for(var i=0;i<64;++i)this._key[i]=e.charAt(t[i]),this._tbl[this._key[i]]=i;this._pad=e.charAt(64)}var e="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz$_~";t.prototype.dec=function(e){var i,n,o,r,s=[],a=0,l=0;for(e=e.replace(/[^0-9A-Za-z$_~]/g,"");a<e.length;)i=this._tbl[e.charAt(a++)],n=this._tbl[e.charAt(a++)],o=this._tbl[e.charAt(a++)],r=this._tbl[e.charAt(a++)],s[l++]=i<<2|n>>4,s[l++]=(15&n)<<4|o>>2,s[l++]=(3&o)<<6|r;var h=e.slice(-2);return h.charAt(0)===this._pad?s.length=s.length-2:h.charAt(1)===this._pad&&(s.length=s.length-1),t._1to2(s)},t._1to2=function(t){for(var e="",i=0;i<t.length;++i){var n=t[i];e+=String.fromCharCode(256*n+t[++i])}return e};var i=[37,20,41,59,53,8,24,5,62,31,4,32,6,50,36,63,47,42,30,39,12,3,9,45,29,23,56,2,16,61,52,44,25,35,51,0,13,43,46,40,15,27,17,57,28,54,1,60,21,22,14,49,34,33,10,58,55,19,26,11,18,48,38,7],n=new t(i);return n}.call(e,i,e,t),!(void 0!==n&&(t.exports=n))},function(t,e,i){var n,o;n=[i(6)],o=function($){function t(t){var e=t.find(".ellipsis-main").height(),i=parseInt(t.css("max-height"),10);e>=i?t.find(".ellipsis-prop").height(i):t.find(".ellipsis-end").hide()}return{multiEllipsis:t}}.apply(e,n),!(void 0!==o&&(t.exports=o))},function(t,e,i){var n,o;n=[i(9)],o=function(t){function e(e,i){var n=[i.purchaseTime,0|i.isSample,0|i.isGift].join(":");return t.post("/j/article_v2/need_update",{aid:e,lasttime:n})}return e}.apply(e,n),!(void 0!==o&&(t.exports=o))},function(t,e,i){var n,o;n=[i(3)],o=function(_){function t(){this.bindUnload(),this.confirms={}}return _.extend(t.prototype,{bindUnload:function(){window.onbeforeunload=_.bind(function(){if(!_.isEmpty(this.confirms)){var t=_.map(this.confirms,function(t){return t}).join("\n");return t}},this)},addConfirm:function(t,e){this.confirms[t]=e},removeConfirm:function(t){delete this.confirms[t]},unbind:function(){window.onbeforeunload=null}}),t}.apply(e,n),!(void 0!==o&&(t.exports=o))},function(t,e,i){var n,o;n=[i(6),i(3),i(30),i(205)],o=function($,_,t,e){return function(i,n,o,r){var s,a;s=o.get("isChapter")?"{{= title}} - {{= author}}":'{{= title}} - {{= author}} 著 {{= translator && translator + " 译"}} {{= publisher}}',a=_.template(s,i.metaData),a=$.trim(a),t.isInApp()||(a+=" | 豆瓣阅读"),document.title=a;var l=i.metaData.title;e.setCommonMeta({title:a,desc:"在线阅读《"+l+"》。"+i["abstract"],imageUrl:n.get("cover_url"),url:location.protocol+"//"+location.host+"/"+r.router.getBookUrl({ignoreSearch:!0}),comment:"#"+l+"# "})}}.apply(e,n),!(void 0!==o&&(t.exports=o))},function(t,e,i){var n;(function($){"use strict";n=function(){function t(t,e){var i=$('meta[property="'+t+'"],meta[name="'+t+'"]');i.length||(i=$('<meta name="'+t+'">'),s.append(i)),i.prop("content",e||"")}function e(e){e=e||{},t("weixin:title",e.title),t("weixin:description",e.desc),t("weixin:image",e.imageUrl),t("share:url",e.url)}function i(e){e=e||{},t("description",e.desc),t("twitter:title",e.title),t("twitter:description",e.desc),t("twitter:image",e.doubanImageUrl||e.imageUrl),t("twitter:url",e.url),t("og:title",e.title),t("og:description",e.desc),t("og:image",e.doubanImageUrl||e.imageUrl),t("og:url",e.url),t("share:comment",e.comment)}function n(t){r&&e(t),i(t)}var o=navigator.userAgent,r=o.indexOf("MicroMessenger")!==-1,s=$(document.head);return{setCommonMeta:n,setWeixinMeta:e,setWebMeta:i,setMeta:t}}.call(e,i,e,t),!(void 0!==n&&(t.exports=n))}).call(e,i(6))},function(t,e,i){var n,o;n=[i(3),i(6),i(54),i(30),i(32),i(201)],o=function(_,$,t,e,i,n){function o(t,e){var i=new Image;$(i).one("load",e),r(function(){return i.src=t})}function r(t){var e=/msie 8/i.test(navigator.userAgent);e?_.defer(t):t()}function s(t,r){var s=t.find(".illus img");_.each(s,function(t){var s=$(t),a=s.data(e.isRetina?"orig-src":"src"),l=s.data("has-micro")?"micro":"tiny",c=a.replace(/(common-)\w+/,"$1"+l),d=a.replace(/.+common-(\w+)\/\w+\/(\d+).+/g,"$1$2"),u=s.closest(".illus"),p=u[0].className,f=u.find(".legend");if(/M_L|M_R/g.test(p)&&!i.fitForMobile){var g=18*Math.floor(s.height()/18-1);f.css({width:r-s.parent().outerWidth()-15,"max-height":g})}n.multiEllipsis(f),_.indexOf(h,d)!==-1?s.attr("src",a).addClass("loaded"):!function(){var t=s.clone().addClass("thumbnail");t.attr("src",c),s.before(t),o(c,function(){o(a,function(){s.attr("src",a).addClass("loaded"),h.push(d),t.fadeTo(300,0,function(){return t.remove()})})})}()})}function a(e){var i=e.find("img"),n=e.find(".legend"),o=i.data("orig-width"),r=i.data("orig-height"),s=n.find(".text-content").html(),a=s?"<p>"+s+"</p>":"",l={src:i.data("orig-src"),legend:a,origWidth:o,origHeight:r},h=_.template(c,l);t({body:h,closable:!0}).open(),$(".full-legend").css({width:o+"px"})}function l(e){var i=e.find(".legend"),n=i.find(".text-content").html(),o=n?"<p>"+n+"</p>":"",r={src:"",legend:o,origWidth:0,origHeight:0},s=_.template(c,r);t({body:s,closeable:!0}).open(),$(".full-legend").css({width:400}),$(".orig-illus img").remove()}var h=[],c=$("#tmpl-illus").html();return{loadFigures:s,expandIllus:a,expandCaption:l}}.apply(e,n),!(void 0!==o&&(t.exports=o))},function(t,e,i){var n,o;n=[i(2),i(3),i(6),i(21),i(22),i(61),i(66),i(68)],o=function(t,_,$,e,i,n,o,r){var s=t.View.extend({template:$("#tmpl-extra-controls").html(),events:{"click .btn-purchase":"buy"},initialize:function(){var t=i.getModel("article");this.listenTo(t,"change:price",_.bind(this.render,this))},render:function(){var t=i.getModel("article"),e=t.get("id");return this.$el.html(_.template(this.template,{id:this.articleId,price:t.get("price"),hasAdded:t.get("hasAdded"),isSample:t.get("isSample")})),r.apply({aid:e,title:t.get("title"),wrapper:this.$el,placeholderSel:".btn-adding-wrapper",success:function(){i.getModel("article").set("hasAdded",1),i.vent.trigger("article:hasAdded")}}).render(),this.appendPurchaseButton(t),this},appendPurchaseButton:function(t){var e=o(t,{isLightBtn:!0});e.$(".btn").addBack(".btn").addClass("btn-purchase").removeClass("btn btn-large login"),this.$el.find(".btn-purchase-wrapper").html(e.el),this.purchaseWidget=new n(e.$el)},buy:function(t){t.preventDefault(),e.me.isAnonymous||this.purchaseWidget.doPurchase()}});return s}.apply(e,n),!(void 0!==o&&(t.exports=o))},function(t,e,i){var n,o;n=[i(2),i(3),i(6),i(21),i(22),i(60),i(61),i(66),i(68)],o=function(t,_,$,e,i,n,o,r,s){var a=t.View.extend({template:$("#tmpl-chapter-extra-controls").html(),events:{"click .lnk-subscribe":"subscribeColumn","click .btn-purchase":"buy"},initialize:function(){this.columnModel=i.getModel("column"),this.columnModel.on("change:is_subscribed",this.updateSubscription,this)},render:function(t){var e=i.getModel("column").toJSON();return this.renderHeader(e),this},renderHeader:function(t){this.$el.html(_.template(this.template,{isSubscribed:t.is_subscribed,kind:t.kind,hasFinished:t.has_finished,isAnonymous:e.me.isAnonymous,price:t.price,isSample:t.is_sample,hasAdded:t.is_paid,canSale:t.can_sale}));var i=this.columnModel;t.is_paid||0!==+t.price||s.apply({aid:t.identity,title:t.title,wrapper:this.$el,placeholderSel:".btn-adding-wrapper",success:function(){i.set("is_paid",!0)}}).render(),t.is_sample&&this.appendPurchaseButton(this.columnModel)},buy:function(t){t.preventDefault(),e.me.isAnonymous||this.purchaseWidget.doPurchase()},appendPurchaseButton:function(t){var e=r(t,{isLightBtn:!0});e.$(".btn").addBack(".btn").addClass("btn-purchase").removeClass("btn btn-large login"),this.$el.find(".btn-purchase-wrapper").html(e.el),this.purchaseWidget=new o(e.$el)},updateSubscription:function(t){function e(t){n.toast("订阅成功！"),o.remove(),t&&t()}var i=t.toJSON(),o=this.$(".lnk-subscribe");i.is_subscribed?e():this.renderHeader(i)},subscribeColumn:function(t){if(!e.me.isAnonymous){var o=($(t.currentTarget),i.getModel("column"));n.toast("正在订阅..."),o.subscribe().fail(function(){n.toast("发生了奇怪的错误")})}}});return a}.apply(e,n),!(void 0!==o&&(t.exports=o))},function(t,e,i){var n,o;n=[i(6),i(2),i(3),i(22),i(30),i(117),i(32)],o=function($,t,_,e,i,n,o){function r(t,e){function i(){return Math.abs(s-c)/(r-o)}var o,r,s,c,d=_.throttle(e,h,{leading:!0}),u=_.debounce(e,n.reading.VERTICAL_SCROLLING_DEBOUNCE_LATER);t.on("scroll.slowScroll",_.throttle(function(e){c=t.scrollTop(),r=+new Date,!o||!s||i()<l?d():u(),s=c,o=r},a))}function s(t){t.off("scroll.slowScroll")}var a=100,l=.6,h=800,c=t.View.extend({initialize:function(){_.bindAll(this,"pageJump","verticalScroll","changeLayout","processScrollingEvent"),this.app=e,this.canvas=$(window),this.scrollBody=$("html, body"),this.config=e.getModel("config"),this.vent=this.app.vent,this.vent.on("change:layout",this.changeLayout)},render:function(t){this.articleElement=t,this.pageHeight=this.config.get("pageHeight"),this.pageOffset=this.config.get("pageOffset"),this.changeLayout(this.config.get("layout"))},changeLayout:function(t){this.clearScrollPage(),this.processScrollingEvent(t)},processScrollingEvent:function(t){"vertical"===t?r(this.canvas,this.verticalScroll):s(this.canvas)},getArticleInnerSink:function(){var t=this.app.articleInner.css("paddingTop");return parseInt(t,10)-50},verticalScroll:function(){var t=this.app.getModel("turning");if(!t.isDisabled()){var e=this.getArticleInnerSink(),i=this.canvas.scrollTop(),n=Math.ceil((i-e+1)/this.pageHeight);n=0===n?1:n,t.setCurrPage(n,{preventPageJump:!0}),this.isScrollPageChanged(n)&&this.vent.trigger("render:pages","vertical").trigger("render:bookmark")}},isScrollPageChanged:function(t){return(!this.scrollPage||this.scrollPage!==t)&&(this.scrollPage=t,!0)},clearScrollPage:function(){delete this.scrollPage},pageJump:function(t,e,i){if(!(!e||i&&i.preventPageJump)){var n=this.config.get("layout");o.fitForMobile&&this.vent.trigger("freeze:canvas"),"horizontal"===n?this.horizontalJump(e,i):this.verticalJump(e)}},verticalJump:function(t){var i=this.canvas.scrollTop(),n=e.getModel("turning").previous("currPage")||0,o=Math.abs(t-n),r=this.getArticleInnerSink(),s=(t-1)*this.pageHeight+(1===t?0:r);i===s?(this.verticalScroll(),this.vent.trigger("unfreeze:canvas")):this.scrollBody.animate({scrollTop:s+"px"},1===o?400:0,$.proxy(function(){this.vent.trigger("unfreeze:canvas")},this))},horizontalJump:function(t,n){var o=e.getModel("turning").previous("currPage")||0,r=t>o?1:0,s=this.config.get("pageWidth"),a=Math.abs(t-o),l=r?{right:"auto",left:0}:{right:(t>1?0:-s)-this.pageOffset+"em",left:"auto"},h="-="+s+"em",c={},d=i.hasTouch()&&!n.fromMobileTap?300:1;return this.articleElement.css(l),this.vent.trigger("render:pages","horizontal"),a>1||0===a||!o?(this.articleElement.css({left:1===t?0:-s+"em",right:"auto"}),void this.vent.trigger("unfreeze:canvas render:bookmark").trigger("scroll:page",1)):(c[r?"left":"right"]=h,void this.articleElement.animate(c,d,_.bind(function(){this.vent.trigger("scroll:page",1),this.vent.trigger("unfreeze:canvas render:bookmark")},this)))}});return c}.apply(e,n),!(void 0!==o&&(t.exports=o))},function(t,e,i){var n,o;n=[i(6),i(2),i(3),i(21),i(22),i(9),i(44),i(35),i(50),i(188),i(183)],o=function($,t,_,e,i,n,o,r,s,a,l){var h=t.View.extend({initialize:function(){_.bindAll(this,"loadProgressThenJump","saveReadingProgress","saveProgressLocally"),this.config=i.getModel("config"),i.vent.on("change:layout",this.saveProgressLocally)},tryToGetStamp:function(t){var e=s.getActionOnce("stamp"),i=t.stamp;return!i&&e&&(i=new o(e)),i},gotoStamp:function(t){if(!t)return this.gotoProgressPage(1);this.config.set("ignoreSaveProgress",t.ignoreSaveProgress());var e=l.getByStamp(t).pagination||1,n=i.getModel("article").markings,o=t.getAnnotationJson();this.gotoProgressPage(e),t.hasAnnotation()&&n&&n.add(o,{parse:!0,fakeSync:!_.contains(o.tags,"mine"),dontFilterOut:!0})},fetchProgress:function(t){return n({url:"/j/progress/",data:{works_id:t}})},preloadProgress:function(t){if(!e.me.isAnonymous)return this.progressPromise=this.fetchProgress(t),this.progressPromise},getProgress:function(t){return this.progressPromise?this.progressPromise:this.fetchProgress(t)},gotoProgressPage:function(t){_.isNumber(t)?i.getModel("turning").setCurrPage(t):this.gotoPageByName(t),this.trigger("progress:confirmed")},gotoPageByProgress:function(t){var e=new o({pid:t.paragraph_id,offset:t.paragraph_offset});this.gotoStamp(e)},gotoPageByName:function(t){var e=i.getModel("turning");switch(t){case"first":e.turnFirstPage();break;case"last":e.turnLastPage();break;default:e.turnFirstPage()}},loadProgressThenJump:function(){var t=i.getModel("article"),n=i.getModel("content"),o=t.get("id"),s=this.tryToGetStamp(n),a=n.gift&&!n.gift.opened;if(s)this.gotoStamp(s);else if(this.config.get("jumpFirstPage"))this.config.unset("jumpFirstPage"),i.vent.trigger("chapterTurn:adjacent",{direction:"next"}),this.gotoProgressPage(1);else if(this.config.get("jumpLastPage"))this.config.unset("jumpLastPage"),i.vent.trigger("chapterTurn:adjacent",{direction:"prev"}),this.gotoProgressPage("last");else if(this.config.get("tmpProgress")){var l=this.config.get("tmpProgress");if(this.config.unset("tmpProgress"),l.works_id!==o)return;this.gotoPageByProgress(l)}else if(e.me.isAnonymous){var h=r.getStorageObject(this.getAnonymousProgressKey(o));h?this.gotoPageByProgress(h):this.gotoProgressPage(1)}else a?this.gotoProgressPage(1):this.getProgress(o).done(_.bind(function(t){if(t.r)return this.gotoProgressPage(1);var e=t.progress;return e?void this.gotoPageByProgress(e):this.gotoProgressPage(1)},this)).fail(_.bind(function(){this.gotoProgressPage(1)},this))},saveReadingProgress:_.debounce(function(){var t=i.getModel("turning").get("currPage"),o=i.getModel("article"),s=i.getModel("config"),l=s.get("isChapter")&&i.getModel("chapters").currChapterNeedBuy();if(t&&!i.getModel("turning").currIsGiftPage()&&!l&&!s.get("ignoreSaveProgress")){var h,c=o.id;try{h=a(t)}catch(d){if("NoParagraph"===d.message)return;throw d}if(e.me.isAnonymous)return this.freeUpStorageSpace(),void r.setStorageObject(this.getAnonymousProgressKey(c),h);h.works_id=c,n.post("/j/progress/",h)}},800),getAnonymousProgressKey:function(t){return t+":anonymousProgress"},freeUpStorageSpace:function(){var t=r.keys(),e=/^\d+:anonymousProgress$/;for(t=_.filter(t,function(t){return e.test(t)});t.length>=5;){var i=t.pop();r.remove(i)}},saveProgressLocally:function(){var t,e=i.getModel("turning").get("currPage"),n=i.getModel("article").get("id");try{t=a(e)}catch(o){if("NoParagraph"===o.message)return;throw o}t.works_id=n,i.getModel("config").set("tmpProgress",t)}});return h}.apply(e,n),!(void 0!==o&&(t.exports=o))},function(t,e,i){var n,o;n=[i(6),i(3),i(21),i(22),i(32),i(9),i(212),i(101),i(215),i(102),i(66)],o=function($,_,t,e,i,n,o,r,s,a,l){var h=new s;return{appendResponses:function(t,e){t.append($("#tmpl-responses").html());var i=new r({articleId:e.get("id")}),o=t.find("#like-it"),s=t.find(".like-count");i.on("change:liked",function(t,e){o.toggleClass("liked",!!e)}).on("change:n_like",function(t,e){s.attr("count",e).show()}).fetch(),o.click(function(){i.toggleFavor()});var a=t.find(".read-count");n({url:"/j/article/"+e.id+"/read_count"}).then(function(t){a.attr("count",parseInt(t,10)).show()})},appendSharingButtons:function(e,n){if(e.length&&!e.find(".share-buttons").length){var r=$("#tmpl-sharing-buttons").html(),s="c"===t.works.type&&!i.fitForMobile;s&&!t.me.isAnonymous&&this.appendResponses(e,n),e.append(_.template(r,{size:"large"})),new o({ga:{dcs:"read-reader"}})}},appendRatingSection:function(t,e){if(t.length&&!t.find(".rating-form").length){var i=new a({model:e.getRating()}),n=i.render().$el;i.on("cancel",function(){i.renderForm()}),t.append(n)}},appendReviewsLink:function(t,i,n){function o(t){r.find("a").toggle(!!t).text(t)}var r=t.find(".reviews-link");t.length&&!r.length&&(r=$("<div>",{"class":"reviews-link"}),r.html($("<a>",{href:e.router.getReviewsUrl()})),t.append(r),o(n.get("n_reviews")),n.on("change:n_reviews",o))},appendPurchaseGuide:function(t,i){function n(){o.html(h.render({model:i}).el),o.find(".purchase-section").html(l(i).$el),_.delay(function(){e.utils.applyPurchaseWithIn("[data-widget=faster-purchase]",".purchase-guide")},0)}var o=t.find(".sample-text");t.length&&!o.length&&(o=$("<div>",{"class":"sample-text"}),t.append(o),n(),i.off("change:price",null,this),i.on("change:price",n,this))}}}.apply(e,n),!(void 0!==o&&(t.exports=o))},function(t,e,i){var n,o;(function($){"use strict";n=[i(53),i(213),i(214)],o=function(t,e,i){function n(e,i){var n=$(r),s=n.find(".qr-container");new o(s[0],{text:e.url,width:200,height:200});return s.find("table").css("margin","auto"),function(){return t({title:i.label,content:n}).addClass("wechat-qrcode-dialog").open()}}var o=i||window.QRCode,r=$("#tmpl-wechat-share").html();return e.addSnsOption({wechat:{id:"wechat",label:"分享到微信",className:"rec-wechat",onClickify:n}}),e}.apply(e,n),!(void 0!==o&&(t.exports=o))}).call(e,i(6))},function(t,e,i){var n,o;(function($){"use strict";n=[i(28),i(12)],o=function(t,e){function i(e,i,n){if(n.ga){var o=$.extend({},n.ga);o.dcm=i.id,e=t.addParam(e,o)}return e}function n(t,e,i){return i||(i="…"),t?t.length<=e?t:t.substr(0,e)+i:""}function o(t){var e=$('meta[property="N"],meta[name="N"]'.replace(/N/g,t));return e.last().attr("content")}function r(){return{wrapperSel:".share-buttons",wrapper:void 0,title:o("twitter:title")||document.title,desc:o("twitter:description")||o("description"),url:o("twitter:url")||location.href,imageUrl:o("twitter:image")||o("weixin:image"),comment:o("share:comment")||"",ga:{dcs:"not-set"},urlWrapper:i}}function s(t,e){this.options=$.extend({},r(),t),this.snsOptions=$.extend(!0,{},a,e),this.options.desc&&(this.options.desc=n(this.options.desc,160)),this.init()}var a={douban:{id:"douban",label:"豆瓣",popup:{width:660,height:400},className:"rec-douban",urlTmpl:"http://www.douban.com/share/service?bm=1&sel=222&image={{= encodeURIComponent(imageUrl)}}&href={{= encodeURIComponent(url)}}&name={{= encodeURIComponent(title)}}&text={{= encodeURIComponent(desc)}}&comment={{= encodeURIComponent(comment)}}"},doubanDialog:{id:"douban-dialog",label:"豆瓣",className:"rec-douban-dialog"},qqim:{id:"qqim",label:"QQ好友",popup:{width:1e3,height:760},className:"rec-qqim",urlTmpl:'http://connect.qq.com/widget/shareqq/index.html?site={{= encodeURIComponent("豆瓣")}}&url={{= encodeURIComponent(url)}}&desc={{= encodeURIComponent(title)}}&pics={{= encodeURIComponent(imageUrl)}}'},qzone:{id:"qzone",label:"QQ空间",className:"rec-qzone",urlTmpl:"http://sns.qzone.qq.com/cgi-bin/qzshare/cgi_qzshare_onekey?url={{= encodeURIComponent(url)}}&title={{= encodeURIComponent(title)}}&summary={{= encodeURIComponent(desc)}}&pics={{= encodeURIComponent(imageUrl)}}"},weibo:{id:"weibo",label:"新浪微博",className:"rec-weibo",apiKey:"3015934887",popup:{width:650,height:400},urlTmpl:"http://v.t.sina.com.cn/share/share.php?appkey={{= encodeURIComponent(self.apiKey)}}&url={{= encodeURIComponent(url)}}&title={{= encodeURIComponent(title)}}&pic={{= encodeURIComponent(imageUrl)}}&sourceUrl=&content=utf-8"},tencent:{id:"tencent",label:"腾讯微博",className:"rec-tencent",apiKey:"1459b2ac3d2345d2a17396eec5ad3bd7",popup:{width:658,height:352},urlTmpl:"http://v.t.qq.com/share/share.php?appkey={{= encodeURIComponent(self.apiKey)}}&url={{= encodeURIComponent(url)}}&title={{= encodeURIComponent(title)}}&pic={{= encodeURIComponent(imageUrl)}}"},renren:{id:"renren",label:"人人网",className:"rec-renren",popup:{width:1e3,height:760},urlTmpl:"http://widget.renren.com/dialog/share?title={{= encodeURIComponent(title)}}&srcUrl={{= encodeURIComponent(url)}}&resourceUrl={{= encodeURIComponent(url)}}&pic={{= encodeURIComponent(imageUrl)}}&description={{= encodeURIComponent(desc)}}"}};return $.extend(s.prototype,{snsDefaults:a,init:function(){this.wrapper=this.options.wrapper||$(this.options.wrapperSel);for(var t in this.snsOptions){var e=this.snsOptions[t];if(e){var i=this.wrapper.find("."+e.className);i.length&&(this.renderButton(i,e),this.bindButton(i,e))}}},renderButton:function(t,i){var n=$.extend({self:i},this.options);this.options.urlWrapper&&(n.url=this.options.urlWrapper(n.url,i,this.options)),i.urlTmpl&&(i.url=e(i.urlTmpl,n)),i.onClickify&&(i.onClick=i.onClickify(n,i)),t.data("options",i)},bindButton:function(e,i){var n=this;e.on("click",function(o){return n.options.ga&&ga("send","event",i.id+"-share","click",decodeURIComponent(t.addParam("",n.options.ga))),i.url?n.openWindow(e,i):i.onClick?i.onClick.call(this,o,i):void 0})},openWindow:function(t,e){function i(){window.open(e.url,"sns_share"+ +new Date,h)}var n=navigator.userAgent;if(/(iphone|ipad|android)/i.test(n))return t[0].href=e.url,void(t[0].target="_blank");var o=e.popup||{},r=o.width||440,s=o.height||430,a=(screen.height-s)/2,l=(screen.width-r)/2,h=["toolbar=0","status=0","resizable=1","width="+r,"height="+s,"left="+l,"top="+a].join(",");/firefox/.test(n)?setTimeout(i,0):i()}}),s.addSnsOption=function(t){$.extend(!0,a,t)},s}.apply(e,n),!(void 0!==o&&(t.exports=o))}).call(e,i(6))},function(t,e){var i;!function(){function t(t){this.mode=c.MODE_8BIT_BYTE,this.data=t,this.parsedData=[];for(var e=0,i=this.data.length;e<i;e++){var n=[],o=this.data.charCodeAt(e);o>65536?(n[0]=240|(1835008&o)>>>18,n[1]=128|(258048&o)>>>12,n[2]=128|(4032&o)>>>6,n[3]=128|63&o):o>2048?(n[0]=224|(61440&o)>>>12,n[1]=128|(4032&o)>>>6,n[2]=128|63&o):o>128?(n[0]=192|(1984&o)>>>6,n[1]=128|63&o):n[0]=o,this.parsedData.push(n)}this.parsedData=Array.prototype.concat.apply([],this.parsedData),this.parsedData.length!=this.data.length&&(this.parsedData.unshift(191),this.parsedData.unshift(187),this.parsedData.unshift(239))}function e(t,e){this.typeNumber=t,this.errorCorrectLevel=e,this.modules=null,this.moduleCount=0,this.dataCache=null,this.dataList=[]}function n(t,e){if(void 0==t.length)throw new Error(t.length+"/"+e);for(var i=0;i<t.length&&0==t[i];)i++;this.num=new Array(t.length-i+e);for(var n=0;n<t.length-i;n++)this.num[n]=t[n+i]}function o(t,e){this.totalCount=t,this.dataCount=e}function r(){this.buffer=[],this.length=0}function s(){return"undefined"!=typeof CanvasRenderingContext2D}function a(){var t=!1,e=navigator.userAgent;if(/android/i.test(e)){t=!0;var i=e.toString().match(/android ([0-9]\.[0-9])/i);i&&i[1]&&(t=parseFloat(i[1]))}return t}function l(t,e){for(var i=1,n=h(t),o=0,r=m.length;o<=r;o++){var s=0;switch(e){case d.L:s=m[o][0];break;case d.M:s=m[o][1];break;case d.Q:s=m[o][2];break;case d.H:s=m[o][3]}if(n<=s)break;i++}if(i>m.length)throw new Error("Too long data");return i}function h(t){var e=encodeURI(t).toString().replace(/\%[0-9a-fA-F]{2}/g,"a");return e.length+(e.length!=t?3:0)}t.prototype={getLength:function(t){return this.parsedData.length},write:function(t){for(var e=0,i=this.parsedData.length;e<i;e++)t.put(this.parsedData[e],8)}},e.prototype={addData:function(e){var i=new t(e);this.dataList.push(i),this.dataCache=null},isDark:function(t,e){if(t<0||this.moduleCount<=t||e<0||this.moduleCount<=e)throw new Error(t+","+e);return this.modules[t][e]},getModuleCount:function(){return this.moduleCount},make:function(){this.makeImpl(!1,this.getBestMaskPattern())},makeImpl:function(t,i){this.moduleCount=4*this.typeNumber+17,this.modules=new Array(this.moduleCount);for(var n=0;n<this.moduleCount;n++){this.modules[n]=new Array(this.moduleCount);for(var o=0;o<this.moduleCount;o++)this.modules[n][o]=null}this.setupPositionProbePattern(0,0),this.setupPositionProbePattern(this.moduleCount-7,0),this.setupPositionProbePattern(0,this.moduleCount-7),this.setupPositionAdjustPattern(),this.setupTimingPattern(),this.setupTypeInfo(t,i),this.typeNumber>=7&&this.setupTypeNumber(t),null==this.dataCache&&(this.dataCache=e.createData(this.typeNumber,this.errorCorrectLevel,this.dataList)),this.mapData(this.dataCache,i)},setupPositionProbePattern:function(t,e){for(var i=-1;i<=7;i++)if(!(t+i<=-1||this.moduleCount<=t+i))for(var n=-1;n<=7;n++)e+n<=-1||this.moduleCount<=e+n||(0<=i&&i<=6&&(0==n||6==n)||0<=n&&n<=6&&(0==i||6==i)||2<=i&&i<=4&&2<=n&&n<=4?this.modules[t+i][e+n]=!0:this.modules[t+i][e+n]=!1)},getBestMaskPattern:function(){for(var t=0,e=0,i=0;i<8;i++){this.makeImpl(!0,i);var n=p.getLostPoint(this);(0==i||t>n)&&(t=n,e=i)}return e},createMovieClip:function(t,e,i){var n=t.createEmptyMovieClip(e,i),o=1;this.make();for(var r=0;r<this.modules.length;r++)for(var s=r*o,a=0;a<this.modules[r].length;a++){var l=a*o,h=this.modules[r][a];h&&(n.beginFill(0,100),n.moveTo(l,s),n.lineTo(l+o,s),n.lineTo(l+o,s+o),n.lineTo(l,s+o),n.endFill())}return n},setupTimingPattern:function(){for(var t=8;t<this.moduleCount-8;t++)null==this.modules[t][6]&&(this.modules[t][6]=t%2==0);for(var e=8;e<this.moduleCount-8;e++)null==this.modules[6][e]&&(this.modules[6][e]=e%2==0)},setupPositionAdjustPattern:function(){for(var t=p.getPatternPosition(this.typeNumber),e=0;e<t.length;e++)for(var i=0;i<t.length;i++){var n=t[e],o=t[i];if(null==this.modules[n][o])for(var r=-2;r<=2;r++)for(var s=-2;s<=2;s++)r==-2||2==r||s==-2||2==s||0==r&&0==s?this.modules[n+r][o+s]=!0:this.modules[n+r][o+s]=!1}},setupTypeNumber:function(t){for(var e=p.getBCHTypeNumber(this.typeNumber),i=0;i<18;i++){var n=!t&&1==(e>>i&1);this.modules[Math.floor(i/3)][i%3+this.moduleCount-8-3]=n}for(var i=0;i<18;i++){var n=!t&&1==(e>>i&1);this.modules[i%3+this.moduleCount-8-3][Math.floor(i/3)]=n}},setupTypeInfo:function(t,e){for(var i=this.errorCorrectLevel<<3|e,n=p.getBCHTypeInfo(i),o=0;o<15;o++){var r=!t&&1==(n>>o&1);o<6?this.modules[o][8]=r:o<8?this.modules[o+1][8]=r:this.modules[this.moduleCount-15+o][8]=r}for(var o=0;o<15;o++){var r=!t&&1==(n>>o&1);o<8?this.modules[8][this.moduleCount-o-1]=r:o<9?this.modules[8][15-o-1+1]=r:this.modules[8][15-o-1]=r}this.modules[this.moduleCount-8][8]=!t},mapData:function(t,e){for(var i=-1,n=this.moduleCount-1,o=7,r=0,s=this.moduleCount-1;s>0;s-=2)for(6==s&&s--;;){for(var a=0;a<2;a++)if(null==this.modules[n][s-a]){var l=!1;r<t.length&&(l=1==(t[r]>>>o&1));var h=p.getMask(e,n,s-a);h&&(l=!l),this.modules[n][s-a]=l,o--,o==-1&&(r++,o=7)}if(n+=i,n<0||this.moduleCount<=n){n-=i,i=-i;break}}}},e.PAD0=236,e.PAD1=17,e.createData=function(t,i,n){for(var s=o.getRSBlocks(t,i),a=new r,l=0;l<n.length;l++){var h=n[l];a.put(h.mode,4),a.put(h.getLength(),p.getLengthInBits(h.mode,t)),h.write(a)}for(var c=0,l=0;l<s.length;l++)c+=s[l].dataCount;if(a.getLengthInBits()>8*c)throw new Error("code length overflow. ("+a.getLengthInBits()+">"+8*c+")");for(a.getLengthInBits()+4<=8*c&&a.put(0,4);a.getLengthInBits()%8!=0;)a.putBit(!1);for(;;){if(a.getLengthInBits()>=8*c)break;if(a.put(e.PAD0,8),a.getLengthInBits()>=8*c)break;a.put(e.PAD1,8)}return e.createBytes(a,s)},e.createBytes=function(t,e){for(var i=0,o=0,r=0,s=new Array(e.length),a=new Array(e.length),l=0;l<e.length;l++){var h=e[l].dataCount,c=e[l].totalCount-h;o=Math.max(o,h),r=Math.max(r,c),s[l]=new Array(h);for(var d=0;d<s[l].length;d++)s[l][d]=255&t.buffer[d+i];i+=h;var u=p.getErrorCorrectPolynomial(c),f=new n(s[l],u.getLength()-1),g=f.mod(u);a[l]=new Array(u.getLength()-1);for(var d=0;d<a[l].length;d++){var m=d+g.getLength()-a[l].length;a[l][d]=m>=0?g.get(m):0}}for(var v=0,d=0;d<e.length;d++)v+=e[d].totalCount;for(var y=new Array(v),b=0,d=0;d<o;d++)for(var l=0;l<e.length;l++)d<s[l].length&&(y[b++]=s[l][d]);for(var d=0;d<r;d++)for(var l=0;l<e.length;l++)d<a[l].length&&(y[b++]=a[l][d]);return y};for(var c={MODE_NUMBER:1,MODE_ALPHA_NUM:2,MODE_8BIT_BYTE:4,MODE_KANJI:8},d={L:1,M:0,Q:3,H:2},u={PATTERN000:0,PATTERN001:1,PATTERN010:2,PATTERN011:3,PATTERN100:4,PATTERN101:5,PATTERN110:6,PATTERN111:7},p={PATTERN_POSITION_TABLE:[[],[6,18],[6,22],[6,26],[6,30],[6,34],[6,22,38],[6,24,42],[6,26,46],[6,28,50],[6,30,54],[6,32,58],[6,34,62],[6,26,46,66],[6,26,48,70],[6,26,50,74],[6,30,54,78],[6,30,56,82],[6,30,58,86],[6,34,62,90],[6,28,50,72,94],[6,26,50,74,98],[6,30,54,78,102],[6,28,54,80,106],[6,32,58,84,110],[6,30,58,86,114],[6,34,62,90,118],[6,26,50,74,98,122],[6,30,54,78,102,126],[6,26,52,78,104,130],[6,30,56,82,108,134],[6,34,60,86,112,138],[6,30,58,86,114,142],[6,34,62,90,118,146],[6,30,54,78,102,126,150],[6,24,50,76,102,128,154],[6,28,54,80,106,132,158],[6,32,58,84,110,136,162],[6,26,54,82,110,138,166],[6,30,58,86,114,142,170]],
G15:1335,G18:7973,G15_MASK:21522,getBCHTypeInfo:function(t){for(var e=t<<10;p.getBCHDigit(e)-p.getBCHDigit(p.G15)>=0;)e^=p.G15<<p.getBCHDigit(e)-p.getBCHDigit(p.G15);return(t<<10|e)^p.G15_MASK},getBCHTypeNumber:function(t){for(var e=t<<12;p.getBCHDigit(e)-p.getBCHDigit(p.G18)>=0;)e^=p.G18<<p.getBCHDigit(e)-p.getBCHDigit(p.G18);return t<<12|e},getBCHDigit:function(t){for(var e=0;0!=t;)e++,t>>>=1;return e},getPatternPosition:function(t){return p.PATTERN_POSITION_TABLE[t-1]},getMask:function(t,e,i){switch(t){case u.PATTERN000:return(e+i)%2==0;case u.PATTERN001:return e%2==0;case u.PATTERN010:return i%3==0;case u.PATTERN011:return(e+i)%3==0;case u.PATTERN100:return(Math.floor(e/2)+Math.floor(i/3))%2==0;case u.PATTERN101:return e*i%2+e*i%3==0;case u.PATTERN110:return(e*i%2+e*i%3)%2==0;case u.PATTERN111:return(e*i%3+(e+i)%2)%2==0;default:throw new Error("bad maskPattern:"+t)}},getErrorCorrectPolynomial:function(t){for(var e=new n([1],0),i=0;i<t;i++)e=e.multiply(new n([1,f.gexp(i)],0));return e},getLengthInBits:function(t,e){if(1<=e&&e<10)switch(t){case c.MODE_NUMBER:return 10;case c.MODE_ALPHA_NUM:return 9;case c.MODE_8BIT_BYTE:return 8;case c.MODE_KANJI:return 8;default:throw new Error("mode:"+t)}else if(e<27)switch(t){case c.MODE_NUMBER:return 12;case c.MODE_ALPHA_NUM:return 11;case c.MODE_8BIT_BYTE:return 16;case c.MODE_KANJI:return 10;default:throw new Error("mode:"+t)}else{if(!(e<41))throw new Error("type:"+e);switch(t){case c.MODE_NUMBER:return 14;case c.MODE_ALPHA_NUM:return 13;case c.MODE_8BIT_BYTE:return 16;case c.MODE_KANJI:return 12;default:throw new Error("mode:"+t)}}},getLostPoint:function(t){for(var e=t.getModuleCount(),i=0,n=0;n<e;n++)for(var o=0;o<e;o++){for(var r=0,s=t.isDark(n,o),a=-1;a<=1;a++)if(!(n+a<0||e<=n+a))for(var l=-1;l<=1;l++)o+l<0||e<=o+l||0==a&&0==l||s==t.isDark(n+a,o+l)&&r++;r>5&&(i+=3+r-5)}for(var n=0;n<e-1;n++)for(var o=0;o<e-1;o++){var h=0;t.isDark(n,o)&&h++,t.isDark(n+1,o)&&h++,t.isDark(n,o+1)&&h++,t.isDark(n+1,o+1)&&h++,0!=h&&4!=h||(i+=3)}for(var n=0;n<e;n++)for(var o=0;o<e-6;o++)t.isDark(n,o)&&!t.isDark(n,o+1)&&t.isDark(n,o+2)&&t.isDark(n,o+3)&&t.isDark(n,o+4)&&!t.isDark(n,o+5)&&t.isDark(n,o+6)&&(i+=40);for(var o=0;o<e;o++)for(var n=0;n<e-6;n++)t.isDark(n,o)&&!t.isDark(n+1,o)&&t.isDark(n+2,o)&&t.isDark(n+3,o)&&t.isDark(n+4,o)&&!t.isDark(n+5,o)&&t.isDark(n+6,o)&&(i+=40);for(var c=0,o=0;o<e;o++)for(var n=0;n<e;n++)t.isDark(n,o)&&c++;var d=Math.abs(100*c/e/e-50)/5;return i+=10*d}},f={glog:function(t){if(t<1)throw new Error("glog("+t+")");return f.LOG_TABLE[t]},gexp:function(t){for(;t<0;)t+=255;for(;t>=256;)t-=255;return f.EXP_TABLE[t]},EXP_TABLE:new Array(256),LOG_TABLE:new Array(256)},g=0;g<8;g++)f.EXP_TABLE[g]=1<<g;for(var g=8;g<256;g++)f.EXP_TABLE[g]=f.EXP_TABLE[g-4]^f.EXP_TABLE[g-5]^f.EXP_TABLE[g-6]^f.EXP_TABLE[g-8];for(var g=0;g<255;g++)f.LOG_TABLE[f.EXP_TABLE[g]]=g;n.prototype={get:function(t){return this.num[t]},getLength:function(){return this.num.length},multiply:function(t){for(var e=new Array(this.getLength()+t.getLength()-1),i=0;i<this.getLength();i++)for(var o=0;o<t.getLength();o++)e[i+o]^=f.gexp(f.glog(this.get(i))+f.glog(t.get(o)));return new n(e,0)},mod:function(t){if(this.getLength()-t.getLength()<0)return this;for(var e=f.glog(this.get(0))-f.glog(t.get(0)),i=new Array(this.getLength()),o=0;o<this.getLength();o++)i[o]=this.get(o);for(var o=0;o<t.getLength();o++)i[o]^=f.gexp(f.glog(t.get(o))+e);return new n(i,0).mod(t)}},o.RS_BLOCK_TABLE=[[1,26,19],[1,26,16],[1,26,13],[1,26,9],[1,44,34],[1,44,28],[1,44,22],[1,44,16],[1,70,55],[1,70,44],[2,35,17],[2,35,13],[1,100,80],[2,50,32],[2,50,24],[4,25,9],[1,134,108],[2,67,43],[2,33,15,2,34,16],[2,33,11,2,34,12],[2,86,68],[4,43,27],[4,43,19],[4,43,15],[2,98,78],[4,49,31],[2,32,14,4,33,15],[4,39,13,1,40,14],[2,121,97],[2,60,38,2,61,39],[4,40,18,2,41,19],[4,40,14,2,41,15],[2,146,116],[3,58,36,2,59,37],[4,36,16,4,37,17],[4,36,12,4,37,13],[2,86,68,2,87,69],[4,69,43,1,70,44],[6,43,19,2,44,20],[6,43,15,2,44,16],[4,101,81],[1,80,50,4,81,51],[4,50,22,4,51,23],[3,36,12,8,37,13],[2,116,92,2,117,93],[6,58,36,2,59,37],[4,46,20,6,47,21],[7,42,14,4,43,15],[4,133,107],[8,59,37,1,60,38],[8,44,20,4,45,21],[12,33,11,4,34,12],[3,145,115,1,146,116],[4,64,40,5,65,41],[11,36,16,5,37,17],[11,36,12,5,37,13],[5,109,87,1,110,88],[5,65,41,5,66,42],[5,54,24,7,55,25],[11,36,12],[5,122,98,1,123,99],[7,73,45,3,74,46],[15,43,19,2,44,20],[3,45,15,13,46,16],[1,135,107,5,136,108],[10,74,46,1,75,47],[1,50,22,15,51,23],[2,42,14,17,43,15],[5,150,120,1,151,121],[9,69,43,4,70,44],[17,50,22,1,51,23],[2,42,14,19,43,15],[3,141,113,4,142,114],[3,70,44,11,71,45],[17,47,21,4,48,22],[9,39,13,16,40,14],[3,135,107,5,136,108],[3,67,41,13,68,42],[15,54,24,5,55,25],[15,43,15,10,44,16],[4,144,116,4,145,117],[17,68,42],[17,50,22,6,51,23],[19,46,16,6,47,17],[2,139,111,7,140,112],[17,74,46],[7,54,24,16,55,25],[34,37,13],[4,151,121,5,152,122],[4,75,47,14,76,48],[11,54,24,14,55,25],[16,45,15,14,46,16],[6,147,117,4,148,118],[6,73,45,14,74,46],[11,54,24,16,55,25],[30,46,16,2,47,17],[8,132,106,4,133,107],[8,75,47,13,76,48],[7,54,24,22,55,25],[22,45,15,13,46,16],[10,142,114,2,143,115],[19,74,46,4,75,47],[28,50,22,6,51,23],[33,46,16,4,47,17],[8,152,122,4,153,123],[22,73,45,3,74,46],[8,53,23,26,54,24],[12,45,15,28,46,16],[3,147,117,10,148,118],[3,73,45,23,74,46],[4,54,24,31,55,25],[11,45,15,31,46,16],[7,146,116,7,147,117],[21,73,45,7,74,46],[1,53,23,37,54,24],[19,45,15,26,46,16],[5,145,115,10,146,116],[19,75,47,10,76,48],[15,54,24,25,55,25],[23,45,15,25,46,16],[13,145,115,3,146,116],[2,74,46,29,75,47],[42,54,24,1,55,25],[23,45,15,28,46,16],[17,145,115],[10,74,46,23,75,47],[10,54,24,35,55,25],[19,45,15,35,46,16],[17,145,115,1,146,116],[14,74,46,21,75,47],[29,54,24,19,55,25],[11,45,15,46,46,16],[13,145,115,6,146,116],[14,74,46,23,75,47],[44,54,24,7,55,25],[59,46,16,1,47,17],[12,151,121,7,152,122],[12,75,47,26,76,48],[39,54,24,14,55,25],[22,45,15,41,46,16],[6,151,121,14,152,122],[6,75,47,34,76,48],[46,54,24,10,55,25],[2,45,15,64,46,16],[17,152,122,4,153,123],[29,74,46,14,75,47],[49,54,24,10,55,25],[24,45,15,46,46,16],[4,152,122,18,153,123],[13,74,46,32,75,47],[48,54,24,14,55,25],[42,45,15,32,46,16],[20,147,117,4,148,118],[40,75,47,7,76,48],[43,54,24,22,55,25],[10,45,15,67,46,16],[19,148,118,6,149,119],[18,75,47,31,76,48],[34,54,24,34,55,25],[20,45,15,61,46,16]],o.getRSBlocks=function(t,e){var i=o.getRsBlockTable(t,e);if(void 0==i)throw new Error("bad rs block @ typeNumber:"+t+"/errorCorrectLevel:"+e);for(var n=i.length/3,r=[],s=0;s<n;s++)for(var a=i[3*s+0],l=i[3*s+1],h=i[3*s+2],c=0;c<a;c++)r.push(new o(l,h));return r},o.getRsBlockTable=function(t,e){switch(e){case d.L:return o.RS_BLOCK_TABLE[4*(t-1)+0];case d.M:return o.RS_BLOCK_TABLE[4*(t-1)+1];case d.Q:return o.RS_BLOCK_TABLE[4*(t-1)+2];case d.H:return o.RS_BLOCK_TABLE[4*(t-1)+3];default:return}},r.prototype={get:function(t){var e=Math.floor(t/8);return 1==(this.buffer[e]>>>7-t%8&1)},put:function(t,e){for(var i=0;i<e;i++)this.putBit(1==(t>>>e-i-1&1))},getLengthInBits:function(){return this.length},putBit:function(t){var e=Math.floor(this.length/8);this.buffer.length<=e&&this.buffer.push(0),t&&(this.buffer[e]|=128>>>this.length%8),this.length++}};var m=[[17,14,11,7],[32,26,20,14],[53,42,32,24],[78,62,46,34],[106,84,60,44],[134,106,74,58],[154,122,86,64],[192,152,108,84],[230,180,130,98],[271,213,151,119],[321,251,177,137],[367,287,203,155],[425,331,241,177],[458,362,258,194],[520,412,292,220],[586,450,322,250],[644,504,364,280],[718,560,394,310],[792,624,442,338],[858,666,482,382],[929,711,509,403],[1003,779,565,439],[1091,857,611,461],[1171,911,661,511],[1273,997,715,535],[1367,1059,751,593],[1465,1125,805,625],[1528,1190,868,658],[1628,1264,908,698],[1732,1370,982,742],[1840,1452,1030,790],[1952,1538,1112,842],[2068,1628,1168,898],[2188,1722,1228,958],[2303,1809,1283,983],[2431,1911,1351,1051],[2563,1989,1423,1093],[2699,2099,1499,1139],[2809,2213,1579,1219],[2953,2331,1663,1273]],v=function(){var t=function(t,e){this._el=t,this._htOption=e};return t.prototype.draw=function(t){function e(t,e){var i=document.createElementNS("http://www.w3.org/2000/svg",t);for(var n in e)e.hasOwnProperty(n)&&i.setAttribute(n,e[n]);return i}var i=this._htOption,n=this._el,o=t.getModuleCount();Math.floor(i.width/o),Math.floor(i.height/o);this.clear();var r=e("svg",{viewBox:"0 0 "+String(o)+" "+String(o),width:"100%",height:"100%",fill:i.colorLight});r.setAttributeNS("http://www.w3.org/2000/xmlns/","xmlns:xlink","http://www.w3.org/1999/xlink"),n.appendChild(r),r.appendChild(e("rect",{fill:i.colorLight,width:"100%",height:"100%"})),r.appendChild(e("rect",{fill:i.colorDark,width:"1",height:"1",id:"template"}));for(var s=0;s<o;s++)for(var a=0;a<o;a++)if(t.isDark(s,a)){var l=e("use",{x:String(a),y:String(s)});l.setAttributeNS("http://www.w3.org/1999/xlink","href","#template"),r.appendChild(l)}},t.prototype.clear=function(){for(;this._el.hasChildNodes();)this._el.removeChild(this._el.lastChild)},t}(),y="svg"===document.documentElement.tagName.toLowerCase(),b=y?v:s()?function(){function t(){this._elImage.src=this._elCanvas.toDataURL("image/png"),this._elImage.style.display="block",this._elCanvas.style.display="none"}function e(t,e){var i=this;if(i._fFail=e,i._fSuccess=t,null===i._bSupportDataURI){var n=document.createElement("img"),o=function(){i._bSupportDataURI=!1,i._fFail&&i._fFail.call(i)},r=function(){i._bSupportDataURI=!0,i._fSuccess&&i._fSuccess.call(i)};return n.onabort=o,n.onerror=o,n.onload=r,void(n.src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAUAAAAFCAYAAACNbyblAAAAHElEQVQI12P4//8/w38GIAXDIBKE0DHxgljNBAAO9TXL0Y4OHwAAAABJRU5ErkJggg==")}i._bSupportDataURI===!0&&i._fSuccess?i._fSuccess.call(i):i._bSupportDataURI===!1&&i._fFail&&i._fFail.call(i)}if(this._android&&this._android<=2.1){var i=1/window.devicePixelRatio,n=CanvasRenderingContext2D.prototype.drawImage;CanvasRenderingContext2D.prototype.drawImage=function(t,e,o,r,s,a,l,h,c){if("nodeName"in t&&/img/i.test(t.nodeName))for(var d=arguments.length-1;d>=1;d--)arguments[d]=arguments[d]*i;else"undefined"==typeof h&&(arguments[1]*=i,arguments[2]*=i,arguments[3]*=i,arguments[4]*=i);n.apply(this,arguments)}}var o=function(t,e){this._bIsPainted=!1,this._android=a(),this._htOption=e,this._elCanvas=document.createElement("canvas"),this._elCanvas.width=e.width,this._elCanvas.height=e.height,t.appendChild(this._elCanvas),this._el=t,this._oContext=this._elCanvas.getContext("2d"),this._bIsPainted=!1,this._elImage=document.createElement("img"),this._elImage.alt="Scan me!",this._elImage.style.display="none",this._el.appendChild(this._elImage),this._bSupportDataURI=null};return o.prototype.draw=function(t){var e=this._elImage,i=this._oContext,n=this._htOption,o=t.getModuleCount(),r=n.width/o,s=n.height/o,a=Math.round(r),l=Math.round(s);e.style.display="none",this.clear();for(var h=0;h<o;h++)for(var c=0;c<o;c++){var d=t.isDark(h,c),u=c*r,p=h*s;i.strokeStyle=d?n.colorDark:n.colorLight,i.lineWidth=1,i.fillStyle=d?n.colorDark:n.colorLight,i.fillRect(u,p,r,s),i.strokeRect(Math.floor(u)+.5,Math.floor(p)+.5,a,l),i.strokeRect(Math.ceil(u)-.5,Math.ceil(p)-.5,a,l)}this._bIsPainted=!0},o.prototype.makeImage=function(){this._bIsPainted&&e.call(this,t)},o.prototype.isPainted=function(){return this._bIsPainted},o.prototype.clear=function(){this._oContext.clearRect(0,0,this._elCanvas.width,this._elCanvas.height),this._bIsPainted=!1},o.prototype.round=function(t){return t?Math.floor(1e3*t)/1e3:t},o}():function(){var t=function(t,e){this._el=t,this._htOption=e};return t.prototype.draw=function(t){for(var e=this._htOption,i=this._el,n=t.getModuleCount(),o=Math.floor(e.width/n),r=Math.floor(e.height/n),s=['<table style="border:0;border-collapse:collapse;">'],a=0;a<n;a++){s.push("<tr>");for(var l=0;l<n;l++)s.push('<td style="border:0;border-collapse:collapse;padding:0;margin:0;width:'+o+"px;height:"+r+"px;background-color:"+(t.isDark(a,l)?e.colorDark:e.colorLight)+';"></td>');s.push("</tr>")}s.push("</table>"),i.innerHTML=s.join("");var h=i.childNodes[0],c=(e.width-h.offsetWidth)/2,d=(e.height-h.offsetHeight)/2;c>0&&d>0&&(h.style.margin=d+"px "+c+"px")},t.prototype.clear=function(){this._el.innerHTML=""},t}();i=function(t,e){if(this._htOption={width:256,height:256,typeNumber:4,colorDark:"#000000",colorLight:"#ffffff",correctLevel:d.H},"string"==typeof e&&(e={text:e}),e)for(var i in e)this._htOption[i]=e[i];"string"==typeof t&&(t=document.getElementById(t)),this._htOption.useSVG&&(b=v),this._android=a(),this._el=t,this._oQRCode=null,this._oDrawing=new b(this._el,this._htOption),this._htOption.text&&this.makeCode(this._htOption.text)},i.prototype.makeCode=function(t){this._oQRCode=new e(l(t,this._htOption.correctLevel),this._htOption.correctLevel),this._oQRCode.addData(t),this._oQRCode.make(),this._el.title=t,this._oDrawing.draw(this._oQRCode),this.makeImage()},i.prototype.makeImage=function(){"function"==typeof this._oDrawing.makeImage&&(!this._android||this._android>=3)&&this._oDrawing.makeImage()},i.prototype.clear=function(){this._oDrawing.clear()},i.CorrectLevel=d}(),t.exports=i},function(t,e,i){var n,o;n=[i(2),i(3),i(6),i(21)],o=function(t,_,$,e){var i=t.View.extend({className:"purchase-guide",template:$("#tmpl-purchase-guide").html(),render:function(t){var i=_.pick(t.model.toJSON(),"id","price");return i.device=e.ua.device,this.$el.html(_.template(this.template,i)),this}});return i}.apply(e,n),!(void 0!==o&&(t.exports=o))},function(t,e,i){var n,o;n=[i(6),i(2),i(3),i(22),i(32),i(60),i(217),i(218),i(219)],o=function($,t,_,e,i,n,o,r,s){var a=t.View.extend({el:".pagination",template:$("#tmpl-pagination").html(),initialize:function(t){_.bindAll(this,"initPagination","updateProgressBar"),this.turningModel=e.getModel("turning"),this.app=e,this.config=t,this.vent=this.app.vent,this.vent.on({"paging:finish":this.initPagination}),this.$el.html(_.template(this.template)),this.pageForm=this.$(".page-form"),this.pagePrev=this.$(".page-prev"),this.pageNext=this.$(".page-next"),this.emUnitBenchmark=16,this.isShown=!!this.$el.is(":visible"),this.progressBar=new o({model:this.turningModel}),this.pagePortal=new r({model:this.turningModel}),t.get("isChapter")||(this.vent.on("turningNext:lastPage",function(){n.toast("没有下一页了")}),this.vent.on("turningPrev:firstPage",function(){n.toast("没有上一页了")}))},render:function(){i.fitForMobile||this.progressBar.render(),this.trigger("view:render")},events:{"click .page-prev, .page-next":"pageTurningFromClick","humanClick .page-prev, .page-next":"humanClickTurning"},togglePagingBtns:function(t){this.$el.find(".page-prev, .page-next").toggle("horizontal"===t)},initPagination:function(){this.$el.append(this.pagePortal.render().$el),this.pagePortal.update(),i.fitForMobile||this.renderPageSubsequent()},renderPageSubsequent:function(){this.pageSubsequent&&this.pageSubsequent.remove(),this.pageSubsequent=new s({turningModel:this.turningModel,contentModel:e.getModel("content")}),this.$el.append(this.pageSubsequent.render().$el)},updateProgressBar:function(){this.progressBar.update()},removeProgressBar:function(){this.progressBar.remove()},pageTurningFromClick:function(t){var e=$(t.target),i=e.hasClass("page-prev")?1:0;this.pageTurning(i)},pageTurning:_.debounce(function(t,e){this.vent.trigger("goto:stamp");var i=this.turningModel,n=i.get("currPage"),o=i.get("totalPage"),r=n===o?1:0,s=1===n?1:0,a=this.config.get("layout");if(t&&s)return void this.vent.trigger("turningPrev:firstPage");if(!t&&r)return void this.vent.trigger("turningNext:lastPage");"horizontal"===a&&i.setCurrPage((t?-1:1)+n,e);var l=this.$(".page-"+(t?"prev":"next"));l.addClass("on"),this.vent.once("unfreeze:canvas",_.bind(function(){l.removeClass("on")},this))},150),humanClickTurning:function(t){var e=$(t.target);e.trigger("mousedown").trigger("click").trigger("mouseup")},hide:function(){return this.isShown?(this.isShown=!1,void this.$el.hide()):this},toggle:function(){return this.$el[this.isShown?"hide":"show"](),this.isShown=!this.isShown,this}});return a}.apply(e,n),!(void 0!==o&&(t.exports=o))},function(t,e,i){var n,o;n=[i(2),i(3),i(6),i(22)],o=function(t,_,$,e){var i=t.View.extend({initialize:function(t){this.win=$(window),this.body=$("body"),this.fixedLayout=t.fixedLayout},render:function(){var t="reading-progress",e=100;return this.$el.remove(),this.$el=$("<progress>",{role:"progressbar","aria-valuemin":0,"aria-valuemax":e,id:t,max:e}),this.body.append(this.$el),this.win.resize(_.debounce(_.bind(this._update,this),80)),this.update(),this},update:function(){var t=this.model.get("progress"),i=this.fixedLayout||e.getModel("config").get("layout"),n=this.convertToPosition(i);return this.setPosition(n),this.setValue(t),this},setValue:function(t){t=parseFloat(t)||0,this._valuenow=t;var e=this.win.height(),i=!!/(top|bottom)/.test(this._position),n=100-t;return this.$el.val(t).attr("aria-valuenow",t),this._attrsAsProps()?(this.$el.css({width:i?t+"%":t/100*e+"px","padding-right":i?n+"%":n/100*e+"px"}),this):this},_attrsAsProps:function(){return!!/msie (8|9)/i.test(navigator.userAgent)},_update:function(){this.update(this._position,this._valuenow)},setPosition:function(t){var e=3,i=this.win.height(),n=i/2-e,o="pos-"+t,r="Invalid param! You can only use one of the positions:top | right | bottom | left.";switch(this._position=t,t){case"top":case"right":this.$el.css({width:i,top:n});break;case"bottom":case"left":this.$el.removeAttr("style");break;default:throw new Error(r)}return this.$el.attr("class",o),this},positionMap:{vertical:"right",horizontal:"bottom"},convertToPosition:function(t){return this.positionMap[t]},show:function(){return this.$el.show(),this},hide:function(){return this.$el.hide(),this}});return i}.apply(e,n),!(void 0!==o&&(t.exports=o))},function(t,e,i){var n,o;n=[i(6),i(2),i(3),i(22),i(32),i(33)],o=function($,t,_,e,i,n){var o=t.View.extend({className:"page-portal",template:$("#tmpl-page-portal").html(),initialize:function(){this.win=$(window),this.body=$("body"),this.setElement($(this.template)),this.jumpSection=this.$(".page-jump"),this.form=this.$(".page-form"),this.formInput=this.$(".page-input"),this.currPage=this.$(".curr-num"),this.formInput.focus(this.focusPageInput),this.on("view:openPageForm",this.openPageForm),this.win.resize(_.debounce(_.bind(this.toggle,this),60)),this.listenTo(this.model,"change:currPage",this.updatePageNumber)},events:{"click .page-info":"openPageFormOnClick","submit .page-form":"submitPageForm","click .page-jump":"stopPropagation"},render:function(){return this},update:function(){this.setTotalPageNum(),this.updatePageNumber(),this.toggle()},toggle:function(){i.fitForMobile||this.$el.toggle(this.win.width()>=1024)},setTotalPageNum:function(){var t=this.model.getReadTotalPage();this.$el.find(".total-num").text(t)},stopPropagation:function(t){$(t.target).is("[type=submit]")||t.stopPropagation()},openPageFormOnClick:function(t){t.preventDefault(),this.$el.hasClass("on")||(t.stopPropagation(),this.openPageForm())},openPageForm:function(){this.$el.addClass("on"),this.jumpSection.show(),this.customPage(),this.formInput.focus(),this.body.on("click.pageNumber",$.proxy(this.closePageFormOnClick,this))},closePageFormOnClick:function(t){$(t.target).is("[type=submit]")||(t.preventDefault(),this.closePageForm())},closePageForm:function(){this.$el.removeClass("on"),this.jumpSection.hide(),this.formInput.blur(),this.body.off(".pageNumber")},customPage:function(){var t=this.model;this.formInput.val(t.getReadCurrPage())},focusPageInput:function(t){var e=$(this);_.defer(function(){e.select()})},updatePageNumber:function(){var t=this.model.getReadCurrPage(),e=this.model.get("progress");e&&(e=Math.floor(e),this.$el.find(".progress-num").text(e+"%")),this.currPage.text(t),this.jumpSection.is(":hidden")||this.customPage()},submitPageForm:function(t){t.preventDefault();var e=this.model,i=+this.formInput.val();this.closePageForm(),e.getReadCurrPage()!==i&&(e.setReadCurrPage(i,{isFormJump:!0,hasInputPage:!0}),n._trackEvent("gotoPage"))},hide:function(){return this.$el.hide(),this}});return o}.apply(e,n),!(void 0!==o&&(t.exports=o))},function(t,e,i){var n,o;n=[i(6),i(3),i(2)],o=function($,_,t){var e=t.View.extend({className:"page-subsequent",tmpl:$("#tmpl-page-subsequent").html(),initialize:function(t){_.bindAll(this,"update"),this.turningModel=t.turningModel,this.contentModel=t.contentModel,this.lastPageNums=this.getLastPages(),this.listenTo(this.turningModel,"change:currPage",this.update)},getLastPages:function(){var t=_.clone(this.contentModel.getTocPageNumbers());return t.shift(),t=_.map(t,function(t){return t-1}),t.push(this.turningModel.get("totalPage")),t},render:function(){return this.$el.html(this.tmpl),this.update(),this},update:function(){var t=this.$(".subsequent-num"),e=this.turningModel.get("currPage");if(t.length&&e){var i=_.sortedIndex(this.lastPageNums,e),n=this.lastPageNums[i],o=n-e;t.text(o),this.$el.addClass("active").toggleClass("is-last-page",0===o)}}});return e}.apply(e,n),!(void 0!==o&&(t.exports=o))},function(t,e,i){var n,o;n=[i(2),i(3),i(6),i(21),i(28),i(221),i(32),i(22),i(33),i(29),i(222),i(223),i(225),i(233),i(234),i(235),i(236)],o=function(t,_,$,e,i,n,o,r,s,a,l,h,c,d,u,p,f){var g=a.fitForMobile(),m=t.View.extend({el:".controls-panel",template:$(g?"#tmpl-mobile-controls-panel":"#tmpl-controls-panel").html(),initialize:function(t){_.bindAll(this,"closeTips","closePopups","resetHeight","resizePanel","togglePanel","initControls","panelShown","panelHidden","closeShortcutTips","openShortcutTips"),this.app=r,this.config=t,this.vent=this.app.vent,this.win=$(window),this.body=$("body"),this.vent.on({"close:popups":this.closePopups,"close:helperGuide":this.closeShortcutTips,"open:helperGuide":this.openShortcutTips}),this.$el.html(_.template(this.template,{isGallery:this.config.get("isGallery")})).append($("#tmpl-shortcut-tips").html()),this.panelsContainerView=new l({controls:this}),this.panelsContainer=this.panelsContainerView.$el,this.controlsContent=this.panelsContainer.find(".controls-content"),this.controlsContent.on("action:toggle",this.togglePanel),this.controlsContent.on("action:expand",this.panelShown),this.controlsContent.on("action:collapse",this.panelHidden),this.shortcutTips=this.$(".shortcut-tips"),this.config.on("goto:stamp",function(){this.closePopups()},this)},render:function(){return this.renderSwichers(),this.resetPanelAsResize(),this.switcher.disableHandlers(),this.initControls(),this},events:{"click .controls-list li":"deselectAll","click .close-tips":"closeTips"},renderSwichers:function(){if(!this.switcher){var t=this.$(".toggle-toc"),e=[],i=[];if(this.tocView=new d({el:this.$(".toc"),app:this.app,turningModel:r.getModel("turning"),controls:this}),this.tocSwitcher=t,this.toc=this.tocView.$el,this.toc.on("action:expand",function(){s._trackEvent("openToc")}),e.push(this.tocSwitcher),i.push(this.toc),this.config.get("isChapter")){var o=this.$(".toggle-chapters-toc");this.chaptersTocView=new u({el:this.$(".chapters-toc"),app:this.app,controls:this}),this.chaptersTocSwitcher=o,this.chaptersToc=this.chaptersTocView.$el,this.chaptersToc.on("action:expand",function(){s._trackEvent("openChaptersToc")}),e.push(this.chaptersTocSwitcher),i.push(this.chaptersToc)}this.bookmarksView=new h({el:this.$(".bookmarks"),app:this.app,config:this.config}),this.bookmarks=this.bookmarksView.$el,this.bookmarksSwitcher=this.$(".toggle-bookmarks"),e.push(this.bookmarksSwitcher),i.push(this.bookmarks),this.annotationsView=new c({el:this.$(".annotations"),app:this.app,config:this.config}),this.annotations=this.annotationsView.$el,this.annotationsSwitcher=this.$(".toggle-annotations"),e.push(this.annotationsSwitcher),i.push(this.annotations),this.switcher=new n(e,i,{allowDisabled:!0})}},openChapterList:function(){this.chaptersTocSwitcher&&this.chaptersTocSwitcher.click()},deselectAll:function(t){this.closeTips();var e=$(t.currentTarget);e.is(".controls-item")||this.switcher.hideAll(),this.$el.find(".on").not(e).removeClass("on"),e.hasClass("disabled")},closeTips:function(){r.vent.trigger("close:helperGuide")},closePopups:function(){this.switcher.hideAll(),this.panelsContainer.hide(),this.closeTips(),this.$el.find(".on").removeClass("on")},togglePanel:function(t,e,i){this.resizePanel(),this.dealingWithScrollbar(i),this.panelsContainer.toggle(),e.trigger("collapse:"+i+"ed")},panelShown:function(){r.vent.trigger("freeze:control")},panelHidden:function(){r.vent.trigger("unfreeze:control")},initToc:function(){this.listenTo(this.tocView,"list:render",function(){this.tocSwitcher.removeClass("disabled"),this.trigger("list:render")},this)},initChaptersToc:function(){this.chaptersTocView&&(this.chaptersTocView.render(),this.chaptersTocSwitcher.removeClass("disabled"),this.trigger("list:render"))},initBookmarks:function(){this.bookmarksSwitcher.removeClass("disabled")},initAnnotations:function(){this.annotationsSwitcher.removeClass("disabled")},initControls:function(){this.initToc(),this.initChaptersToc(),this.initBookmarks(),this.initAnnotations()}}),v=e.me.isAnonymous?{initBookmarks:$.noop,initAnnotations:$.noop}:{};return _.extend(m.prototype,p,f,v),m}.apply(e,n),!(void 0!==o&&(t.exports=o))},function(t,e,i){var n,o;(function(jQuery){"use strict";n=[i(6)],o=function($){var t=!0,e=!1,i={according:!0,allowDisabled:!1,activeClass:"active",show:function(t){return t.show()},hide:function(t){return t.hide()},useCustomShowAndHide:!1,toggle:function(t){var e=this.options;return t[e.toggleType](e.toggleDuration)},toggleType:"toggle",toggleDuration:null},n=function(t){if(t instanceof jQuery)return t.map(function(){return $(this)})},o=function(t,e,n){this.options=$.extend({},i,n),this.activeClass=this.options.activeClass,this.allowDisabled=this.options.allowDisabled,this.handlers=t,this.contents=e,this.transitioning={},this.listen()};return o.fromAutoSplit=function(t,e,i){return new o(n(t),n(e),i)},$.extend(o.prototype,{listen:function(){var t=this;$.each(this.handlers,function(e,i){var n=$(i);n.on("click",function(){if(!t.allowDisabled||!n.hasClass("disabled")){var i=n.hasClass(t.activeClass);if(!t.transitioning[e])return i?t.close(e):void t.open(e)}});var o=t.contents[e];o.on("close.self",$.proxy(t.hideAll,t))})},findActived:function(t){var e=this;$.each(this.handlers,function(i,n){var o=e.transitioning[i],r=n.hasClass(e.activeClass);o&&r||(r||o)&&t.call(e,i)})},close:function(t){this.action(t,e)},open:function(e){this.options.according&&this.hideAll(),this.action(e,t)},getActionFn:function(t){return this.options.useCustomShowAndHide?this.options[t?"show":"hide"]:this.options.toggle},action:function r(t,e){var i=this.contents[t],n=this.handlers[t],o=this.transitioning[t],s=e?"expand":"collapse",r=this.getActionFn(e),a=this;o&&i.stop(),this.transitioning[t]=!0,r.call(this,i).promise().done(function(){n[e?"addClass":"removeClass"](a.activeClass),i.trigger("action:"+s,i).trigger("action:toggle",[i,s]),a.transitioning[t]=!1})},hideAll:function(){this.findActived(this.close)},disableHandlers:function(){$.each(this.handlers,function(t,e){e.addClass("disabled")})}}),o}.apply(e,n),!(void 0!==o&&(t.exports=o))}).call(e,i(6))},function(t,e,i){var n,o;(function($){"use strict";n=[i(2),i(3)],o=function(t,_){var e=t.View.extend({el:".panels-container",template:$("#tmpl-panels-container").html(),initialize:function(t){this.controls=t.controls,this.$el.html(_.template(this.template))},render:function(){return this},events:{"click .close":"close"},close:function(){this.controls.closePopups()}});return e}.apply(e,n),!(void 0!==o&&(t.exports=o))}).call(e,i(6))},function(t,e,i){var n,o;n=[i(2),i(3),i(6),i(185),i(224)],o=function(t,_,$,e,i){var n=t.View.extend({template:$("#tmpl-bookmarks-panel").html(),initialize:function(t){_.bindAll(this,"renderList"),this.app=t.app,this.config=t.config,this.$el.html(_.template(this.template)),this.panelBody=this.$el.find(".panel-bd"),this.tmplChapter=_.template('<li class="chapter">{{= headline }}</li>'),this.renderTip("empty")},events:{"action:expand":"render","action:collapse":"renderTip"},render:function(){var t=this.app,i=t.getModel("article");this.renderTip("loading"),this.contentModel=t.getModel("content"),this.toc=this.contentModel.contents,this.list=$("<ul>",{"class":"bookmark-list"}),navigator.onLine?(this.collection=new e([],{articleId:i.id,contentModel:this.contentModel}),this.collection.fetch({success:this.renderList})):(this.bookmarks=i.bookmarks,this.renderList(this.bookmarks))},renderTip:function(t){var e={empty:"你还没有添加书签哦!",loading:"加载中, 请稍候..."};return this.panelBody.html($("<p>",{"class":"panel-tip",text:e[t]})),this},renderList:function(t){if(!t.length)return this.renderTip("empty");var e=t||this.bookmarks,n=_.pluck(this.toc,"sequence"),o=this.contentModel.parasIndexs;_.each(e.models,function(t){var e=_.indexOf(o,t.get("paragraph_id"));if(e!==-1){var r=_.sortedIndex(n,e+1)-1;r!==this.lastHeadlineSequence&&(this.list.append(this.tmplChapter({headline:this.toc[r].title})),this.lastHeadlineSequence=r),this.list.append(new i({model:t,config:this.config}).render().el)}},this),this.panelBody.html(this.list),this.lastPartSequence=void 0,this.lastHeadlineSequence=void 0}});return n}.apply(e,n),!(void 0!==o&&(t.exports=o))},function(t,e,i){var n,o;n=[i(2),i(3),i(6),i(22)],o=function(t,_,$,e){var i=t.View.extend({tagName:"li",className:"bookmark-item",template:$("#tmpl-bookmarks-item").html(),initialize:function(t){return _.bindAll(this,"gotoBookmarkPage"),this.vent=e.vent,this.config=t.config,this},render:function(){var t=this.model.toJSON();return t.percent=this.model.getPercent(),this.$el.html(_.template(this.template,t)),this},events:{click:"gotoBookmarkPage"},gotoBookmarkPage:function(){var t=this.model.getStamp(),e=t.sequence;return!t.pid&&e?void this.vent.trigger("goto:tocPage",e):void this.config.trigger("goto:stamp",t)}});return i}.apply(e,n),!(void 0!==o&&(t.exports=o))},function(t,e,i){var n,o;n=[i(6),i(2),i(3),i(53),i(226),i(41),i(228),i(145),i(231),i(180),i(58),i(95),i(232)],o=function($,t,_,e,i,n,o,r,s,a,l,h,c){var d={all:"暂时没有划线和批注<br>可以在阅读时选中文字后添加",mine:"暂时没有你自己的划线和批注<br>可以在阅读时选中文字后添加",favorite:"暂时没有被你收藏的他人批注<br>可以对你认为有趣的他人批注点击“收藏”，它们就会出现在这里"},u="加载中…",p="出错了",f=!0,g=!1,m={percent:"按原文顺序",time:"按添加时间"},v=t.View.extend({tmpl:$("#tmpl-annotations-panel").html(),initialize:function(t){_.bindAll(this,"renderPage"),this.app=t.app,this.config=t.config,this.sortType="time",this.filterType="all",this.list=$("<ul>",{"class":"annotations-list"}),this.pagingNav=$("<div>",{"class":"paging-nav"}),this.textBox=$("<div>",{"class":"text-box"}),this.shareTip=new a,this.$el.on("scroll",_.throttle(_.bind(this.scroll,this),300))},events:{"action:expand":"render","click .filter-tabs a":"filterItems","click .sort-tabs a":"sortItems","click .sort-switch .hd":"toggleSortTabs","click .btn-export":"exportAll"},render:function(){var t=this.app.getModel("article");this.$el.empty(),this.$el.html(_.template(this.tmpl)),this.tabs=this.$(".annotation-tabs").hide(),this.panelBody=this.$(".panel-body"),this.panelBody.append(this.textBox).append(this.list).append(this.pagingNav),this.toggleList(g),this.sortTypeText=this.$(".sort-type"),this.sortTabs=this.$(".sort-tabs"),this.renderTabs(),this.renderTextBox(u),this.listPaging=new c({limit:10,navLimit:5,items:this.list.children("li"),container:this.list,navContainer:this.pagingNav}),this.listPaging.on("turnPage",this.renderPage);var e=this.annotations=new i(null,{articleId:t.id});return e.on("remove",this.detectAnnotations,this),e.on("add",function(t){t.markingModel=this.getMarkingByInfo(t)},this),e.fetch({success:$.proxy(function(){this.renderListBy(this.sortType,this.filterType),this.$(".more-actions").show()},this),error:$.proxy(function(){this.renderTextBox(p)},this)}),this},scroll:function(){var t=this.shareTip;t.isVisible()&&t.hide()},scrollToTop:function(){$(".panels-container").scrollTop(0)},detectAnnotations:function(){return this.annotations.length?this.hasFilterResult(this.filterType)?(this.tabs.toggle(f),this.toggleList(f),!0):(this.tabs.toggle(f),this.toggleList(g),!1):(this.tabs.toggle(g),this.toggleList(g,"all"),!1)},hasFilterResult:function(t){return"all"===t?!!this.annotations.length:this.annotations.some(function(e){
return e.markingModel.hasTag(t)})},toggleList:function(t,e){var i=!t;e=e||this.filterType,i&&this.renderTextBox(d[e]),this.$el.toggleClass("show-text-box",i)},renderTextBox:function(t){this.textBox.html(t)},toggleSortTabs:function(t){var e=this.sortTabs,i=$(t.currentTarget);e.toggleClass("opened"),h(i,function(){e.removeClass("opened")})},sortItems:function(t){this.switchTag("sort",$(t.currentTarget))},filterItems:function(t){this.switchTag("filter",$(t.currentTarget))},switchTag:function(t,e){var i=t+"Type",n=e.data(t+"-type");this[i]===n||this.tabs.hasClass("disabled")||(this[i]=n,this.renderTabs(),this.renderListBy(this.sortType,this.filterType))},renderTabs:function(){var t=this.tabs,e=t.find("a"),i=e.filter("a[data-sort-type="+this.sortType+"]"),n=e.filter("a[data-filter-type="+this.filterType+"]");this.sortTypeText.html(m[this.sortType]),e.toggleClass("actived",!1),i.addClass("actived"),n.addClass("actived")},renderListBy:function(t,e){var i=this.getAnnotationInfosBy(t,e);this.listPaging.setItems(i).render(),this.detectAnnotations()},renderPage:function(t){var e;this.removeAllSubView(),_.each(t,function(t){e=this.getAnnotationView(t),this.addSubView(e),this.list.append(e.render().el)},this),this.scrollToTop()},sortIterator:{time:function(t){return-l(t.get("create_time"))},percent:function(t){return t.get("extra").percent}},filterIterator:{all:function(){return!0},mine:function(t){return t.markingModel.isMine()},favorite:function(t){return t.markingModel.isFavorited()}},getAnnotationView:function(t){return new o({model:t.markingModel,info:t,config:this.config,annotations:this.annotations,shareTip:this.shareTip})},getAnnotationInfosBy:function(t,e){var i=this.annotations;return _.clone(i.chain().filter(this.filterIterator[e]).sortBy(this.sortIterator[t]).value())},getMarkingByInfo:function(t){var e,i=this.app.getModel("article"),o=this.app.getModel("content"),r=i.markings,s=r.get(t.id);return s||(e=t.omit("extra"),s=new n(e,{articleId:i.id,paragraphsIndex:o.getParasIndexs()}),s.on("effectiveChange",function(t){t.save()})),s},exportAll:function(){function t(t){return t.length>300?t.substr(0,300)+"…":t}var i=this.app.getModel("content"),n=this.app.getModel("article"),o=void 0,r=_.chain(this.annotations.toJSON()).filter(function(t){return t.tags.indexOf("mine")!==-1}).sortBy(function(t){return t.endOffset}).sortBy(function(t){return i.parasIndexs.indexOf(t.endContainerId)}).reduce(function(t,e){var n=i.getTocFromPara(e.endContainerId);return n&&n!==o?(o=n,t.concat([n,e])):t.concat([e])},[]).map(function(e){return _.isUndefined(e.level)?"<原文开始>"+t(e.extra.text)+"</原文结束>"+(e.note?"\n"+e.note:""):"章节："+e.title}).value().join("\n\n"),s=$("<textarea>").val(r).prop("readonly",!0);if(window.Blob&&window.URL){var a=new Blob([r],{type:"text/plain"}),l=URL.createObjectURL(a),h=new Date,c=""+h.getFullYear()+(""+((h.getMonth()+1)/100).toFixed(2).slice(2))+(""+(h.getDate()/100).toFixed(2).slice(2));s=s.add($("<a>",{href:l,"class":"btn",text:"下载",download:n.get("title")+"_笔记_豆瓣阅读_"+c+".txt"}))}e({title:"导出笔记",content:s}).addClass("dialog-export-annotation").open(),s.eq(0).focus().select()}});return _.extend(v.prototype,s,r),v}.apply(e,n),!(void 0!==o&&(t.exports=o))},function(t,e,i){var n,o;n=[i(2),i(3),i(227)],o=function(t,_,e){var i=t.Collection.extend({url:function(){return"/j/article_v2/"+this.articleId+"/my_annotations"},model:e,initialize:function(t,e){this.articleId=e.articleId}});return i}.apply(e,n),!(void 0!==o&&(t.exports=o))},function(t,e,i){var n,o;n=[i(2),i(3)],o=function(t,_){var e=t.Model.extend({parse:function(t){return t.endContainerId+="",t.startContainerId+="",_.each(t.middleContainers,function(e,i){t.middleContainers[i]=e+""}),t.extra.percent=parseInt(t.extra.percent,10),t}});return e}.apply(e,n),!(void 0!==o&&(t.exports=o))},function(t,e,i){var n,o;n=[i(6),i(2),i(3),i(22),i(49),i(127),i(45),i(130),i(229),i(172)],o=function($,t,_,e,i,n,o,r,s,a){var l=t.View.extend({tagName:"li",className:"annotations-item",tmpl:$("#tmpl-annotations-panel-item").html(),commentTextTmpl:$("#tmpl-annotation-comment-text").html(),favoriteTextTmpl:$("#tmpl-annotation-favorite-text").html(),initialize:function(t){this.info=t.info,this.config=t.config,this.shareTip=t.shareTip,this.annotations=t.annotations,this.listenTo(this.model,"destroy",this.destroy),this.listenTo(this.model,"change:n_favorites",this.updateFavorite),this.listenTo(this.model,"change:n_comments",this.updateComment),this.listenTo(this.model,"change:visible_private",this.updatePrivate),this.commentOpened=!1},events:{"click .delete-annotation":"deleteAnnotation","click .modify-annotation":"editNote","click .jump-annotation":"jumpAnnotation","click .favorite-annotation":"favoriteAnnotation","click .share-annotation":"shareAnnotation","click .comment-annotation":"toggleCommentAnnotation"},render:function(){var t=this.model.toJSON(),n=t.owner.user_id;return this.$el.html(_.template(this.tmpl,_.extend(t,{printTime:a,isNote:this.model.isNote(),isMine:this.model.isMine(),isFavorited:this.model.isFavorited(),isPrivate:this.model.isPrivate(),actions:this.model.getActionsList(),extra:this.info.get("extra"),isArticleAuthor:n===e.getModel("article").get("authorId"),autoLink:i}))),this.updateTagClass(),this.favoriteText=this.$(".favorite-annotation"),this.commentText=this.$(".comment-annotation"),this.privateTextWrapper=this.$(".private-info-wrapper"),this.shareWrapper=this.$(".share-wrapper"),this.updateFavorite(this.model),this.updateComment(this.model),this.updatePrivate(this.model),this},updateFavorite:function(t){if(this.favoriteText.length){var e=t.toJSON();e.isFavorited=t.isFavorited(),this.favoriteText.html(_.template(this.favoriteTextTmpl,e))}},updatePrivate:function(t){if(this.privateTextWrapper.length){var e=t.isPrivate();this.privateTextWrapper[e?"show":"hide"](),this.shareWrapper[e?"hide":"show"]()}},updateComment:function(t){this.commentText.length&&this.commentText.html(_.template(this.commentTextTmpl,t.toJSON()))},jumpAnnotation:function(t){t.preventDefault();var e=this.model.getStamp();this.config.trigger("goto:stamp",e)},favoriteAnnotation:function(t){t.preventDefault();var e=this.model,i=e.isFavorited();e.isFavoriting||e.editFavorite(!i)},shareAnnotation:function(t){t.preventDefault();var e=$(t.currentTarget),i=this.model;this.shareTip.set({target:e}).show();var o,s={works_id:i.articleId};i.isNote()?(o="/j/share/rec_annotation",_.extend(s,{annotation_id:i.get("id")})):(o="/j/share/rec_works_piece",_.extend(s,{annotation:JSON.stringify(i.toJSON())})),n(this.shareTip,r,{model:i,url:o,isNote:i.isNote(),extraParam:s,shareTypeLabel:"推荐"},{autoClose:!0})},toggleCommentAnnotation:function(t){t.preventDefault();var i=$(t.currentTarget);this.commentsView||(this.commentsView=new o({markingModel:this.model,commentTargetInfo:{article:{authorId:e.getModel("article").get("authorId")}}}),this.$(".bd").append(this.commentsView.render().$el.hide())),this.commentOpened=!this.commentOpened,this.commentsView.$el.toggle(this.commentOpened),i.toggleClass("opened",this.commentOpened)},destroy:function(){this.commentsView&&this.commentsView.remove(),this.annotations.remove(this.info),this.remove()},updateTagClass:function(){this.$el.removeClass(this.tagClass),this.tagClass=this.getTagClass(),this.$el.addClass(this.tagClass)},getTagClass:function(){return this.model.getShowTag()+"-annotation"}});return _.extend(l.prototype,s),l}.apply(e,n),!(void 0!==o&&(t.exports=o))},function(t,e,i){var n,o;n=[i(3),i(230)],o=function(_,t){return{htmlNoteArea:function(t){this.$(".note").html(_.escape(t))},deleteAnnotation:function(t){t.preventDefault();var e=this.model.isUnderline()?"划线":"批注",i=confirm("确定删除这条{{type}}吗？".replace("{{type}}",e));i&&this.model.destroy()},editNote:function(e){e.preventDefault();var i=this.model,n=i.get("note"),o=new t({text:n,visible_private:this.model.isPrivate()}),r=this.$(".note"),s=this;r.html(o.render().el),o.autoResize().focus(),this.$el.addClass("note-editing"),o.promise.done(function(t){i.set({note:t.get("text"),visible_private:t.get("visible_private")})}).always(function(){s.htmlNoteArea(i.get("note")),s.$el.removeClass("note-editing")})}}}.apply(e,n),!(void 0!==o&&(t.exports=o))},function(t,e,i){var n,o;n=[i(6),i(2),i(3),i(128),i(98)],o=function($,t,_,e,i){var n=t.View.extend({tagName:"form",className:"inline-form",tmpl:$("#tmpl-note-inline-form").html(),events:{"click .cancel":"cancel",submit:"editDone"},initialize:function(e){var i=t.Model.extend({defaults:{text:""}});this.model=new i(_.pick(e,"text","visible_private")),this.dfd=new $.Deferred,this.promise=this.dfd.promise(),this.promise.always(_.bind(function(){this.remove()},this))},render:function(){return this.$el.html(_.template(this.tmpl,this.model.pick("text","visible_private"))),this.textarea=this.$(".text"),i.ctrlEnterForm(this.$el),i.enableAutoResize(this.textarea,this.$el),this},autoResize:function(){return i.autoResize(this.textarea),this},focus:function(){return this.textarea.focus(),e.collapseToEnd(this.textarea[0]),this},parseText:function(t){return $.trim(t).replace(/\n/g," ")},editDone:function(t){t.preventDefault();var e=this.parseText(this.textarea.val());return e.length?(this.model.set({text:e,visible_private:this.$("input[name=visible_private]").is(":checked")?"on":""}),void this.dfd.resolve(this.model)):alert("批注不能为空")},cancel:function(t){t.preventDefault(),this.dfd.reject()}});return n}.apply(e,n),!(void 0!==o&&(t.exports=o))},function(t,e,i){var n,o;n=[i(6),i(3),i(2)],o=function($,_,t){var e={closePanel:function(){this.$el.trigger("close")}};return e}.apply(e,n),!(void 0!==o&&(t.exports=o))},function(t,e,i){var n,o;n=[i(6),i(3),i(2)],o=function($,_,t){function e(t){t=_.defaults(t||{},n),this.limit=t.limit,this.setItems(t.items)}function i(t){t=_.defaults(t||{},o),_.extend(this,t),this.paging=new e(_.pick(t,_.keys(n))),this.setItems(t.items),this.bindEvents()}var n={limit:10,items:[]};_.extend(e.prototype,{setItems:function(t){this.items=t,this.pages=[],this.curPageIndex=0,this.paging()},paging:function(){var t,e,i,n=Math.ceil(this.items.length/this.limit);for(t=0;t<n;t++)e=t*this.limit,i=(t+1)*this.limit,this.pages.push(this.items.slice(e,i))},getPage:function(t){return _.isUndefined(t)&&(t=this.curPageIndex),this.pages[t]},turnPage:function(t){return this.hasPage(t)?(this.curPageIndex=t,this.getPage(t)):this.getPage()},hasPage:function(t){return t>=0&&t<this.getPageCount()},getPageCount:function(){return this.pages.length}});var o={limit:10,items:[],navLimit:5,endPointLength:2,container:$(),navContainer:$(),prevSelector:".prev",nextSelecotr:".next",pageNumSelector:".page-num",prevTmpl:'<a class="prev" href="#">&lt; 前页</a>',nextTmpl:'<a class="next" href="#">后页 &gt;</a>',pageNumTmpl:'<a class="page-num" href="#"></a>'};return _.extend(i.prototype,{setItems:function(t){return this.items=t,this.pages=[],this.paging.setItems(t),this},getCurPageIndex:function(){return this.paging.curPageIndex},bindEvents:function(){_.bindAll(this,"clickTurnPage","clickPageNum"),this.navContainer.on("click",this.prevSelector,this.clickTurnPage).on("click",this.nextSelecotr,this.clickTurnPage).on("click",this.pageNumSelector,this.clickPageNum)},render:function(){this.turnPage(this.getCurPageIndex())},renderNav:function(){this.navContainer.empty(),1!==this.paging.getPageCount()&&(this.pageNums=$("<span>").addClass("page-nums"),this.prevBtn=$(this.prevTmpl),this.nextBtn=$(this.nextTmpl),this.navContainer.append(this.prevBtn).append(this.pageNums).append(this.nextBtn),this.renderPageNums(),this.changeBtnState())},renderPageNums:function(){var t,e,i,n=this.getCurPageIndex(),o=this.paging.getPageCount(),r=_.range(0,o,1);e=this.getLimitedRange(r,n,this.navLimit),e=_.first(r,this.endPointLength).concat(e).concat(_.last(r,this.endPointLength)),e=_.uniq(e),_.each(e,function(e,o,r){i=r[o-1],i&&e!==i+1&&this.pageNums.append(this.getEllipsis()),t=this.getPageNumElem(e),e===n&&t.addClass("active disabled"),this.pageNums.append(t)},this)},getLimitedRange:function(t,e,i){var n=e-Math.floor(i/2),o=n+i,r=t.length,s=n<0?-n:0,a=o>r?o-r:0;return o+=s-a,n+=s-a,n=n<0?0:n,o=o>r?r:o,t.slice(n,o)},getPageNumElem:function(t){return $(this.pageNumTmpl).data("index",t).text(t+1)},getEllipsis:function(){return $("<a>").addClass("ellipsis").text("…")},changeBtnState:function(){var t=this.getCurPageIndex();0===t&&this.prevBtn.addClass("disabled"),t>=this.paging.getPageCount()-1&&this.nextBtn.addClass("disabled")},toggleItems:function(t,e){_.each(t,function(t){$(t).toggle(e)})},clickTurnPage:function(t){t.preventDefault();var e,i=$(t.target);i.hasClass("disabled")||(e=i.hasClass("prev")?-1:1,this.turnPage(this.getCurPageIndex()+e))},clickPageNum:function(t){t.preventDefault();var e=$(t.target);e.hasClass("disabled")||this.turnPage(e.data("index"))},turnPage:function(t){this.trigger("turnPage",this.paging.turnPage(t)),this.renderNav()},remove:function(){this.pages=[],this.container.empty(),this.navContainer.empty()}}),_.extend(i.prototype,t.Events),i}.apply(e,n),!(void 0!==o&&(t.exports=o))},function(t,e,i){var n,o;n=[i(6),i(2),i(3),i(29),i(231),i(33)],o=function($,t,_,e,i,n){var o=t.View.extend({tmpl:$("#tmpl-toc").html(),events:{"click .toc-item":"tocJump","collapse:expanded":"onOpenPanel"},closePanel:function(){this.$el.trigger("close")},initialize:function(t){_.bindAll(this,"gotoTocPage","render"),this.app=t.app,this.vent=this.app.vent,this.controls=t.controls,this.turningModel=t.turningModel,this.vent.on("goto:tocPage",this.gotoTocPage),this.serverTocDfd=$.Deferred(),this.app.hasModel("content")?this.render():this.listenTo(this.app.vent,"model:content:set",this.render)},render:function(){var t=this.app.getModel("content").contents;return t.length?(this.$el.html(_.template(this.tmpl,{list:_.map(t,this.appendReadPageNum,this)})),this.tocItemEls=this.$("#contents-list li"),this.trigger("list:render"),this):(this.$el.empty(),this)},appendReadPageNum:function(t){return t=_.clone(t),t.readPageNum=this.turningModel.real2read(t.pageNum),t},gotoTocPage:function(t){t=t||0,this.$el.find(".toc-item").eq(t).trigger("click")},tocJump:function(t){var e=t.currentTarget;if($(e).closest("li").hasClass("need-buy"))this.turningModel.turnLastPage();else{var i=parseInt(e.id.split("-")[1],10);this.turningModel.setCurrPage(i)}this.controls.closePopups(),n._trackEvent("clickContentsItem")},onOpenPanel:function(){this.$(".is-current").removeClass("is-current");var t,i,n,o=this.turningModel.get("currPage"),r=this.app.getModel("content"),s=r.contents;o&&(t=r.getPage(o).tocItem,i=_.indexOf(s,t),n=this.tocItemEls.eq(i),n.addClass("is-current"),e.fitForMobile()||this.scrollToElem(n))},scrollToMarginTop:96,scrollToElem:function(t){this.scrollBody=this.scrollBody||this.$el.closest(".panels-container"),this.scrollBody.scrollTop(t.offset().top-this.scrollBody.offset().top-this.scrollToMarginTop)}});return _.extend(o.prototype,i),o}.apply(e,n),!(void 0!==o&&(t.exports=o))},function(t,e,i){var n,o;n=[i(6),i(2),i(3),i(22),i(231),i(67),i(32),i(82),i(153)],o=function($,t,_,e,i,n,o,r,s){function a(t,e){var i=t.getModel("chapters");e(i),i.on("reset",e),t.vent.on("model:chapters:set",function(t){i.off("reset",e),t.on("reset",e)})}var l=t.View.extend({tmpl:$("#tmpl-chapters-toc").html(),events:{"click .chapter-toc-item":"tocJump","collapse:expanded":"onExpand","click .show-gift":"showGift"},initialize:function(t){this.app=t.app,this.controls=t.controls,a(this.app,_.bind(function(t){this.chaptersCollection=t,this.columnModel=this.app.getModel("column")},this))},render:function(){var t=this,e=this.chaptersCollection,i=new n,a=e.currChapter.get("chapterId"),l=e.toJSON();return this.$el.html(_.template(this.tmpl,{list:l,lastItemIndex:l.length-1,columnId:e.columnId,currChapterId:a,truncate:r,sec2date:s.sec2date,purchaseButton:i,gift:this.columnModel.get("gift"),purchaseButtonData:function(t,e){var i=["/reader/column",t,"chapter",e.id].join("/");return _.extend(e,{id:e.id,url:i,is_large_btn:!1,is_hollow_btn:!0,redirect_url:i+"/list",is_mobile_direct_purchase:o.fitForMobile,columnId:t})}})),this.chaptersList=this.$el.find("#chapters-contents-list"),_.delay(function(){t.app.utils.applyPurchaseWithIn("[data-widget=faster-purchase]","#chapters-contents-list")},0),this.chaptersList.on("purchase:finish",function(t,e){location.href=e}),this},tocJump:function(){this.controls.closePopups()},scrollToMarginTop:96,scrollTo:function(t){this.scrollBody=this.scrollBody||this.$el.closest(".panels-container");var e=t.offset().top-this.scrollBody.offset().top-this.scrollToMarginTop;this.scrollBody.scrollTop(e)},scrollToCurrItem:function(){var t=this.$(".is-current");this.scrollTo(t)},onExpand:function(){o.fitForMobile||this.scrollToCurrItem()},showGift:function(){this.controls.closePopups(),this.app.vent.trigger("show:giftOverlay")}});return _.extend(l.prototype,i),l}.apply(e,n),!(void 0!==o&&(t.exports=o))},function(t,e,i){var n,o;(function($){"use strict";n=[i(3),i(32)],o=function(_,t){return{resizePanel:function(){this.resetHeight(this.panelsContainer)},resetPanelAsResize:function(){this.win.resize(_.debounce(this.resizePanel,80))},resetHeight:function(e){if(!t.fitForMobile){var i=$(".lite-header").outerHeight()||0;e.height((this.win.height()-i)/16+"em")}},dealingWithScrollbar:function(t){var e="expand"===t;this.body.css("overflow",e?"hidden":"")}}}.apply(e,n),!(void 0!==o&&(t.exports=o))}).call(e,i(6))},function(t,e,i){var n,o;n=[i(2),i(3),i(6),i(22),i(29)],o=function(t,_,$,e,i){return{closeShortcutTips:function(){this.toggleShortcutTips(!1)},openShortcutTips:function(){this.toggleShortcutTips(!0)},toggleShortcutTips:function(t){if(!i.hasTouch()){if(_.isUndefined(t)){var n=this.shortcutTips.is(":visible");t=!n}if(this.shortcutTips.toggle(t),!e.getModel("config").get("isGallery")){var o=e.readView.$el;o[t?"addClass":"removeClass"]("overlay-article")}}}}}.apply(e,n),!(void 0!==o&&(t.exports=o))},function(t,e,i){var n,o;n=[i(22),i(238)],o=function(t,e){function i(t){var e=t.title,i="";return t.isSample&&(i+="[试读]"),t.hasFormula&&(i+="[公式]"),e+i}function n(t,i,n){var o,r=n.startPublisher,s=n.startEvent,a=n.endPublisher||r,l=n.endEvent;r.once(s,function(){o=new e(t,i)}),a.once(l,function(){o&&o.end()})}var o={trackEvent:n,bindAll:function(e){t.vent.on("model:article:set",function(){o.trackPaging(t)}),e.article.on("article:init",function(){o.trackArticleFetching(t)})},trackPaging:function(t){var e=t.getModel("article");n("Paging",i(e.toJSON()),{startPublisher:t.vent,startEvent:"paging:start",endEvent:"paging:finish"})},trackArticleFetching:function(t){var n;t.vent.once("article:fetching:start",function(){n=new e("Article.fetch")}),t.vent.once("article:fetching:finish",function(t){n&&n._end()}),t.vent.once("model:article:set",function(t){n&&(n.set({label:i(t.toJSON())}),n.send())})}};return o}.apply(e,n),!(void 0!==o&&(t.exports=o))},function(t,e,i){var n,o;n=[i(3),i(33)],o=function(_,t){function e(t,e){this.set({name:t,label:e}),this.sampleRate=100,this._start()}var i=36e5;return _.extend(e.prototype,{nowTime:function(){return+new Date},set:function(t){_.extend(this,_.pick(t,"name","label"))},validateSpent:function(t){return t<i&&t>0},_start:function(){this.startTime=this.nowTime()},_end:function(){this.endTime=this.nowTime()},send:function(){var e=this.endTime-this.startTime;this.validateSpent(e)&&!this.sent&&(t._trackTiming(this.name,e,this.label,this.sampleRate),this.sent=!0)},end:function(){this._end(),this.send()}}),e}.apply(e,n),!(void 0!==o&&(t.exports=o))},function(t,e,i){var n,o;n=[i(6),i(2),i(3),i(21),i(240)],o=function($,t,_,e,i){var n=t.View.extend({tmpl:$("#tmpl-desktop-app-ad").html(),id:"desktop-app-ad",initialize:function(){this.freqLimit=new i.OncePerDayAndBrowser("shownDesktopAppAd")},events:{"click .close":"close"},render:function(){return this.$el.html(this.tmpl),this},appendTo:function(t){return e.me.isAnonymous&&this.freqLimit.isFree()?(t=t||$("body"),t.find("#"+this.id).remove(),t.append(this.render().el),this):this},close:function(t){t.preventDefault(),this.freqLimit.checkIn(),this.remove()}});return n}.apply(e,n),!(void 0!==o&&(t.exports=o))},function(t,e,i){var n,o;n=[i(3),i(26)],o=function(_,t){function e(t){this.key=t}function i(t){this.key=t}var n=new t(!0,"local"),o=864e5;return _.extend(e.prototype,{isFree:function(){return!n.get(this.key)},checkIn:function(){n.set(this.key,1)}}),_.extend(i.prototype,{isFree:function(){var t=+n.get(this.key)||0;return _.now()-t>o},checkIn:function(){var t=(new Date).setHours(0);n.set(this.key,t.valueOf())}}),{OncePerDayAndBrowser:i,OncePerBrowser:e}}.apply(e,n),!(void 0!==o&&(t.exports=o))},function(t,e,i){var n,o;n=[i(6),i(2),i(3),i(22),i(44),i(182),i(189)],o=function($,t,_,e,i,n,o){function r(t){var e,i=$("#tmpl-alert").html(),o={title:"无法查看批注",confirm:"知道了"};t.is_deleted?o.text="很遗憾，这条批注已经被批注者删掉了，所以无法查看。不如随手翻翻这本书吧。":t.visible_private&&(o.text="很遗憾，这条批注已经被批注者修改成“仅自己可见”，所以无法查看。不如随手翻翻这本书吧。"),e=new n({html:_.template(i,o)})}function s(){var t,e=$("#tmpl-alert").html(),i={title:"无法查看此章节",confirm:"知道了"};i.text="很抱歉，因为此章节内容不在免费试读的范围内，所以无法查看。不如随手翻翻这本书吧。",t=new n({html:_.template(e,i)})}function a(t,e){_.bindAll(this,"afterPagingDone","_onShareFetched"),this.getSharePromise=$.get("/j/share/"+e,{works_id:t})}function l(t){_.bindAll(this,"afterPagingDone"),this.stamp=new i({isRecommendation:!0}).setAnnotation(t)}function h(t,e){_.bindAll(this,"afterPagingDone","afterJumpingProgress","_onAnnotationFetched"),this.getAnnotationPromise=$.get("/j/article_v2/"+t+"/annotation",{id:e})}function c(t){_.bindAll(this,"afterPagingDone","afterJumpingProgress"),this.paraId=t,this.stamp=new i({pid:t,type:"para"})}function d(t){_.bindAll(this,"afterPagingDone"),this.index=t}_.extend(a.prototype,{afterPagingDone:function(t){return this.contentModel=t,this.getSharePromise.done(this._onShareFetched)},_onShareFetched:function(t){if(t&&!t.r){var e=t.props,n=new i({isRecommendation:!0}).setAnnotation(e);return n.annotationReadable()?void(this.contentModel.stamp=n):void r(n.getAnnotationJson())}}}),_.extend(l.prototype,{afterPagingDone:function(t){t.stamp=this.stamp}}),_.extend(h.prototype,{afterPagingDone:function(t){return this.contentModel=t,this.getAnnotationPromise.done(this._onAnnotationFetched)},_onAnnotationFetched:function(t){if(t&&!t.r){var e=t,n=new i({type:"annotation",isFromUrl:!0}).setAnnotation(e);return n.annotationReadable()?void(this.contentModel.stamp=n):void r(n.getAnnotationJson())}},afterJumpingProgress:function(){var t=this.contentModel.stamp;t&&t.annotationReadable()&&this._openSingleAnnotationOverlay(t.getAnnotationJson())},_openSingleAnnotationOverlay:function(t){if(t){var i=e.getModel("article").markings,n=i.get(t.id);e.vent.trigger("open:singleAnnotationOverlay",n)}}}),_.extend(c.prototype,{afterPagingDone:function(t){t.stamp=this.stamp},afterJumpingProgress:function(){var t=e.getModel("article").markings,i=this.paraId;t.fetchByPids([i]).done(function(){e.vent.trigger("open:paraAnnotationsOverlay",i)})}}),_.extend(d.prototype,{afterPagingDone:function(t){var e=t.contents[this.index];if(!e||!e.readable||!e.pageNum)return s();var n=new i(o(e.pageNum));t.stamp=n}});var u={Recommendation:a,Underline:l,Annotation:h,ParaAnnotations:c,TocChapter:d};return u}.apply(e,n),!(void 0!==o&&(t.exports=o))}]));
